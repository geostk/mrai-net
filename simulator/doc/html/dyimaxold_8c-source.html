<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: dyimaxold.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>dyimaxold.c</h1><a href="dyimaxold_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: dyimaxold.c,v 1.1 2005/09/09 08:22:24 bellet Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00005 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00006 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00007 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00008 <span class="comment">  "http://www.cecill.info". </span>
00009 <span class="comment">  </span>
00010 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00011 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00012 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00013 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00014 <span class="comment">  liability. </span>
00015 <span class="comment">  </span>
00016 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00017 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00018 <span class="comment">  software by the user in light of its specific status of free software,</span>
00019 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00020 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00021 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00022 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00023 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00024 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00025 <span class="comment">  same conditions as regards security. </span>
00026 <span class="comment">  </span>
00027 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00028 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00029 <span class="comment">  </span>
00030 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00031 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00032 <span class="comment">  </span>
00033 <span class="comment">  Version 1.0  05/09/2005</span>
00034 <span class="comment">*************************************************************************/</span>
00035 
00036 <span class="comment">/*************************************************************************</span>
00037 <span class="comment">*</span>
00038 <span class="comment">*  Description : Ancienne version, qui marchait partout sauf sous LINUX</span>
00039 <span class="comment">*     conservée pour afficher sur des ecrans 8 bits</span>
00040 <span class="comment">*     sans se compliquer la vie.</span>
00041 <span class="comment">*     - Des que j'ai (re)trouve et adapté un code qui affiche sur ecrans 8/16/24/32 bits</span>
00042 <span class="comment">*     je jette tout et je remplace JPRx -</span>
00043 <span class="comment">*     </span>
00044 <span class="comment">**************************************************************************/</span>
00045 
00046 <span class="preprocessor">#ifdef HAVE_X11</span>
00047 <span class="preprocessor"></span>
00048 <span class="preprocessor">#include &lt;string.h&gt;</span>  <span class="comment">// For memcpy</span>
00049 <span class="preprocessor">#include &lt;math.h&gt;</span>
00050 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00051 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00052 <span class="preprocessor">#include "<a class="code" href="iderr_8h.html">iderr.h</a>"</span>
00053 <span class="preprocessor">#include "<a class="code" href="idima_8h.html">idima.h</a>"</span>
00054 <span class="preprocessor">#include "<a class="code" href="idprint_8h.html">idprint.h</a>"</span>
00055 
00056 <span class="preprocessor">#include &lt;X11/Xlib.h&gt;</span>
00057 <span class="preprocessor">#include &lt;X11/Xutil.h&gt;</span>
00058 <span class="preprocessor">#include &lt;X11/Xos.h&gt;</span>
00059 <span class="preprocessor">#include &lt;X11/Xatom.h&gt;</span>
00060 
00061 <span class="preprocessor">#define RGB24BITS_SW 4</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#define RGB24BITS_NW 5</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#define COLORS256_SW 2</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#define COLORS256_NW 3</span>
00065 <span class="preprocessor"></span>
00066 <span class="keyword">static</span> <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> eclate_24_8 (<a class="code" href="structRGB.html">PPIMAGE_RGB</a>);
00067 
00068 <span class="keyword">static</span> Display *disp;
00069 <span class="keyword">static</span> Visual *vis;
00070 <span class="keyword">static</span> <span class="keywordtype">int</span> screen_num;
00071 <span class="keyword">static</span> Window win;
00072 
00073 <span class="keyword">static</span> XImage *xim=NULL;
00074 <span class="keyword">static</span> GC gc;
00075 <span class="keyword">static</span> XGCValues <a class="code" href="jpeglib_8h.html#a64">val</a>;
00076 <span class="keyword">static</span> XColor xcol;
00077 <span class="keyword">static</span> XEvent rep;
00078 <span class="keyword">static</span> Colormap cm;
00079 <span class="keyword">static</span> <span class="keywordtype">int</span> lut[256];
00080 <span class="keyword">static</span> <span class="keywordtype">char</span> **imm;
00081 <span class="keyword">static</span> <span class="keywordtype">char</span> * imm1;
00082 <span class="keyword">static</span> <span class="keywordtype">int</span> fdp[2];
00083 <span class="keyword">static</span> <span class="keywordtype">int</span> fork_done=0;
00084 
00085 <span class="keyword">static</span> XVisualInfo vTemplate;
00086 <span class="keyword">static</span> XVisualInfo *visualList;
00087 <span class="keyword">static</span> <span class="keywordtype">int</span> visualsMatched;
00088 <span class="keyword">static</span> XSetWindowAttributes attributs;
00089 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> valuemask=0 <span class="comment">/*,pixels[2048] */</span>;
00090 <span class="keyword">static</span> <span class="keywordtype">int</span> num_visual;
00091 <span class="keyword">static</span> <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> imUCHAR;
00092 <span class="keyword">static</span> <a class="code" href="structRGB.html">PPIMAGE_RGB</a> imRGB;
00093 
00094 <span class="comment">/*void _IdImaDisplayColorOld(PPIMAGE_UCHAR , // pour eviter les warnings</span>
00095 <span class="comment">                    int , </span>
00096 <span class="comment">         int , int , int , int ,</span>
00097 <span class="comment">         int , int , PSIGNAL_RGB);</span>
00098 <span class="comment">*/</span>
00099 <span class="keywordtype">void</span> <a class="code" href="idima-restricted_8h.html#a3">_IdImaDisplayColorOld</a>(PPIMAGE_UCHAR im,
00100                         <span class="keywordtype">int</span> display, <span class="comment">// Displays in same window when even</span>
00101                       <span class="comment">// and in newly created window when odd</span>
00102          <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> nx, <span class="keywordtype">int</span> ny,
00103          <span class="keywordtype">int</span> ox, <span class="keywordtype">int</span> oy, <a class="code" href="structRGB.html">PSIGNAL_RGB</a> pal)
00104 {
00105    <span class="keywordtype">int</span> i,j,k,kkk=0;
00106    <span class="keywordtype">int</span> lig,v;
00107    <span class="keywordtype">int</span> FlagSameWindow=0;
00108    <span class="keywordtype">int</span> default24;
00109    <span class="keywordtype">int</span> incr; <span class="comment">/* increment indice palette */</span>
00110    
00111    <span class="keywordflow">if</span> (!im) {
00112    <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"Pointeur image NULL !!\n"</span>); 
00113    <span class="keywordflow">return</span>;
00114    }
00115    
00116    FlagSameWindow=display&amp;0x0001; 
00117    
00118    <span class="keywordflow">if</span>(!FlagSameWindow) {  <span class="comment">/* si PAIR meme fenetre */</span>
00119    
00120       <span class="keywordflow">if</span>(!fork_done) {
00121          pipe(fdp);
00122          fork_done=1;
00123          fcntl(fdp[0],F_SETFL,O_NDELAY);
00124    
00125          <span class="keywordflow">if</span>(fork())<span class="keywordflow">return</span>;
00126 
00127       } <span class="keywordflow">else</span> {
00128          <span class="keywordflow">switch</span>(<a class="code" href="imabasic_8c.html#a7">IdImaType</a>(im))   { 
00129             <span class="keywordflow">case</span> <a class="code" href="idima-ido_8h.html#a1">IMA_UCHAR</a>: 
00130                <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im);i++)
00131                   write(fdp[1],im[i],<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im));
00132                <span class="keywordflow">return</span>;
00133    
00134             <span class="keywordflow">case</span> <a class="code" href="idima-ido_8h.html#a9">IMA_RGB</a>:      
00135                <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im);i++) 
00136                   write(fdp[1],im[i],<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im)*3);
00137                <span class="keywordflow">return</span>; 
00138          } 
00139       }
00140 
00141    } <span class="keywordflow">else</span> {  <span class="comment">/* si IMPAIR nouvelle fenetre */</span>
00142 
00143    <span class="keywordflow">if</span> (fork()) 
00144       <span class="keywordflow">return</span>; 
00145   }
00146    
00147    <span class="keywordflow">if</span>(!(disp=XOpenDisplay(0))) {
00148       <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"Pb de display (XOpenDisplay)\n"</span>);
00149    <span class="keywordflow">return</span>;
00150    }
00151    screen_num=DefaultScreen(disp);
00152    
00153    
00154    <span class="keywordflow">switch</span>(<a class="code" href="imabasic_8c.html#a7">IdImaType</a>(im))
00155    {
00156    <span class="keywordflow">case</span> <a class="code" href="idima-ido_8h.html#a1">IMA_UCHAR</a>:
00157    
00158    <span class="comment">/**************************************************************************/</span>
00159    <span class="comment">/* Affichage en 128 niveaux de gris ou en 128 couleurs garanties avec     */</span>
00160    <span class="comment">/* une palette passee en parametre                                        */</span>
00161    <span class="comment">/**************************************************************************/</span>
00162    
00163     default24=0;
00164    
00165     vis=DefaultVisual(disp,screen_num);
00166    
00167     vTemplate.screen=screen_num;
00168     vTemplate.depth=24;
00169     visualList=XGetVisualInfo(disp,VisualScreenMask | VisualDepthMask,     
00170                &amp;vTemplate,&amp;visualsMatched);
00171     <span class="keywordflow">for</span>(i=0;i&lt; visualsMatched;i++) {
00172          <span class="keywordflow">if</span>(visualList[num_visual].visual == vis ) { 
00173       default24=1;
00174          <span class="keywordflow">if</span>(display ==0) display=4;
00175          <span class="keywordflow">if</span>(display ==1) display=5;
00176          <span class="keywordflow">break</span>;
00177    }
00178                
00179    }
00180    
00181    <span class="keywordflow">if</span>(display ==0 || display ==1 ) {
00182    
00183       imUCHAR=(<a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a>)im;
00184       vis=DefaultVisual(disp,screen_num);
00185    
00186       win=XCreateSimpleWindow(disp,RootWindow(disp,screen_num),
00187          0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im),50<span class="comment">/*4*/</span>,WhitePixel(disp,screen_num),
00188          BlackPixel(disp,screen_num));
00189       XClearWindow(disp,win);
00190       XStoreName(disp,win,<a class="code" href="kernomfic_8c.html#a0">IdGetFileName</a>(im));
00191    
00192       xcol.flags=DoRed | DoGreen | DoBlue;
00193       <span class="keywordflow">if</span> (!pal) {
00194             <span class="keywordflow">for</span>(i=0;i&lt;256;i+=2) {   <span class="comment">/*  pas de palette -&gt; 128 niveaux de gris */</span>
00195 
00196             xcol.red  =i&lt;&lt;8;
00197             xcol.green=i&lt;&lt;8;
00198             xcol.blue =i&lt;&lt;8;
00199             XAllocColor(disp,DefaultColormap(disp,screen_num),&amp;xcol);
00200 
00201             <span class="keywordflow">if</span> (xcol.pixel&lt;=255) {
00202                   lut[i]  =xcol.pixel;
00203                   lut[i+1]=xcol.pixel;
00204             }
00205       }
00206 
00207     } <span class="keywordflow">else</span> {      <span class="comment">/* on traite la palette */</span>
00208 
00209    <span class="keywordflow">if</span> (<a class="code" href="idsig-ido_8h.html#a20">IdSigDimX</a>(pal)&gt;128) <span class="comment">// pour toute palette &gt;128, on prend une</span>
00210                                 <span class="comment">// couleur sur 2 ...</span>
00211          incr=2;
00212       <span class="keywordflow">else</span>
00213          incr=1;
00214    
00215          <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="idsig-ido_8h.html#a20">IdSigDimX</a>(pal);i+=incr) {
00216          xcol.red  =pal[i].<a class="code" href="structRGB.html#o0">r</a>&lt;&lt;8;
00217          xcol.green=pal[i].<a class="code" href="structRGB.html#o1">g</a>&lt;&lt;8;
00218          xcol.blue =pal[i].<a class="code" href="structRGB.html#o2">b</a>&lt;&lt;8;
00219          XAllocColor(disp,DefaultColormap(disp,screen_num),&amp;xcol);
00220 
00221          <span class="keywordflow">if</span>( xcol.pixel&lt;=255) {
00222             lut[i]=xcol.pixel;
00223             lut[i+1]=xcol.pixel;
00224          }
00225    }
00226     }
00227 
00228     imm=   (<span class="keywordtype">char</span> **)malloc(<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
00229     imm[0]=(<span class="keywordtype">char</span> *) malloc(<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im)*<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im)*<a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(im));
00230 
00231     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im);i++)
00232       imm[i]=(<span class="keywordtype">char</span> *)imm[0] + i * <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im) * <a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(im);
00233    
00234     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im);i++)<span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im);j++) {
00235       imm[i][j]=lut[imUCHAR[i][j]&amp;0xff];
00236     }
00237    
00238    <span class="keywordflow">if</span> (default24)
00239       xim=XCreateImage(disp,vis,24,ZPixmap,0,imm[0],
00240          <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im),8,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im));
00241    <span class="keywordflow">else</span>
00242       xim=XCreateImage(disp,vis,8,ZPixmap,0,imm[0],
00243          <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im),8,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im));
00244    
00245     }
00246    
00247    <span class="comment">/**************************************************************************/</span>
00248    <span class="comment">/* Affichage en 256 niveaux de gris ou en 256 couleurs non garanties avec */</span>
00249    <span class="comment">/* une palette passee en parametre                                        */</span>
00250    <span class="comment">/**************************************************************************/</span>
00251    
00252    <span class="keywordflow">if</span>(display ==2 || display ==3 )  <span class="comment">/* cette partie n'a pas d'interet (pas pratique) */</span>
00253                 <span class="comment">/* laissee ici pour compatibilite avec des versions anterieures */</span>
00254    {
00255    
00256     imUCHAR=(<a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a>)im;
00257     vis=DefaultVisual(disp,screen_num);
00258     win=XCreateSimpleWindow(disp,RootWindow(disp,screen_num),
00259       0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im),50<span class="comment">/*4*/</span>,WhitePixel(disp,screen_num),
00260       BlackPixel(disp,screen_num));
00261     XClearWindow(disp,win);
00262     XStoreName(disp,win,<a class="code" href="kernomfic_8c.html#a0">IdGetFileName</a>(im));
00263    
00264     xcol.flags=DoRed | DoGreen | DoBlue;
00265     <span class="keywordflow">if</span> (!pal)
00266     {
00267       <span class="keywordflow">for</span>(i=0;i&lt;256;i+=1) {  <span class="comment">// on n'a pas passe de palette -&gt; 256 niveaux</span>
00268                              <span class="comment">// de gris</span>
00269       xcol.red  =i&lt;&lt;8;
00270       xcol.green=i&lt;&lt;8;
00271       xcol.blue =i&lt;&lt;8;
00272       XAllocColor(disp,DefaultColormap(disp,screen_num),&amp;xcol);
00273       <span class="keywordflow">if</span>( xcol.pixel&lt;=255) {
00274          lut[i]  =xcol.pixel;
00275       }
00276       }
00277     } <span class="keywordflow">else</span> {      <span class="comment">// on traite la palette</span>
00278       <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="idsig-ido_8h.html#a20">IdSigDimX</a>(pal);i+=1)
00279       {
00280       xcol.red  =pal[i].<a class="code" href="structRGB.html#o0">r</a>&lt;&lt;8;
00281       xcol.green=pal[i].<a class="code" href="structRGB.html#o1">g</a>&lt;&lt;8;
00282       xcol.blue =pal[i].<a class="code" href="structRGB.html#o2">b</a>&lt;&lt;8;
00283       XAllocColor(disp,DefaultColormap(disp,screen_num),&amp;xcol);
00284       <span class="keywordflow">if</span>( xcol.pixel&lt;=255 )
00285          {
00286          lut[i]=xcol.pixel;
00287          }
00288       }
00289     }
00290     imm=   (<span class="keywordtype">char</span> **)malloc(<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
00291     imm[0]=(<span class="keywordtype">char</span> *) malloc(<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im)*<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im)*<a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(im));
00292     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im);i++)
00293       imm[i]=(<span class="keywordtype">char</span> *)imm[0] + i * <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im) * <a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(im);
00294    
00295     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im);i++)<span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im);j++)
00296       {
00297       imm[i][j]=lut[imUCHAR[i][j]&amp;0xff];
00298       }
00299    
00300     xim=XCreateImage(disp,vis,8,ZPixmap,0,imm[0],
00301       <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im),8,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im));
00302    
00303     }
00304    
00305    <span class="comment">/**************************************************************************/</span>
00306    <span class="comment">/* Affichage en 256 niveaux de gris garantis avec colormap reservee       */</span>
00307    <span class="comment">/* ou Affichage en 256 couleurs garantis en allouant une colormap conforme*/</span>
00308    <span class="comment">/* a la palette passee en parametre                                       */</span>
00309    <span class="comment">/**************************************************************************/</span>
00310    
00311    <span class="keywordflow">if</span>( display == 4 || display == 5 )
00312    {
00313        vTemplate.screen=screen_num;
00314        vTemplate.depth=8;
00315        visualList=XGetVisualInfo(disp,
00316                         VisualScreenMask    | 
00317             VisualDepthMask     | 
00318             VisualRedMaskMask   | 
00319             VisualGreenMaskMask | 
00320             VisualRedMaskMask,  
00321             &amp;vTemplate,&amp;visualsMatched);
00322    
00323        <span class="comment">/* Recherche d'un visual type PSEUDO-COLOR */</span>
00324        num_visual=0; 
00325        <span class="keywordflow">while</span> ( visualList[num_visual].class != PseudoColor ){
00326            num_visual++;
00327            <span class="keywordflow">if</span>( num_visual &gt;= visualsMatched ) {  
00328              <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"Erreur impossible d'afficher en pseudocolor"</span>);
00329              <a class="code" href="iderr_8h.html#a66">IdExit</a>(1);}}
00330    
00331         imUCHAR=(<a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a>)im;
00332    
00333        cm = XCreateColormap(disp,RootWindow(disp,screen_num),
00334                 visualList[num_visual].visual,AllocAll);
00335        <span class="keywordflow">if</span>(!cm)<a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"Erreur creation colormap \n"</span>);
00336        attributs.colormap = cm;
00337        attributs.event_mask= ButtonPressMask | KeyPressMask | ExposureMask;
00338        attributs.background_pixel=BlackPixel(disp,screen_num);
00339        attributs.border_pixel=WhitePixel(disp,screen_num);
00340        vis=visualList[num_visual].visual;
00341        valuemask |= CWColormap;
00342        valuemask |= CWEventMask;
00343        valuemask |= CWBackPixel;
00344        valuemask |= CWBorderPixel;
00345        win=XCreateWindow(disp,RootWindow(disp,screen_num),
00346           0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imUCHAR),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imUCHAR),50,vTemplate.depth,
00347           InputOutput,vis,valuemask,&amp;attributs);
00348        <span class="keywordflow">if</span>(!win) <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"Erreur creation fenetre \n"</span>);
00349        XSetWindowColormap(disp,win,cm);
00350        XClearWindow(disp,win);
00351        XStoreName(disp,win,<a class="code" href="kernomfic_8c.html#a0">IdGetFileName</a>(imUCHAR));
00352     
00353        xcol.flags=DoRed | DoGreen | DoBlue;
00354        <span class="keywordflow">if</span> (!pal) {
00355          <span class="keywordflow">for</span>(i=0;i&lt;256;i+=1) {   <span class="comment">// on n'a pas passe de palette -&gt; niveaux</span>
00356                               <span class="comment">// de gris</span>
00357             xcol.pixel=i;
00358             xcol.red  =i&lt;&lt;8;
00359             xcol.green=i&lt;&lt;8;
00360             xcol.blue =i&lt;&lt;8;
00361                XStoreColor(disp,cm,&amp;xcol);
00362          }
00363        } <span class="keywordflow">else</span> {      <span class="comment">/* on traite la palette */</span>
00364 
00365          <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="idsig-ido_8h.html#a20">IdSigDimX</a>(pal);i+=1) {
00366                 xcol.pixel=i;
00367             xcol.red  =pal[i].<a class="code" href="structRGB.html#o0">r</a>&lt;&lt;8;
00368             xcol.green=pal[i].<a class="code" href="structRGB.html#o1">g</a>&lt;&lt;8;
00369             xcol.blue =pal[i].<a class="code" href="structRGB.html#o2">b</a>&lt;&lt;8;
00370             XStoreColor(disp,cm,&amp;xcol);
00371       }  
00372    
00373        }
00374 
00375     imm1=(<span class="keywordtype">char</span> *)malloc(<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imUCHAR)*<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imUCHAR)*<a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(imUCHAR));
00376    
00377     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imUCHAR);i++)      
00378        memcpy(imm1+(i*<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imUCHAR)), imUCHAR[i], <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imUCHAR));
00379     
00380     
00381     xim=XCreateImage(disp,vis,8,ZPixmap,0, imm1,
00382       <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imUCHAR),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imUCHAR),8,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imUCHAR));
00383     }
00384    <span class="keywordflow">break</span>;
00385    
00386    
00387    <span class="keywordflow">case</span> <a class="code" href="idima-ido_8h.html#a9">IMA_RGB</a>: 
00388    
00389    <span class="comment">/**************************************************************************/</span>
00390    <span class="comment">/* Affichage en d'une image RGB sur ecran 24 bits en TRUE-COLOR           */</span>
00391    <span class="comment">/**************************************************************************/</span>
00392    
00393      vTemplate.depth=24;
00394      visualList=XGetVisualInfo(disp,VisualScreenMask | VisualDepthMask,     
00395          &amp;vTemplate,&amp;visualsMatched);
00396    
00397       <span class="keywordflow">if</span>( visualsMatched == 0 )  {
00398             im=eclate_24_8((<a class="code" href="structRGB.html">PPIMAGE_RGB</a>)im);
00399          <span class="keywordflow">break</span>;
00400       } <span class="keywordflow">else</span> {
00401             <span class="keywordflow">while</span>(visualList[num_visual].class != TrueColor ) {
00402             num_visual++;
00403 
00404             <span class="keywordflow">if</span> ( num_visual &gt;= visualsMatched) {
00405                   <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"Votre serveur ne permet pas d'afficher en TRUE_COLOR"</span>);
00406                   <a class="code" href="iderr_8h.html#a66">IdExit</a>(1);
00407          }
00408       }
00409         }
00410 
00411      imRGB=(<a class="code" href="structRGB.html">PPIMAGE_RGB</a>)im;
00412    
00413      cm = XCreateColormap(disp,RootWindow(disp,screen_num),
00414                 visualList[num_visual].visual,AllocNone);
00415      attributs.colormap = cm;
00416      attributs.event_mask= ButtonPressMask | KeyPressMask | ExposureMask;
00417      attributs.background_pixel=BlackPixel(disp,screen_num);
00418      attributs.border_pixel=WhitePixel(disp,screen_num);
00419      vis=visualList[num_visual].visual;
00420      valuemask |= CWColormap;
00421      valuemask |= CWEventMask;
00422      valuemask |= CWBackPixel;
00423      valuemask |= CWBorderPixel;
00424      win=XCreateWindow(disp,RootWindow(disp,screen_num),
00425           0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imRGB),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imRGB),50,vTemplate.depth,
00426           InputOutput,visualList[num_visual].visual,valuemask,&amp;attributs);
00427      <span class="keywordflow">if</span>(!win) <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"Erreur creation fenetre \n"</span>);
00428      XSetWindowColormap(disp,win,cm);
00429      XClearWindow(disp,win);
00430      XStoreName(disp,win,<a class="code" href="kernomfic_8c.html#a0">IdGetFileName</a>(imRGB));
00431      imm1=(<span class="keywordtype">char</span> *)malloc(<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imRGB)*<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imRGB)*4);
00432    
00433      <span class="keywordflow">for</span>(i=0,k=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imRGB);i++)
00434       <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imRGB);j++,k+=4) {
00435             imm1[k]  =0; 
00436             imm1[k+1]=imRGB[i][j].<a class="code" href="structRGB.html#o2">b</a>;
00437             imm1[k+2]=imRGB[i][j].g;
00438             imm1[k+3]=imRGB[i][j].r;
00439          }
00440      xim=XCreateImage(disp,vis,24,ZPixmap,0,(<span class="keywordtype">char</span> *)imm1,
00441       <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imRGB),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imRGB),16,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imRGB)*4);
00442      <span class="keywordflow">if</span>(!xim)
00443       <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"erreur creation image\n"</span>);
00444           
00445     <span class="keywordflow">break</span>;
00446    
00447    <span class="keywordflow">default</span>:
00448    
00449       <a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"type d'image (%d) non autorise a l'affichage\n"</span>,
00450       <a class="code" href="imabasic_8c.html#a7">IdImaType</a>(im));
00451       <a class="code" href="iderr_8h.html#a66">IdExit</a>(1);
00452 
00453       <span class="keywordflow">break</span>;
00454    }
00455     
00456    <span class="comment">/*************************************************************************/</span>
00457    <span class="comment">/* Partie commune affichage des images xim                               */</span>
00458    <span class="comment">/*************************************************************************/</span>
00459    
00460    gc=XCreateGC(disp,win,(GCForeground|GCBackground),&amp;val);
00461    
00462    XMapWindow(disp,win);
00463    XSelectInput(disp,win,ButtonPressMask | KeyPressMask | ExposureMask);
00464    XPutImage(disp,win,gc,xim,0,0,0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im));
00465    lig=0;
00466    <span class="keywordflow">while</span>(1)
00467       {
00468       <span class="keywordflow">if</span>( XEventsQueued(disp,QueuedAfterFlush) || display)
00469          {
00470          XNextEvent(disp,&amp;rep);
00471          <span class="keywordflow">switch</span>(rep.type)
00472             {
00473             <span class="keywordflow">case</span> ButtonPress:
00474                                    <span class="keywordflow">if</span>( rep.xbutton.button == 1)
00475                                    {
00476                XPutImage(disp,win,gc,xim,0,0,0,
00477                   0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im));
00478                XFreeGC(disp,gc);
00479                XCloseDisplay(disp);
00480                <a class="code" href="iderr_8h.html#a66">IdExit</a>(0); }   
00481                               <span class="keywordflow">break</span>;
00482 
00483                         <span class="keywordflow">case</span> Expose:
00484                XPutImage(disp,win,gc,xim,0,0,
00485                   0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im));
00486                <span class="keywordflow">break</span>;
00487 
00488             <span class="keywordflow">case</span> KeyPress:
00489                XPutImage(disp,win,gc,xim,0,0,
00490                   0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im));
00491                <span class="keywordflow">break</span>;
00492             }
00493          }
00494       <span class="keywordflow">else</span>
00495          {
00496          <span class="keywordflow">switch</span> (<a class="code" href="imabasic_8c.html#a7">IdImaType</a>(im))
00497          {
00498          <span class="keywordflow">case</span> <a class="code" href="idima-ido_8h.html#a1">IMA_UCHAR</a>:
00499             <span class="comment">/*---------------*/</span>
00500           <span class="keywordflow">if</span>( (v=read(fdp[0],im[lig],<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im))) != -1)
00501             {
00502             <span class="keywordflow">if</span>(v)
00503                {
00504                <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im);j++)
00505                   {
00506                   imm[lig][j]=lut[im[lig][j]&amp;0xff];
00507                   }
00508                lig++;
00509                }
00510             <span class="keywordflow">if</span>(lig==<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im))
00511                {
00512                lig=0;
00513                XPutImage(disp,win,gc,xim,0,0,0,0,
00514                   <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im));
00515                }
00516             } <span class="comment">/* fin if v=read(fdp... */</span>
00517          
00518          <span class="keywordflow">break</span>;
00519    
00520          <span class="keywordflow">case</span> <a class="code" href="idima-ido_8h.html#a9">IMA_RGB</a>:
00521             <span class="comment">/*-------------*/</span>
00522    
00523           <span class="keywordflow">if</span>( (v=read(fdp[0],im[lig],<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im)*3)) != -1)
00524             {
00525             <span class="keywordflow">if</span>(v)
00526                {
00527                <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im);j++,kkk+=4)
00528                   {
00529    
00530                      imm1[kkk]  =0; 
00531                      imm1[kkk+1]=imRGB[lig][j].<a class="code" href="structRGB.html#o2">b</a>;
00532                      imm1[kkk+2]=imRGB[lig][j].g;
00533                      imm1[kkk+3]=imRGB[lig][j].r;
00534                   }
00535                lig++;
00536                }
00537             <span class="keywordflow">if</span>(lig==<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im))
00538                {
00539                lig=0;
00540                kkk=0;
00541    
00542                XPutImage(disp,win,gc,xim,0,0,0,0,
00543                   <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(im),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(im));
00544                }
00545             } <span class="comment">/* fin if v=read(fdp... */</span>
00546    
00547          <span class="keywordflow">break</span>;
00548    
00549          } <span class="comment">/* fin Switch   */</span>
00550    
00551          }
00552       }
00553 }
00554 
00555 <span class="comment">/* --------------------------------------------------------------------------*/</span>
00556 
00557 <span class="keyword">static</span> <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> eclate_24_8(<a class="code" href="structRGB.html">PPIMAGE_RGB</a> imInput)
00558 {
00559    <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> imDest;
00560    <span class="keywordtype">int</span> i,j;
00561    
00562    imDest=(<a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a>)<a class="code" href="imaallo_8c.html#a9">IdImaAlloc</a>(<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imInput)*3,<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imInput),IMA_UCHAR);
00563    <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imInput);i++)<span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imInput);j++)
00564       {
00565       imDest[i][j]=           imInput[i][j].<a class="code" href="structRGB.html#o0">r</a>;
00566       imDest[i][j+<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imInput)]= imInput[i][j].g;
00567       imDest[i][j+2*<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imInput)]=  imInput[i][j].b;
00568       }
00569    
00570    <span class="comment">/* Ecrire des fonctions ... */</span>
00571    
00572     vis=DefaultVisual(disp,screen_num);
00573     win=XCreateSimpleWindow(disp,RootWindow(disp,screen_num),
00574       0,0,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imDest),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imDest),50,WhitePixel(disp,screen_num),
00575       BlackPixel(disp,screen_num));
00576     XClearWindow(disp,win);
00577     XStoreName(disp,win,<a class="code" href="kernomfic_8c.html#a0">IdGetFileName</a>(imDest));
00578    
00579     xcol.flags=DoRed | DoGreen | DoBlue;
00580    
00581       <span class="keywordflow">for</span>(i=0;i&lt;256;i+=2)    <span class="comment">// on n'a pas passe de palette -&gt; 128 niveaux</span>
00582                              <span class="comment">// de gris</span>
00583       {
00584       xcol.red  =i&lt;&lt;8;
00585       xcol.green=i&lt;&lt;8;
00586       xcol.blue =i&lt;&lt;8;
00587       XAllocColor(disp,DefaultColormap(disp,screen_num),&amp;xcol);
00588       <span class="keywordflow">if</span>( xcol.pixel&lt;=255 )
00589          {
00590          lut[i]  =xcol.pixel;
00591          lut[i+1]=xcol.pixel;
00592          }
00593       }
00594    
00595     imm=(<span class="keywordtype">char</span> **)malloc(<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imDest)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
00596     imm[0]=(<span class="keywordtype">char</span> *)malloc(<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imDest)*<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imDest)*
00597                             <a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(imDest));
00598     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imDest);i++)
00599       imm[i]=(<span class="keywordtype">char</span> *)imm[0] + i * <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imDest) * <a class="code" href="idgen_8h.html#a86">IdSizeOfType</a>(imDest);
00600    
00601     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imDest);i++)<span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imDest);j++)
00602       {
00603       imm[i][j]=lut[imDest[i][j]&amp;0xff];
00604       }
00605    
00606     xim=XCreateImage(disp,vis,8,ZPixmap,0,imm[0],
00607       <a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imDest),<a class="code" href="imabasic_8c.html#a4">IdImaDimY</a>(imDest),8,<a class="code" href="imabasic_8c.html#a5">IdImaDimX</a>(imDest));
00608    
00609    <span class="keywordflow">return</span> imDest;
00610 }
00611 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:13 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
