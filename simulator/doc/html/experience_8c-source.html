<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: experience.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>experience.c</h1><a href="experience_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: experience.c,v 1.59 2006/12/18 15:10:37 yougz Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00005 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00006 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00007 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00008 <span class="comment">  "http://www.cecill.info". </span>
00009 <span class="comment">  </span>
00010 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00011 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00012 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00013 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00014 <span class="comment">  liability. </span>
00015 <span class="comment">  </span>
00016 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00017 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00018 <span class="comment">  software by the user in light of its specific status of free software,</span>
00019 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00020 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00021 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00022 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00023 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00024 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00025 <span class="comment">  same conditions as regards security. </span>
00026 <span class="comment">  </span>
00027 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00028 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00029 <span class="comment">  </span>
00030 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00031 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00032 <span class="comment">  </span>
00033 <span class="comment">  Version 2.0  20/12/2006</span>
00034 <span class="comment">*************************************************************************/</span>
00035 
00036 <span class="preprocessor">#include "<a class="code" href="experience_8h.html">experience.h</a>"</span>
00037 <span class="preprocessor">#ifdef HAVE_MPI</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;mpi.h&gt;</span>
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="group__Experience.html#ga4">00047</a> <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * <a class="code" href="group__Experience.html#ga0">AllocExperience</a>()
00048 {
00049    <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * expr;
00050 
00051 
00052    <span class="keywordflow">if</span> ((expr = (<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>))) == NULL)
00053    {
00054    fprintf(stderr, <span class="stringliteral">"Experience alloc error \n"</span>);
00055    exit(1);
00056     }
00057 
00058    <span class="comment">/* Default setting of the experience structure */</span>
00059    expr-&gt;<a class="code" href="struct__Experience3D.html#o0">name</a>[0]=<span class="charliteral">'\0'</span>;
00060    expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>=0; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>=0; expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>=0;
00061    expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>=0;  expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a>=0;  expr-&gt;<a class="code" href="struct__Experience3D.html#o13">fovz</a>=0;
00062    expr-&gt;<a class="code" href="struct__Experience3D.html#o14">obx</a>=0;   expr-&gt;<a class="code" href="struct__Experience3D.html#o15">oby</a>=0;   expr-&gt;<a class="code" href="struct__Experience3D.html#o16">obz</a>=0;
00063 
00064    expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>=NULL;
00065    expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>=NULL;
00066    expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>=NULL;
00067    expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>=NULL;
00068    expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>=NULL;
00069 
00070    expr-&gt;<a class="code" href="struct__Experience3D.html#o24">xf</a>=0.0; expr-&gt;<a class="code" href="struct__Experience3D.html#o25">yf</a>=0.0; expr-&gt;<a class="code" href="struct__Experience3D.html#o26">zf</a>=0.0;
00071    expr-&gt;<a class="code" href="struct__Experience3D.html#o27">px</a>=0.0; expr-&gt;<a class="code" href="struct__Experience3D.html#o28">py</a>=0.0; expr-&gt;<a class="code" href="struct__Experience3D.html#o29">pz</a>=0.0; expr-&gt;<a class="code" href="struct__Experience3D.html#o30">pt</a>=0.0;
00072 
00073    expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>=NULL;
00074    expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>=NULL;
00075    expr-&gt;<a class="code" href="struct__Experience3D.html#o38">G_edw</a>=0.0;
00076    
00077    expr-&gt;<a class="code" href="struct__Experience3D.html#o20">to</a>=0.0;
00078 
00079    expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a>=1.0;  <span class="comment">/* Default value set to 1 tesla */</span>
00080    expr-&gt;<a class="code" href="struct__Experience3D.html#o37">b0def</a>=0.0;<span class="comment">/* Default value set to 0 */</span>
00081 
00082    expr-&gt;<a class="code" href="struct__Experience3D.html#o39">FLAG_RESONANCE</a> = <a class="code" href="experience_8h.html#a1">ON</a> ; <span class="comment">/* Pulse are consider on-resonance */</span>
00083    expr-&gt;<a class="code" href="struct__Experience3D.html#o31">FLAG_DECH</a> = <a class="code" href="experience_8h.html#a1">ON</a> ; 
00084    <span class="keywordflow">return</span>(expr);
00085 }
00086 
00087 
<a name="l00094"></a><a class="code" href="group__Experience.html#ga6">00094</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga6">FreeExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00095 {
00096     <span class="keywordtype">int</span> i,j;
00097 
00098    <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
00099        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[i][0][0]);
00100        <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>; j++)
00101       free(expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[i][j]);
00102        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[i]);
00103    }
00104    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>);
00105 
00106    <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
00107        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[i][0][0]);
00108        <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; j++)
00109       free(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[i][j]);
00110        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[i]);
00111    }
00112    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>);
00113 
00114    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[0][0]);
00115    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[0][0]);
00116    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[0][0]);
00117    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[0][0]);
00118    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[0][0]);
00119    
00120    <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++) {
00121        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[i]);
00122        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[i]);
00123        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[i]);
00124        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i]);
00125        free(expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[i]);
00126    }
00127 
00128    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>);
00129    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>);
00130    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>);
00131    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>);
00132    free(expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>);
00133    
00134    free(expr);
00135 }
00136 
<a name="l00143"></a><a class="code" href="group__Experience.html#ga7">00143</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga7">FreeExperienceSgn</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00144 {
00145  <span class="keywordtype">int</span> i;
00146  
00147  <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)  free(expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[i]);
00148  free(expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>);
00149  free(expr);
00150 }
00151 
<a name="l00158"></a><a class="code" href="group__Experience.html#ga9">00158</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00159 {
00160  expr-&gt;<a class="code" href="struct__Experience3D.html#o20">to</a>=0.0;
00161 }
00162 
<a name="l00169"></a><a class="code" href="group__Experience.html#ga10">00169</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga10">InitToExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00170 {
00171  expr-&gt;<a class="code" href="struct__Experience3D.html#o20">to</a>=0.0;
00172 }
00173 
<a name="l00182"></a><a class="code" href="group__Experience.html#ga19">00182</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga19">SetResonanceExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, <span class="keywordtype">int</span> flag)
00183 {
00184  expr-&gt;<a class="code" href="struct__Experience3D.html#o39">FLAG_RESONANCE</a>=flag;
00185 }
00186 
<a name="l00195"></a><a class="code" href="group__Experience.html#ga20">00195</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga20">SetFlagdechExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, <span class="keywordtype">int</span> flag)
00196 {
00197  expr-&gt;<a class="code" href="struct__Experience3D.html#o31">FLAG_DECH</a>=flag;
00198 }
00199 
<a name="l00208"></a><a class="code" href="group__Experience.html#ga11">00208</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga11">SetT1Experience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, OBJECT3D *object, <span class="keywordtype">int</span> component)
00209 {
00210    <span class="keywordtype">int</span> i,j,k;
00211    <span class="keywordtype">int</span> l;                  <span class="comment">/* Beginning of the physical values (ro, T1, T2) of the object component*/</span> 
00212     l=component*<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;nbparam; <span class="comment">/* T1 is stored at l+1 position of the object structure */</span>
00213     <span class="comment">/******************************************</span>
00214 <span class="comment">    * T1 table has the same size than the object </span>
00215 <span class="comment">     ******************************************/</span>
00216    <span class="comment">/* Allocation */</span>
00217    <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a> = (<span class="keywordtype">float</span> ***) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>))
00218    == NULL) {
00219    fprintf(stderr, <span class="stringliteral">"Malloc error in T1 table \n"</span>);
00220    exit(1);
00221     }
00222 
00223     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++) {
00224    <span class="keywordflow">if</span> (
00225        (expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[i] =
00226         (<span class="keywordtype">float</span> **) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[0][0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>)) ==
00227        NULL) {
00228        fprintf(stderr, <span class="stringliteral">"Malloc error in T1 table \n"</span>);
00229        exit(1);
00230    }
00231     }
00232     <span class="keywordflow">if</span> (
00233    (expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[0][0] =
00234     (<span class="keywordtype">float</span> *) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[0][0][0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a> *
00235             expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>)) == NULL) {
00236    fprintf(stderr, <span class="stringliteral">"Malloc error in T1 table \n"</span>);
00237    exit(1);
00238     }
00239     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00240    <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00241        expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[i][j] =
00242       expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[0][0] + j * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a> +
00243       i * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;
00244    <span class="comment">/* Filling */</span>
00245    <span class="keywordflow">for</span>(i=0;i&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>;i++) <span class="keywordflow">for</span>(j=0;j&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>;j++) <span class="keywordflow">for</span>(k=0;k&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;k++)
00246       expr-&gt;<a class="code" href="struct__Experience3D.html#o17">t1</a>[i][j][k]= <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;values[1+l][k][j][i]/(<span class="keywordtype">float</span>)1000.0; <span class="comment">/* convertion into second */</span>
00247 }
00248 
<a name="l00257"></a><a class="code" href="group__Experience.html#ga12">00257</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga12">SetT2Experience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, OBJECT3D *object, <span class="keywordtype">int</span> component)
00258 {
00259    <span class="keywordtype">int</span> i,j,k;
00260    <span class="keywordtype">int</span> l;           <span class="comment">/* Beginning of the physical values (ro, T1, T2) of the object component*/</span> 
00261     l=component*<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;nbparam; <span class="comment">/* T2 is stored at l+2 position of the object structure*/</span>
00262 
00263    <span class="comment">/******************************************</span>
00264 <span class="comment">    * T2 table has the same size than the object *</span>
00265 <span class="comment">     ******************************************/</span>
00266     <span class="comment">/* Allocation */</span>
00267    <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a> = (<span class="keywordtype">float</span> ***) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>))
00268    == NULL) {
00269    fprintf(stderr, <span class="stringliteral">"Malloc error in table T2\n"</span>);
00270    exit(1);
00271     }
00272 
00273     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++) {
00274    <span class="keywordflow">if</span> (
00275        (expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[i] =
00276         (<span class="keywordtype">float</span> **) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[0][0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>)) ==
00277        NULL) {
00278        fprintf(stderr, <span class="stringliteral">"Malloc error in table T2 \n"</span>);
00279        exit(1);
00280    }
00281     }
00282     <span class="keywordflow">if</span> (
00283    (expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[0][0] =
00284     (<span class="keywordtype">float</span> *) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[0][0][0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a> *
00285             expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>)) == NULL) {
00286    fprintf(stderr, <span class="stringliteral">"Malloc error in table T2 \n"</span>);
00287    exit(1);
00288     }
00289     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00290    <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00291        expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[i][j] =
00292       expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[0][0] + j * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a> +
00293       i * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;
00294    <span class="comment">/* Filling */</span>
00295    <span class="keywordflow">for</span>(i=0;i&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>;i++) <span class="keywordflow">for</span>(j=0;j&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>;j++) <span class="keywordflow">for</span>(k=0;k&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;k++)
00296       expr-&gt;<a class="code" href="struct__Experience3D.html#o18">t2</a>[i][j][k]=<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;values[2+l][k][j][i]/(<span class="keywordtype">float</span>)1000.0; <span class="comment">/* Second conversion */</span>
00297 }
00298 
<a name="l00307"></a><a class="code" href="group__Experience.html#ga13">00307</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga13">SetRoExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, OBJECT3D *object, <span class="keywordtype">int</span> component)
00308 {
00309    <span class="keywordtype">int</span> i,j,k;
00310    <span class="keywordtype">int</span> l;                <span class="comment">/* Beginning of the physical values (ro, T1, T2) of the object component*/</span> 
00311     l=component*<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;nbparam;<span class="comment">/* Ro is stored at the l position of the object structure*/</span>
00312 
00313    <span class="comment">/******************************************</span>
00314 <span class="comment">    *  Ro table has the same size than the object *</span>
00315 <span class="comment">     ******************************************/</span>
00316    <span class="comment">/* Allocation */</span>
00317    <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a> = (<span class="keywordtype">float</span> ***) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>))
00318    == NULL) {
00319    fprintf(stderr, <span class="stringliteral">"Malloc error in table Ro\n"</span>);
00320    exit(1);
00321     }
00322 
00323     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++) {
00324    <span class="keywordflow">if</span> (
00325        (expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[i] =
00326         (<span class="keywordtype">float</span> **) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[0][0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>)) ==
00327        NULL) {
00328        fprintf(stderr, <span class="stringliteral">"Malloc error in table Ro\n"</span>);
00329        exit(1);
00330    }
00331     }
00332     <span class="keywordflow">if</span> (
00333    (expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[0][0] =
00334     (<span class="keywordtype">float</span> *) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[0][0][0]) * expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a> *
00335             expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>)) == NULL) {
00336    fprintf(stderr, <span class="stringliteral">"Malloc error in table Ro\n"</span>);
00337    exit(1);
00338     }
00339     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00340    <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00341        expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[i][j] =
00342       expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[0][0] + j * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a> +
00343       i * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;
00344    <span class="comment">/* Filling */</span>
00345    <span class="keywordflow">for</span>(i=0;i&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>;i++) <span class="keywordflow">for</span>(j=0;j&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>;j++) <span class="keywordflow">for</span>(k=0;k&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;k++)
00346       expr-&gt;<a class="code" href="struct__Experience3D.html#o19">ro</a>[i][j][k]=<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;values[0+l][k][j][i];
00347 }
00348 
<a name="l00355"></a><a class="code" href="group__Experience.html#ga14">00355</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga14">InitMagstateExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00356 {
00357  <span class="keywordtype">int</span> i,j,k,v;
00358     <span class="comment">/* Allocation */</span>
00359    <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>=(<span class="keywordtype">double</span> ****)malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[0])*3)) ==
00360    NULL) {
00361    fprintf(stderr, <span class="stringliteral">"Malloc error magnetization table\n"</span>);
00362    exit(1);
00363     }
00364 
00365     <span class="keywordflow">for</span> (v = 0; v &lt; 3; v++) {
00366    <span class="keywordflow">if</span> (
00367        (expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[v] =
00368         (<span class="keywordtype">double</span> ***) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[0][0]) *
00369              expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>)) == NULL) {
00370        fprintf(stderr, <span class="stringliteral">"Malloc error magnetization table\n"</span>);
00371        exit(1);
00372    }
00373 
00374    <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++) {
00375        <span class="keywordflow">if</span> (
00376       (expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[v][i] =
00377        (<span class="keywordtype">double</span> **) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[0][0][0]) *
00378                 expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>)) == NULL) {
00379       fprintf(stderr, <span class="stringliteral">"Malloc error magnetization table\n"</span>);
00380       exit(1);
00381        }
00382    }
00383    <span class="keywordflow">if</span> (
00384        (expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[v][0][0] =
00385         (<span class="keywordtype">double</span> *) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[0][0][0][0]) *
00386                 expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>)) ==
00387        NULL) {
00388        fprintf(stderr, <span class="stringliteral">"Malloc error magnetization table\n"</span>);
00389        exit(1);
00390    }
00391    <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00392        <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00393       expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[v][i][j] =
00394           expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[v][0][0] + j * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a> +
00395           i * expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;
00396     }
00397    <span class="comment">/* Init */</span>
00398    <span class="keywordflow">for</span>(v=0;v&lt;3;v++) 
00399       <span class="keywordflow">for</span>(i=0;i&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>;i++) <span class="keywordflow">for</span>(j=0;j&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>;j++) <span class="keywordflow">for</span>(k=0;k&lt;expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;k++)
00400       expr-&gt;<a class="code" href="struct__Experience3D.html#o23">magstate</a>[v][i][j][k]=0.0;
00401 }
00402 
<a name="l00410"></a><a class="code" href="group__Experience.html#ga15">00410</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga15">SetB0Experience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr,<span class="keywordtype">double</span> B0)
00411 {
00412  expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a> = B0;
00413 }
00414 
<a name="l00422"></a><a class="code" href="group__Experience.html#ga16">00422</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga16">SetB0DefExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr,<span class="keywordtype">double</span> valmax)
00423 {
00424  expr-&gt;<a class="code" href="struct__Experience3D.html#o37">b0def</a>=valmax;
00425 }
00426 
<a name="l00435"></a><a class="code" href="group__Experience.html#ga18">00435</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga18">SetGdechExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr,OBJECT3D *object)
00436 {
00437  <span class="keywordtype">int</span> i,j,k;
00438  <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
00439  <span class="keywordtype">double</span> decx,decy,decz;
00440  <span class="keywordtype">float</span> def;
00441  <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>;
00442  y= expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>;
00443  z= expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;
00444 
00445     <span class="comment">/* Allocation */</span>
00446     <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a> = (<span class="keywordtype">float</span> ***) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[0]) * <a class="code" href="jerror_8h.html#a52a35">x</a>)) == NULL) {
00447    fprintf(stderr, <span class="stringliteral">"Malloc error magstate table\n"</span>);
00448    exit(1);
00449     }
00450 
00451     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="jerror_8h.html#a52a35">x</a>; i++) {
00452    <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i] = (<span class="keywordtype">float</span> **) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[0][0]) * y)) == NULL) {
00453        fprintf(stderr, <span class="stringliteral">"Malloc error magstate table \n"</span>);
00454        exit(1);
00455    }
00456     }
00457     <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[0][0] = (<span class="keywordtype">float</span> *) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[0][0][0]) * <a class="code" href="jerror_8h.html#a52a35">x</a> * y * z)) == NULL) {
00458    fprintf(stderr, <span class="stringliteral">"Malloc error G_deche table \n"</span>);
00459    exit(1);
00460     }
00461     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="jerror_8h.html#a52a35">x</a>; i++)   <span class="keywordflow">for</span> (j = 0; j &lt; y; j++)
00462        expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i][j] = expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[0][0] + j * z +  i * y * z;
00463 
00464     decx= expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>/2.;
00465    decy= expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>/2.;
00466    decz= expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>/2.;
00467 
00468    
00469    <span class="keywordflow">switch</span> (expr-&gt;<a class="code" href="struct__Experience3D.html#o31">FLAG_DECH</a>)
00470    {
00471    <span class="keywordflow">case</span> 0: <span class="comment">/* No default accounting */</span>
00472       {
00473       <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00474           <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00475             <span class="keywordflow">for</span> (k = 0; k &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>; k++)
00476                expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i][j][k] = 0.0;
00477       <span class="keywordflow">break</span>;
00478       }
00479    <span class="keywordflow">case</span> 1: <span class="comment">/* Accounting the default linked only to the object */</span>
00480       {
00481        <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00482           <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00483             <span class="keywordflow">for</span> (k = 0; k &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>; k++)
00484                expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i][j][k] =  ((<span class="keywordtype">float</span>)expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a>)* <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;fielddefault[k][j][i];
00485        <span class="keywordflow">break</span>; 
00486       }
00487    <span class="keywordflow">case</span> 2: <span class="comment">/* Accounting the default linked only to the main magnet B0 with a parabolic form */</span>
00488       {
00489       <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00490          <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00491             <span class="keywordflow">for</span> (k = 0; k &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>; k++)
00492              expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i][j][k] = ((<span class="keywordtype">float</span>)expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a>)*((i-decx)*(i-decx)+(j-decy)*(j-decy)+(k-decz)*(k-decz))*expr-&gt;<a class="code" href="struct__Experience3D.html#o37">b0def</a>/(decx*decx+decy*decy+decz*decz);
00493        <span class="keywordflow">break</span>; 
00494       }
00495    <span class="keywordflow">case</span> 3: <span class="comment">/* Accounting both effects : case 1 + 2 */</span>
00496       {
00497        <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00498           <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00499             <span class="keywordflow">for</span> (k = 0; k &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>; k++)
00500             {
00501                def =((<span class="keywordtype">float</span>)expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a>)*((i-decx)*(i-decx)+(j-decy)*(j-decy)+(k-decz)*(k-decz))*expr-&gt;<a class="code" href="struct__Experience3D.html#o37">b0def</a>/(decx*decx+decy*decy+decz*decz);
00502                expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i][j][k] = def + ((<span class="keywordtype">float</span>)expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a>)* <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;fielddefault[k][j][i];
00503             }
00504        <span class="keywordflow">break</span>; 
00505       }
00506    <span class="keywordflow">default</span>: <span class="comment">/* No accounting */</span>
00507       {
00508        <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>; i++)
00509           <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>; j++)
00510             <span class="keywordflow">for</span> (k = 0; k &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>; k++)
00511                expr-&gt;<a class="code" href="struct__Experience3D.html#o32">G_deche</a>[i][j][k] = 0.0;
00512        <span class="keywordflow">break</span>; 
00513       }
00514    }
00515    
00516 }
00517 
<a name="l00525"></a><a class="code" href="group__Experience.html#ga34">00525</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga34">SetB1</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00526 {
00527 <span class="comment">//  ASCII file B1t.txt must contain a complex 3D map of the normalized transmit field (max module = 1).</span>
00528 <span class="comment">//  ASCII file B1r.txt must contain a complex 3D map of the normalized receive field. </span>
00529 <span class="comment">//  Each line of these files contains 2 floats representing the real and imaginary parts of the B1 value.</span>
00530 <span class="comment">//  The order of the lines is as follows (x, y and z vary from 0 to sizeX, sizeY, sizeZ, e.g. 64 x 64 x 40):</span>
00531 <span class="comment">// </span>
00532 <span class="comment">//    1st line corresponds to pixel (x=0, y=0, z=0) in volume corner  </span>
00533 <span class="comment">//    2nd line                      (x=1, y=0, z=0)</span>
00534 <span class="comment">//              ...</span>
00535 <span class="comment">//              64-th line                    (x=63, y=0, z=0)</span>
00536 <span class="comment">//              65-th line                    (x=0, y=1, z=0)</span>
00537 <span class="comment">//              66-th line                    (x=1, y=1, z=0)</span>
00538 <span class="comment">//              ...</span>
00539 <span class="comment">//              4096-th line                  (x=63, y=63, z=0)</span>
00540 <span class="comment">//              4097-th line                  (x=0, y=0, z=1) </span>
00541 <span class="comment">//               ...                     </span>
00542 <span class="comment">//              last line                     (x=63, y=63, z=39) in opposite volume corner</span>
00543 <span class="comment">//</span>
00544 <span class="comment">//  If ever the object to be imaged has a cylindrical symmetry, B1r does not need to be provided in addition to B1t: </span>
00545 <span class="comment">//  a mirror symmetry is then used to find B1r from B1t, i.e.: Re(B1r(x,y)) = Im(B1t(y,x)) and Im(B1r(x,y)) = Re(B1t(y,x))</span>
00546   <span class="keywordtype">char</span> B1t_File[80] = <span class="stringliteral">"../data/B1map/B1t.txt"</span>;  <span class="comment">// transmit field</span>
00547   <span class="keywordtype">char</span> B1r_File[80] = <span class="stringliteral">"../data/B1map/B1r.txt"</span>;  <span class="comment">// reception field</span>
00548   FILE *b1t_file, *b1r_file;
00549   <span class="keywordtype">int</span> i,j,k;
00550   <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
00551   <a class="code" href="jerror_8h.html#a52a35">x</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00552   y = expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
00553   z = expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00554  
00555   printf(<span class="stringliteral">"x = %i, y = %i, z = %i\n"</span>, <a class="code" href="jerror_8h.html#a52a35">x</a>, y, z);
00556 
00557   b1t_file = fopen(B1t_File, <span class="stringliteral">"r"</span>);
00558   <span class="keywordflow">if</span> (b1t_file == NULL) {
00559      printf(<span class="stringliteral">"Unable to read the B1t(r) file %s \n"</span>, B1t_File);
00560      exit(0);
00561   }  
00562   b1r_file = fopen(B1r_File, <span class="stringliteral">"r"</span>);
00563 
00564  <span class="comment">/* B1 Allocation*/</span>
00565 
00566   expr-&gt;<a class="code" href="struct__Experience3D.html#o35">B1t</a> = (<a class="code" href="structCOMPLEX__FLOAT.html">PPPVOLUME_COMPLEX_FLOAT</a>) <a class="code" href="volallo_8c.html#a1">IdVolAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z,<a class="code" href="idvol-ido_8h.html#a11">VOL_COMPLEX_FLOAT</a>);
00567   <span class="keywordflow">if</span> (!expr-&gt;<a class="code" href="struct__Experience3D.html#o35">B1t</a>)
00568   {
00569      printf(<span class="stringliteral">"Impossible d'allouer B1t(r) ! \n"</span>);
00570      exit(0);
00571   }
00572   expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a> = (<a class="code" href="structCOMPLEX__FLOAT.html">PPPVOLUME_COMPLEX_FLOAT</a>) <a class="code" href="volallo_8c.html#a1">IdVolAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z,<a class="code" href="idvol-ido_8h.html#a11">VOL_COMPLEX_FLOAT</a>);
00573   <span class="keywordflow">if</span> (!expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>)
00574   {
00575      printf(<span class="stringliteral">"Impossible d'allouer B1r(r) ! \n"</span>);
00576      exit(0);
00577   }
00578 
00579 <span class="comment">// Set B1(r) to default values</span>
00580   
00581   printf(<span class="stringliteral">"B1 File reading %s\n"</span>, B1t_File);
00582   <span class="keywordflow">for</span> (k = 0; k &lt; z; k++) <span class="keywordflow">for</span> (j = 0; j &lt; y; j++) <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="jerror_8h.html#a52a35">x</a>; i++){
00583     fscanf(b1t_file, <span class="stringliteral">"%f %f"</span>, &amp;expr-&gt;<a class="code" href="struct__Experience3D.html#o35">B1t</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o0">re</a>, &amp;expr-&gt;<a class="code" href="struct__Experience3D.html#o35">B1t</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o1">im</a>);
00584   } 
00585   fclose(b1t_file);
00586 
00587   <span class="keywordflow">if</span> (b1r_file == NULL) {
00588      printf(<span class="stringliteral">"Unable to read the B1r(r) file %s \n"</span>, B1r_File);
00589      printf(<span class="stringliteral">"Assume cylindrical symmetry of the phantom/subject, i.e.: Re(B1r(x,y)) = Im(B1t(y,x)) and Im(B1r(x,y)) = Re(B1t(y,x))\n"</span>);
00590      <span class="keywordflow">for</span> (k = 0; k &lt; z; k++) <span class="keywordflow">for</span> (j = 0; j &lt; y; j++) <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="jerror_8h.html#a52a35">x</a>; i++){
00591        expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][i][j].<a class="code" href="structCOMPLEX__FLOAT.html#o0">re</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o35">B1t</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o1">im</a>;
00592        expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][i][j].<a class="code" href="structCOMPLEX__FLOAT.html#o1">im</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o35">B1t</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o0">re</a>;
00593      }
00594   }
00595   <span class="keywordflow">else</span> {  
00596      printf(<span class="stringliteral">"Lecture du fichier %s\n"</span>, B1r_File);
00597      <span class="keywordflow">for</span> (k = 0; k &lt; z; k++) <span class="keywordflow">for</span> (j = 0; j &lt; y; j++) <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="jerror_8h.html#a52a35">x</a>; i++){
00598         fscanf(b1r_file, <span class="stringliteral">"%f %f"</span>, &amp;expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o0">re</a>, &amp;expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o1">im</a>);
00599      }
00600      fclose(b1r_file);
00601   } 
00602 }
<a name="l00611"></a><a class="code" href="group__Experience.html#ga17">00611</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga17">SetDeltaB0Experience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr,OBJECT3D *object)
00612 {
00613  <span class="keywordtype">int</span> i,j,k;
00614  <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
00615 
00616  <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>;
00617  y= expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>;
00618  z= expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>;
00619 
00620  <span class="comment">/* Allocation */</span>
00621  <span class="keywordflow">if</span> (
00622    (expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a> =
00623     (<span class="keywordtype">float</span> ***) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[0]) * <a class="code" href="jerror_8h.html#a52a35">x</a>)) ==
00624    NULL) 
00625    {
00626     fprintf(stderr, <span class="stringliteral">"Malloc error of deltaB0 table \n"</span>);
00627     exit(1);
00628    }
00629     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="jerror_8h.html#a52a35">x</a>; i++) 
00630    {
00631     <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[i] =
00632         (<span class="keywordtype">float</span> **)malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[0][0])*y)) == NULL) 
00633       {
00634         fprintf(stderr, <span class="stringliteral">"Malloc error of deltaB0 table\n"</span>);
00635         exit(1);
00636       }
00637     }
00638     
00639    <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[0][0] =
00640       (<span class="keywordtype">float</span> *) malloc(<span class="keyword">sizeof</span>(expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[0][0][0])*<a class="code" href="jerror_8h.html#a52a35">x</a>*y*z)) == NULL) 
00641    {
00642     fprintf(stderr, <span class="stringliteral">"Malloc error of deltaB0 table\n"</span>);
00643     exit(1);
00644     }
00645     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) <span class="keywordflow">for</span> (j=0;j&lt;y;j++)
00646        expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[i][j] = expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[0][0] + j * z + i * y * z;
00647    <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(k=0;k&lt;z;k++) 
00648      expr-&gt;<a class="code" href="struct__Experience3D.html#o21">deltaB0</a>[i][j][k] = ((<span class="keywordtype">float</span>)expr-&gt;<a class="code" href="struct__Experience3D.html#o33">B0</a>) * <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;deltaB0[k][j][i];
00649 }
00650 
<a name="l00662"></a><a class="code" href="group__Experience.html#ga21">00662</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga21">SetObjectExperienceComponent</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, OBJECT3D *object,<span class="keywordtype">int</span> component,<span class="keywordtype">int</span> FLAG_DECH)
00663 {
00664    <span class="keywordflow">if</span> ((<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;nbcomponent&gt;2)||(<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;nbparam&gt;4))
00665    {
00666       printf(<span class="stringliteral">"This kind of object is not manageable at the moment!\n"</span>);
00667       exit(0);
00668    }
00669    <span class="comment">/* Chemical shift in rad/s */</span>
00670 
00671       <span class="keywordflow">if</span> (component==0)  
00672         expr-&gt;<a class="code" href="struct__Experience3D.html#o38">G_edw</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;chemshift[<a class="code" href="object_8h.html#a0">WATER</a>] * 2. * M_PI ; 
00673       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (component==1)  
00674         expr-&gt;<a class="code" href="struct__Experience3D.html#o38">G_edw</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;chemshift[<a class="code" href="object_8h.html#a1">FAT</a>] * 2. * M_PI;
00675     <span class="keywordflow">else</span>
00676    {
00677       printf(<span class="stringliteral">"Component not defined !\n"</span>);
00678       exit(1);
00679    }
00680 
00681    expr-&gt;<a class="code" href="struct__Experience3D.html#o31">FLAG_DECH</a> = FLAG_DECH ; <span class="comment">/* Field default accounting */</span>
00682    
00683    <span class="comment">/* Fov and size */</span> 
00684    <span class="comment">/* By default, the fov equals the object size */</span>
00685    expr-&gt;<a class="code" href="struct__Experience3D.html#o8">lx</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;lx; 
00686    expr-&gt;<a class="code" href="struct__Experience3D.html#o9">ly</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;ly;
00687    expr-&gt;<a class="code" href="struct__Experience3D.html#o10">lz</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;lz;  
00688    expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;lx; 
00689    expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;ly;
00690    expr-&gt;<a class="code" href="struct__Experience3D.html#o13">fovz</a> = <a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;lz;   
00691     
00692    <span class="comment">/* Number of object point */</span>
00693    expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a>=<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;x;
00694    expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a>=<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;y;
00695    expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a>=<a class="code" href="jmemsys_8h.html#a3">object</a>-&gt;z;
00696 
00697    <span class="comment">/* The step px,py,pz (used by the computation kernel to compute dw) are </span>
00698 <span class="comment">    computed using the object size */</span>
00699     expr-&gt;<a class="code" href="struct__Experience3D.html#o27">px</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a> == 1 ? 1e-12 : expr-&gt;<a class="code" href="struct__Experience3D.html#o8">lx</a> / (expr-&gt;<a class="code" href="struct__Experience3D.html#o5">nfovx</a> - 1);
00700     expr-&gt;<a class="code" href="struct__Experience3D.html#o28">py</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> == 1 ? 1e-12 : expr-&gt;<a class="code" href="struct__Experience3D.html#o9">ly</a> / (expr-&gt;<a class="code" href="struct__Experience3D.html#o6">nfovy</a> - 1);
00701     expr-&gt;<a class="code" href="struct__Experience3D.html#o29">pz</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a> == 1 ? 1e-12 : expr-&gt;<a class="code" href="struct__Experience3D.html#o10">lz</a> / (expr-&gt;<a class="code" href="struct__Experience3D.html#o7">nfovz</a> - 1);
00702    expr-&gt;<a class="code" href="struct__Experience3D.html#o24">xf</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o8">lx</a> / 2.;  <span class="comment">/* xf=object center */</span>
00703     expr-&gt;<a class="code" href="struct__Experience3D.html#o25">yf</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o9">ly</a> / 2.;
00704     expr-&gt;<a class="code" href="struct__Experience3D.html#o26">zf</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o10">lz</a> / 2.;
00705    
00706 
00707    <a class="code" href="group__Experience.html#ga10">InitToExperience</a>(expr);
00708    <a class="code" href="group__Experience.html#ga11">SetT1Experience</a>(expr,<a class="code" href="jmemsys_8h.html#a3">object</a>,component);
00709    <a class="code" href="group__Experience.html#ga12">SetT2Experience</a>(expr,<a class="code" href="jmemsys_8h.html#a3">object</a>,component);
00710    <a class="code" href="group__Experience.html#ga13">SetRoExperience</a>(expr,<a class="code" href="jmemsys_8h.html#a3">object</a>,component);
00711    <a class="code" href="group__Experience.html#ga14">InitMagstateExperience</a>(expr);
00712    <a class="code" href="group__Experience.html#ga17">SetDeltaB0Experience</a>(expr,<a class="code" href="jmemsys_8h.html#a3">object</a>);
00713    <a class="code" href="group__Experience.html#ga18">SetGdechExperience</a>(expr,<a class="code" href="jmemsys_8h.html#a3">object</a>);
00714 }
00715 
00716 
<a name="l00724"></a><a class="code" href="group__Experience.html#ga8">00724</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga8">SetNameExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, <span class="keywordtype">char</span> *name)
00725 {
00726    strcpy(expr-&gt;<a class="code" href="struct__Experience3D.html#o0">name</a>,name);
00727 }
00728 
<a name="l00735"></a><a class="code" href="group__Experience.html#ga23">00735</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga23">InitRFSigExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00736 {
00737    <span class="keywordtype">int</span> i,j,k,v;
00738     <span class="comment">/********************************</span>
00739 <span class="comment">   * The RF table has the same size than the output RF volume</span>
00740 <span class="comment">   ********************************/</span>
00741    <span class="comment">/* Allocation */</span>
00742     <span class="keywordflow">if</span> ((expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a> = (<span class="keywordtype">float</span> ****) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span> ***) * 3)) == NULL) {
00743    fprintf(stderr, <span class="stringliteral">"Malloc error of the RF signal table\n"</span>);
00744    exit(1);
00745     }
00746 
00747     <span class="keywordflow">for</span> (v = 0; v &lt; 3; v++) {
00748    <span class="keywordflow">if</span> (
00749        (expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[v] =
00750         (<span class="keywordtype">float</span> ***) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span> **) * expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>)) == NULL) {
00751        fprintf(stderr, <span class="stringliteral">"Malloc error of the RF signal table \n"</span>);
00752        exit(1);
00753    }
00754 
00755    <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>; i++) {
00756        <span class="keywordflow">if</span> (
00757       (expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[v][i] =
00758        (<span class="keywordtype">float</span> **) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span> *) * expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>)) == NULL) {
00759       fprintf(stderr, <span class="stringliteral">"Malloc error of the RF signal table \n"</span>);
00760       exit(1);
00761        }
00762    }
00763    <span class="keywordflow">if</span> (
00764        (expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[v][0][0] =
00765         (<span class="keywordtype">float</span> *) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a> *
00766                expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>)) == NULL) {
00767        fprintf(stderr, <span class="stringliteral">"Malloc error of the RF signal table\n"</span>);
00768        exit(1);
00769    }
00770    <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>; i++)
00771        <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; j++)
00772       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[v][i][j] =
00773           expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[v][0][0] + j * expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a> +
00774           i * expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00775     }
00776      <span class="comment">/* Setting */</span>
00777     <span class="keywordflow">for</span> (i = 0; i &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>; i++)
00778    <span class="keywordflow">for</span> (j = 0; j &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; j++)
00779        <span class="keywordflow">for</span> (k = 0; k &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>; k++) {
00780       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[0][i][j][k] = 0;
00781       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[1][i][j][k] = 0;
00782       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[2][i][j][k] = 0;
00783        }
00784 }
00785 
<a name="l00797"></a><a class="code" href="group__Experience.html#ga24">00797</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga24">SetAcqExperience</a> (<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr,<span class="keywordtype">int</span> ntx, <span class="keywordtype">int</span> nty, <span class="keywordtype">int</span> ntz, 
00798                   <span class="keywordtype">double</span> tacq)
00799 {
00800     
00801     expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a> = ntx;
00802     expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a> = nty;
00803     expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a> = ntz;
00804     <span class="keywordflow">if</span> (tacq == 0) {
00805    fprintf(stderr, <span class="stringliteral">"Error : acquisition time equals zero\n"</span>);
00806    exit(1);
00807     }
00808    <span class="keywordflow">else</span>
00809       expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a> = tacq;
00810 
00811     expr-&gt;<a class="code" href="struct__Experience3D.html#o30">pt</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a> / (expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a> - 1);
00812    <a class="code" href="group__Experience.html#ga23">InitRFSigExperience</a>(expr);
00813 }
00814 
00815 
<a name="l00825"></a><a class="code" href="group__Experience.html#ga5">00825</a> <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * <a class="code" href="group__Experience.html#ga5">AllocExperienceSgn</a>(<span class="keywordtype">int</span> ntx,<span class="keywordtype">int</span> nty,<span class="keywordtype">int</span> ntz)
00826 {
00827    <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>  * expr;
00828 
00829    expr = <a class="code" href="group__Experience.html#ga0">AllocExperience</a>();
00830    expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a> = ntx;     
00831    expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a> = nty;
00832    expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a> = ntz;
00833 
00834    <a class="code" href="group__Experience.html#ga23">InitRFSigExperience</a>(expr);
00835    <span class="keywordflow">return</span>(expr);
00836 }
00837 
<a name="l00850"></a><a class="code" href="group__Experience.html#ga22">00850</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga22">SetFovExperience</a> (<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, <span class="keywordtype">double</span> fovx,
00851                   <span class="keywordtype">double</span> fovy,<span class="keywordtype">double</span> fovz,
00852                   <span class="keywordtype">double</span> obx,<span class="keywordtype">double</span> oby,
00853                   <span class="keywordtype">double</span> obz)
00854 {
00855     expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a> = fovx;
00856     expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a> = fovy;
00857     expr-&gt;<a class="code" href="struct__Experience3D.html#o13">fovz</a> = fovz;
00858     expr-&gt;<a class="code" href="struct__Experience3D.html#o14">obx</a> = obx;
00859     expr-&gt;<a class="code" href="struct__Experience3D.html#o15">oby</a> = oby;
00860     expr-&gt;<a class="code" href="struct__Experience3D.html#o16">obz</a> = obz;
00861 }
00862 
<a name="l00870"></a><a class="code" href="group__Experience.html#ga28">00870</a> <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> <a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00871 {
00872    <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volcomplex;
00873     <span class="keywordtype">int</span> i,j,k;
00874    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
00875 <span class="preprocessor">#ifdef HAVE_MPI</span>
00876 <span class="preprocessor"></span>   <span class="keywordtype">int</span> myrank;
00877 <span class="preprocessor">#endif</span>
00878 <span class="preprocessor"></span>
00879    <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00880    y= expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
00881    z= expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00882 
00883    volcomplex = (<a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a>) <a class="code" href="volallo_8c.html#a1">IdVolAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z,<a class="code" href="idvol-ido_8h.html#a10">VOL_COMPLEX_DOUBLE</a>);
00884    
00885    <span class="keywordflow">for</span> (k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
00886    {
00887       volcomplex[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[1][i][j][k]; <span class="comment">/* Y+iX */</span>
00888       volcomplex[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[0][i][j][k];
00889    }
00890 <span class="preprocessor">#ifdef HAVE_MPI</span>
00891 <span class="preprocessor"></span>   MPI_Comm_rank(MPI_COMM_WORLD, &amp;myrank);
00892    <span class="keywordflow">if</span> (myrank == 0) {
00893        <span class="keywordtype">float</span> avg[2]={0.,0.};
00894        <span class="keywordtype">float</span> <a class="code" href="idmac_8h.html#a0">min</a>[2]={0.,0.};
00895        <span class="keywordtype">float</span> <a class="code" href="idmac_8h.html#a1">max</a>[2]={0.,0.};
00896        <span class="keywordtype">float</span> std_dev[2]={0.,0.};
00897        <span class="keywordtype">float</span> e[2];
00898        <span class="keywordtype">int</span> l;
00899 
00900        <a class="code" href="idmac_8h.html#a0">min</a>[0] = <a class="code" href="idmac_8h.html#a1">max</a>[0] = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[0][0][0][0];
00901        <a class="code" href="idmac_8h.html#a0">min</a>[1] = <a class="code" href="idmac_8h.html#a1">max</a>[1] = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[1][0][0][0];
00902        <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
00903        <span class="keywordflow">for</span> (j=0;j&lt;y;j++)
00904        <span class="keywordflow">for</span> (k=0;k&lt;z;k++)
00905        <span class="keywordflow">for</span> (l=0;l&lt;2;l++) {
00906       e[l] = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[l][i][j][k];
00907       avg[l] += e[l];
00908 
00909       <span class="keywordflow">if</span> (e[l] &gt; <a class="code" href="idmac_8h.html#a1">max</a>[l]) <a class="code" href="idmac_8h.html#a1">max</a>[l]=e[l];
00910       <span class="keywordflow">if</span> (e[l] &lt; <a class="code" href="idmac_8h.html#a0">min</a>[l]) <a class="code" href="idmac_8h.html#a0">min</a>[l]=e[l];
00911        }
00912        avg[0] = avg[0] / (<a class="code" href="jerror_8h.html#a52a35">x</a>*y*z);
00913        avg[1] = avg[1] / (<a class="code" href="jerror_8h.html#a52a35">x</a>*y*z);
00914 
00915        <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
00916        <span class="keywordflow">for</span> (j=0;j&lt;y;j++)
00917        <span class="keywordflow">for</span> (k=0;k&lt;z;k++)
00918        <span class="keywordflow">for</span> (l=0;l&lt;2;l++) {
00919       e[l] = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[l][i][j][k];
00920       std_dev[l] += (e[l] - avg[l])*(e[l] - avg[l]);
00921        }
00922        std_dev[0] = sqrt(std_dev[0] / (<a class="code" href="jerror_8h.html#a52a35">x</a>*y*z));
00923        std_dev[1] = sqrt(std_dev[1] / (<a class="code" href="jerror_8h.html#a52a35">x</a>*y*z));
00924 
00925        printf(<span class="stringliteral">"summary:\n"</span>);
00926        printf(<span class="stringliteral">"im: min=%f, max=%f, avg=%f, std_dev=%f\n"</span>,
00927       <a class="code" href="idmac_8h.html#a0">min</a>[0], <a class="code" href="idmac_8h.html#a1">max</a>[0], avg[0], std_dev[0]);
00928        printf(<span class="stringliteral">"re: min=%f, max=%f, avg=%f, std_dev=%f\n"</span>,
00929       <a class="code" href="idmac_8h.html#a0">min</a>[1], <a class="code" href="idmac_8h.html#a1">max</a>[1], avg[1], std_dev[1]);
00930    }
00931 <span class="preprocessor">#endif</span>
00932 <span class="preprocessor"></span>
00933    <span class="keywordflow">return</span> (volcomplex);
00934 }
00935 
<a name="l00942"></a><a class="code" href="group__Experience.html#ga25">00942</a> <span class="keywordtype">void</span> <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
00943 {
00944    <span class="keywordtype">int</span> i,j,k,n;
00945    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
00946    <span class="keywordtype">double</span> c;
00947    
00948    <span class="comment">/* px=lx/x, take into account the size and the number of points */</span>
00949    c = expr-&gt;<a class="code" href="struct__Experience3D.html#o27">px</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o28">py</a> * expr-&gt;<a class="code" href="struct__Experience3D.html#o29">pz</a>; 
00950       <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>; y= expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;   z= expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00951 
00952    <span class="keywordflow">for</span>(k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) <span class="keywordflow">for</span> (n=0;n&lt;3;n++)
00953       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[n][i][j][k] = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[n][i][j][k] / (<span class="keywordtype">float</span>) c;
00954 }
00955 
<a name="l00964"></a><a class="code" href="group__Experience.html#ga27">00964</a> <a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a> <a class="code" href="group__Experience.html#ga27">GetSignalRFComponentFromExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr,<span class="keywordtype">int</span> comp)
00965 {
00966    <a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a> vol;
00967    <span class="keyword">register</span> <span class="keywordtype">int</span> i,j,k;
00968    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
00969    
00970    <span class="keywordflow">if</span> ((comp &gt;2) || (comp&lt;0))
00971    {
00972       printf(<span class="stringliteral">"This component does not exist!\n"</span>);
00973       exit(1);
00974    }
00975    
00976    <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>; y= expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;   z= expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00977 
00978    vol = (<a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a>) <a class="code" href="volallo_8c.html#a1">IdVolAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z,<a class="code" href="idvol-ido_8h.html#a6">VOL_FLOAT</a>);
00979     <span class="keywordflow">for</span>(k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
00980        vol[k][j][i] = (<span class="keywordtype">float</span>) expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[comp][i][j][k];
00981       
00982    <span class="keywordflow">return</span> (vol);
00983 }
00984 
<a name="l00994"></a><a class="code" href="group__Experience.html#ga26">00994</a> <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> <a class="code" href="group__Experience.html#ga26">GetkSpaceImage2DFromExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr, <span class="keywordtype">int</span> haut, <span class="keywordtype">int</span> dir)
00995 {
00996    <a class="code" href="idima-ido_8h.html#a26">PPIMAGE_FLOAT</a> imafloat;
00997    <a class="code" href="idsig-ido_8h.html#a28">PSIGNAL_FLOAT</a> sigx;
00998    <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> imasig;
00999    <a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a> ima;
01000     <span class="keywordtype">int</span> i,j;
01001    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
01002    <span class="keywordtype">int</span> ligne;
01003 
01004    <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
01005    y= expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
01006    z= expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
01007 
01008    <span class="keywordflow">if</span> (z!=1)
01009    {
01010       printf(<span class="stringliteral">"Only available for 2D k space \n"</span>);
01011       exit(1);
01012    }
01013 
01014    <span class="keywordflow">if</span> (!((dir ==0) || (dir==1)))
01015    {
01016       printf(<span class="stringliteral">"The direction parameter is not correct : 0-&gt;X, 1-&gt;Y \n"</span>);
01017       exit(1);
01018    }
01019 
01020 
01021    imafloat = (<a class="code" href="idima-ido_8h.html#a26">PPIMAGE_FLOAT</a>) <a class="code" href="imaallo_8c.html#a9">IdImaAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,<a class="code" href="idima-ido_8h.html#a6">IMA_FLOAT</a>);
01022    <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
01023       imafloat[j][i] = expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[dir][i][j][0];<span class="comment">/* recuperation of the signals from the antennas 'dir' */</span>
01024     
01025    ima = (<a class="code" href="idima-ido_8h.html#a25">PPIMAGE_UCHAR</a>) <a class="code" href="imaallo_8c.html#a9">IdImaAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y*haut,<a class="code" href="idima-ido_8h.html#a1">IMA_UCHAR</a>);
01026    <span class="keywordflow">for</span>(ligne=0;ligne&lt;y;ligne++) 
01027    {
01028       sigx = (<a class="code" href="idsig-ido_8h.html#a28">PSIGNAL_FLOAT</a>) <a class="code" href="sigallo_8c.html#a1">IdSigAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,<a class="code" href="idsig-ido_8h.html#a6">SIG_FLOAT</a>);
01029       <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) sigx[i] = imafloat[ligne][i];
01030       imasig = <a class="code" href="sigtoima_8c.html#a2">IdImaSignalToImage</a>(sigx,0,<a class="code" href="jerror_8h.html#a52a35">x</a>,0,-1,-1,<a class="code" href="jerror_8h.html#a52a35">x</a>,haut,255,0);
01031         <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) <span class="keywordflow">for</span> (j=0;j&lt;haut;j++)
01032          ima[(ligne*haut)+j][i] = imasig[j][i];
01033       <a class="code" href="idima-base_8h.html#a0">IdImaFree</a>(imasig);
01034    }
01035 
01036    <a class="code" href="idsig-base_8h.html#a0">IdSigFree</a>(sigx);
01037    <a class="code" href="idima-base_8h.html#a0">IdImaFree</a>(imafloat);
01038    
01039    <span class="keywordflow">return</span> (ima);
01040 }
01041 
01042 
<a name="l01050"></a><a class="code" href="group__Experience.html#ga29">01050</a> <a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a> <a class="code" href="group__Experience.html#ga29">GetSignalRFModuleFromExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
01051 {
01052    <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volcomplex;
01053    <a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a> module;
01054    <span class="keyword">register</span> <span class="keywordtype">int</span> i,j,k;
01055    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
01056    <span class="keywordtype">double</span> a,<a class="code" href="jpegint_8h.html#a21">b</a>;
01057 
01058    <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
01059    y= expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
01060    z= expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
01061 
01062    volcomplex = (<a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a>) <a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a> (expr);
01063    
01064    module = (<a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a>) <a class="code" href="volallo_8c.html#a1">IdVolAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z,<a class="code" href="idvol-ido_8h.html#a6">VOL_FLOAT</a>);
01065     <span class="keywordflow">for</span>(k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
01066    {
01067       a = volcomplex[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a>;
01068       <a class="code" href="jpegint_8h.html#a21">b</a> = volcomplex[k][j][i].im;
01069       module[k][j][i] = (<span class="keywordtype">float</span>) sqrt(a*a + <a class="code" href="jpegint_8h.html#a21">b</a>*<a class="code" href="jpegint_8h.html#a21">b</a>);
01070    }
01071    
01072    <a class="code" href="idvol_8h.html#a41">IdVolFree</a>(volcomplex);
01073    <span class="keywordflow">return</span> (module);
01074 }
01075 
<a name="l01083"></a><a class="code" href="group__Experience.html#ga30">01083</a> <a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a> <a class="code" href="group__Experience.html#ga30">GetSignalRFPhaseFromExperience</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> *expr)
01084 {
01085    <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volcomplex;
01086    <a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a> phase;
01087    <span class="keyword">register</span> <span class="keywordtype">int</span> i,j,k;
01088    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
01089    <span class="keywordtype">double</span> a,<a class="code" href="jpegint_8h.html#a21">b</a>;
01090 
01091    <a class="code" href="jerror_8h.html#a52a35">x</a>= expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
01092    y= expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
01093    z= expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
01094 
01095    volcomplex = (<a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a>) <a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a> (expr);
01096    
01097    phase = (<a class="code" href="idvol-ido_8h.html#a37">PPPVOLUME_FLOAT</a>) <a class="code" href="volallo_8c.html#a1">IdVolAlloc</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z,<a class="code" href="idvol-ido_8h.html#a6">VOL_FLOAT</a>);
01098     <span class="keywordflow">for</span>(k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
01099    {
01100       a = volcomplex[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a>;
01101       <a class="code" href="jpegint_8h.html#a21">b</a> = volcomplex[k][j][i].im;
01102       phase[k][j][i] = (<span class="keywordtype">float</span>) atan(<a class="code" href="jpegint_8h.html#a21">b</a>/a);
01103    }
01104    
01105    <a class="code" href="idvol_8h.html#a41">IdVolFree</a>(volcomplex);
01106    <span class="keywordflow">return</span> (phase);
01107 }
01108 
<a name="l01117"></a><a class="code" href="group__Utility.html#ga31">01117</a> <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * <a class="code" href="group__Utility.html#ga31">GetSumSignalRFComplex</a>(<a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volrf_1,
01118                           <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volrf_2  )
01119 {
01120    <span class="keywordtype">int</span> i,j,k;
01121    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
01122     <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * expr;
01123    
01124     <a class="code" href="jerror_8h.html#a52a35">x</a>=<a class="code" href="idvol-ido_8h.html#a21">IdVolDimX</a>(volrf_1);
01125     y=<a class="code" href="idvol-ido_8h.html#a22">IdVolDimY</a>(volrf_1);
01126     z=<a class="code" href="idvol-ido_8h.html#a23">IdVolDimZ</a>(volrf_1); 
01127    
01128     expr=<a class="code" href="group__Experience.html#ga5">AllocExperienceSgn</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z);
01129     
01130    <span class="keywordflow">for</span> (k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
01131    {
01132    
01133       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[1][i][j][k]= (<span class="keywordtype">float</span>)(volrf_1[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> + volrf_2[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a>);  <span class="comment">/* Y1+Y2+i(X1+X2) */</span>
01134         expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[0][i][j][k]= (<span class="keywordtype">float</span>)(volrf_1[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> + volrf_2[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a>);
01135    }
01136    expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>=<a class="code" href="jerror_8h.html#a52a35">x</a>;
01137     expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>=y;
01138    expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>=z;
01139 
01140  <span class="keywordflow">return</span> (expr);
01141 }
01142 
<a name="l01151"></a><a class="code" href="group__Utility.html#ga32">01151</a> <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * <a class="code" href="group__Utility.html#ga32">GetDiffSignalRFComplex</a>(<a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volrf_1,
01152                           <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volrf_2)
01153 {
01154    <span class="keywordtype">int</span> i,j,k;
01155    <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
01156     <a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a> * expr;
01157 
01158     <a class="code" href="jerror_8h.html#a52a35">x</a>=<a class="code" href="idvol-ido_8h.html#a21">IdVolDimX</a>(volrf_1);
01159     y=<a class="code" href="idvol-ido_8h.html#a22">IdVolDimY</a>(volrf_1);
01160     z=<a class="code" href="idvol-ido_8h.html#a23">IdVolDimZ</a>(volrf_1); 
01161    
01162     expr=<a class="code" href="group__Experience.html#ga5">AllocExperienceSgn</a>(<a class="code" href="jerror_8h.html#a52a35">x</a>,y,z);
01163 
01164    <span class="keywordflow">for</span> (k=0;k&lt;z;k++) <span class="keywordflow">for</span>(j=0;j&lt;y;j++) <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++)
01165    {
01166       expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[1][i][j][k]= (<span class="keywordtype">float</span>)(volrf_1[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> - volrf_2[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a>);  <span class="comment">/* Y1-Y2+i(X1-X2) */</span>
01167         expr-&gt;<a class="code" href="struct__Experience3D.html#o22">sgn</a>[0][i][j][k]= (<span class="keywordtype">float</span>)(volrf_1[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> - volrf_2[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a>);
01168    }
01169 
01170    expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>=<a class="code" href="jerror_8h.html#a52a35">x</a>;
01171     expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>=y;
01172    expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>=z;
01173 
01174    <span class="keywordflow">return</span> (expr);
01175 }
01176 
<a name="l01185"></a><a class="code" href="group__Utility.html#ga33">01185</a> <span class="keywordtype">void</span> <a class="code" href="group__Utility.html#ga33">AddComplexVolRF</a>(<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr, <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> volacu, <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> vol)
01186 {
01187  <span class="keywordtype">int</span> <a class="code" href="jerror_8h.html#a52a35">x</a>,y,z;
01188  <span class="keywordtype">int</span> i,j,k;
01189 
01190  <span class="keywordflow">if</span> ((!volacu) || (!vol))
01191   {
01192    <a class="code" href="simri3d_8h.html#a18">FPRINTF</a>(stderr,<span class="stringliteral">"Volumes to add not allocated !!\n"</span>);
01193     exit(0);
01194   }
01195  
01196  <a class="code" href="jerror_8h.html#a52a35">x</a> = <a class="code" href="idvol-ido_8h.html#a21">IdVolDimX</a>(volacu);
01197  y = <a class="code" href="idvol-ido_8h.html#a22">IdVolDimY</a>(volacu);
01198  z = <a class="code" href="idvol-ido_8h.html#a23">IdVolDimZ</a>(volacu);
01199 
01200  <span class="keywordflow">if</span> ((<a class="code" href="jerror_8h.html#a52a35">x</a>!=<a class="code" href="idvol-ido_8h.html#a21">IdVolDimX</a>(vol))||(y!=<a class="code" href="idvol-ido_8h.html#a22">IdVolDimY</a>(vol))||(z!=<a class="code" href="idvol-ido_8h.html#a23">IdVolDimZ</a>(vol)))
01201  {
01202    <a class="code" href="simri3d_8h.html#a18">FPRINTF</a>(stderr,<span class="stringliteral">"Volumes to add have differents sizes !!\n"</span>);
01203     exit(0);
01204  }
01205 
01206 <span class="comment">/*******************************************************************************************************/</span>
01207 <span class="comment">// Alexis Amadon, January 2006</span>
01208 <span class="comment">// Measured signal should integrate magnetization weighted by RF coil sensitivity profile:</span>
01209 <span class="comment">// add RF coil complex sensitivity profile B1r-*(r) as a weighting factor of magnetization : signal = integral[M+(r) * B1r-*(r)] ;</span>
01210 <span class="comment">// here B1r stands for Reception field (the one found by running 2nd EM simulation with swapped excitation phases on x and y);</span>
01211 <span class="comment">// the minus sign stands for the circularly-polarized component that turns opposite to the spins' precession;</span>
01212 <span class="comment">// the * sign stands for the complex conjugate</span>
01213   <span class="keywordflow">if</span> (expr-&gt;<a class="code" href="struct__Experience3D.html#o34">inhomogeneousB1</a>){
01214     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) <span class="keywordflow">for</span> (j=0;j&lt;y;j++) <span class="keywordflow">for</span> (k=0;k&lt;z;k++)
01215     {
01216       volacu[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> += expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o0">re</a> * vol[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> + expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o1">im</a> * vol[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a>;
01217       volacu[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> += expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o0">re</a> * vol[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> - expr-&gt;<a class="code" href="struct__Experience3D.html#o36">B1r</a>[k][j][i].<a class="code" href="structCOMPLEX__FLOAT.html#o1">im</a> * vol[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a>;
01218     }
01219   }
01220   <span class="keywordflow">else</span> {
01221     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="jerror_8h.html#a52a35">x</a>;i++) <span class="keywordflow">for</span> (j=0;j&lt;y;j++) <span class="keywordflow">for</span> (k=0;k&lt;z;k++)
01222     {
01223       volacu[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> = volacu[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a> + vol[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o0">re</a>;
01224       volacu[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> = volacu[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a> + vol[k][j][i].<a class="code" href="structCOMPLEX__DOUBLE.html#o1">im</a>;
01225     }
01226   }
01227 }
01228 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:13 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
