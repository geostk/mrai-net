<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: acrutil.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>acrutil.c</h1><a href="acrutil_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: acrutil.c,v 1.3 2005/09/26 10:20:08 bellet Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00005 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00006 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00007 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00008 <span class="comment">  "http://www.cecill.info". </span>
00009 <span class="comment">  </span>
00010 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00011 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00012 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00013 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00014 <span class="comment">  liability. </span>
00015 <span class="comment">  </span>
00016 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00017 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00018 <span class="comment">  software by the user in light of its specific status of free software,</span>
00019 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00020 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00021 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00022 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00023 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00024 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00025 <span class="comment">  same conditions as regards security. </span>
00026 <span class="comment">  </span>
00027 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00028 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00029 <span class="comment">  </span>
00030 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00031 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00032 <span class="comment">  </span>
00033 <span class="comment">  Version 1.0  05/09/2005</span>
00034 <span class="comment">*************************************************************************/</span>
00035 
00036 <span class="comment">/*************************************************************************</span>
00037 <span class="comment">*                                  * PROJET      : libido</span>
00038 <span class="comment">* NOM DU MODULE : utilacr.c        * TYPE        : fonction</span>
00039 <span class="comment">* AUTEUR        : c.odet           * CREATION    :  07/05/1992</span>
00040 <span class="comment">* VERSION       : 1.0              * REVISION    :  16/06/1992</span>
00041 <span class="comment">* LANGAGE       : C                * </span>
00042 <span class="comment">*                                  *</span>
00043 <span class="comment">**************************************************************************</span>
00044 <span class="comment">*</span>
00045 <span class="comment">*  Description : fonction utilitaires de gestion </span>
00046 <span class="comment">*               du format ACRNEMA modifie UA1216</span>
00047 <span class="comment">*</span>
00048 <span class="comment">*       ACR_ELEMENT *_IdAcrMakeElement(int gr, int nu,int size, long type, long init);</span>
00049 <span class="comment">*       ACR_ELEMENT *_IdAcrAddElement(ACR_ELEMENT *liste,ACR_ELEMENT *elem);</span>
00050 <span class="comment">*       ACR_ELEMENT *_IdAcrFreeListe(ACR_ELEMENT *liste);</span>
00051 <span class="comment">*       ACR_ELEMENT *_IdAcrFindElement(ACR_ELEMENT *liste, int gr, int nu);</span>
00052 <span class="comment">*       _IdAcrAdjustLength(ACR_ELEMENT *liste);</span>
00053 <span class="comment">*       _IdAcrAffListe(ACR_ELEMENT *liste);</span>
00054 <span class="comment">*       _AddHisto(char *l)</span>
00055 <span class="comment"> </span>
00056 <span class="comment">**************************************************************************</span>
00057 <span class="comment">*</span>
00058 <span class="comment">*  MODULES UTILISES :</span>
00059 <span class="comment">*</span>
00060 <span class="comment">**************************************************************************</span>
00061 <span class="comment">*                     |              |</span>
00062 <span class="comment">* REVISIONS :  DATE   | AUTEUR       |  DESCRIPTION</span>
00063 <span class="comment">*---------------------|--------------|------------------------------------</span>
00064 <span class="comment">*       16/06/92      | B. BARBIER   | Insertion LibIDO</span>
00065 <span class="comment">*             /  /    |              |</span>
00066 <span class="comment">*  01/10/92      | B. Barbier   |  V1.2-5 : normalisation des noms</span>
00067 <span class="comment">   15/12/94       JPR      modif fonctions de swap</span>
00068 <span class="comment">   29/01/95 JPR      acceleration rech. ds l'entete</span>
00069 <span class="comment">   12/02/96 JPR      info de Swap</span>
00070 <span class="comment">   7/2/97      JPR      PROBLEME pour les elements 'chaine de caract' :</span>
00071 <span class="comment">               Ils doivent etre alloues </span>
00072 <span class="comment">               AVANT l'appel de IdAcrReadElement</span>
00073 <span class="comment">   10/02/97 JPR      Verif Entete</span>
00074 <span class="comment">   7/3/97      JPR      _IdAcrOverWriteElement, _IdAcrGetElementLength</span>
00075 <span class="comment">   6/5/98      JPR      _IdAcrMergeListes</span>
00076 <span class="comment">   12/5/98     JPR      Modifs pour CardioVasc G.E.</span>
00077 <span class="comment">   19.10.99 JPR      Ajout libelles codes ACR / DICOM</span>
00078 <span class="comment">   12/12/99 JPR      Essai pour ACR curieux sur DEC</span>
00079 <span class="comment">   24-01-2000  FB    Initialisations</span>
00080 <span class="comment">   27-01-2000  JPR      impression offset</span>
00081 <span class="comment">   28-01-2000  JPR      _IdAcrReadElementR</span>
00082 <span class="comment">   21-02-2000  JPR      Modifs pour lire format GE pique sur MORGON</span>
00083 <span class="comment">   12-07-2000  JPR      Modif pour lire images VARIANT</span>
00084 <span class="comment">   05-09-2000  JPR      On ne swappe plus que les UL et les US</span>
00085 <span class="comment">   07-09-2000  JPR       ... et les RET</span>
00086 <span class="comment">   18-9-2000   JPR      Dorenavant, on ne recherche le type du DICOM Element </span>
00087 <span class="comment">                  que pour les groupes pairs</span>
00088 <span class="comment">   20-11-2000  JPR      Prise en compte des types OB OW SQ UN (Explicit VR)</span>
00089 <span class="comment"></span>
00090 <span class="comment"></span>
00091 <span class="comment"></span>
00092 <span class="comment">***********************************************************************/</span>
00093 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00094 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00095 <span class="preprocessor">#include &lt;limits.h&gt;</span>     <span class="comment">// For var_itoa</span>
00096 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00097 
00098 <span class="preprocessor">#include "<a class="code" href="idprint_8h.html">idprint.h</a>"</span>
00099 <span class="preprocessor">#include &lt;string.h&gt;</span>        <span class="comment">// For strlen</span>
00100 
00101 <span class="preprocessor">#include "<a class="code" href="iddicom_8h.html">iddicom.h</a>"</span>
00102 <span class="preprocessor">#include "<a class="code" href="idgen_8h.html">idgen.h</a>"</span>
00103 <span class="preprocessor">#include "<a class="code" href="idima_8h.html">idima.h</a>"</span>
00104 <span class="preprocessor">#include "<a class="code" href="idacr_8h.html">idacr.h</a>"</span>
00105 <span class="preprocessor">#include "<a class="code" href="idacr-restricted_8h.html">idacr-restricted.h</a>"</span>
00106 
00107 <span class="preprocessor">#ifdef WIN32</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#include &lt;winsock.h&gt;</span>    <span class="comment">// Pour ntohs - BigEndianeries -</span>
00109 <span class="preprocessor">#else</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#include &lt;netinet/in.h&gt;</span>    <span class="comment">// Pour ntohs - BigEndianeries -</span>
00111 <span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>
00113 
00114 
00115 <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a21">_IdAcrReadElement</a>      (<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> nu, FILE *fp, <span class="keywordtype">void</span> *buff);
00116 <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a23">_IdAcrOverWriteElement</a> (<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> nu, FILE *fp, <span class="keywordtype">void</span> *buff); 
00117 <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a24">_IdAcrGetElementLength</a> (<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> nu, FILE *fp);
00118 uint32_t <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(FILE*, <span class="keywordtype">int</span> *);
00119 <span class="keywordtype">void</span> * <a class="code" href="acrutil_8c.html#a15">_IdAcrReadElement_avec_creation</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE * fp, <span class="keywordtype">void</span> *buff, <span class="keywordtype">int</span> *lgrTrouvee); 
00120 <span class="keywordtype">int</span>    <a class="code" href="acrutil_8c.html#a16">_IdStrGetDicomTag</a> (<span class="keywordtype">char</span>* libelle, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *gr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *num, <span class="keywordtype">char</span> *vr);
00121 
00122 <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> a);
00123 uint32_t <a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(uint32_t a);
00124 <span class="keywordtype">long</span> <a class="code" href="acrutil_8c.html#a19">_IdAcrOverWriteElementNumber</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE *fp, <span class="keywordtype">int</span> nb); 
00125 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="acrutil_8c.html#a20">_IdAcrModifyElement</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste, <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *elem);
00126 
00127 
00128 
00129 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="acrwrite_8c.html#a0">DEBUG</a>=0;
00130 
00131 <span class="keyword">static</span> <span class="keywordtype">int</span> __cas_de_fou_Philips=0;
00132 
00133 <span class="keyword">static</span> <span class="keywordtype">int</span> sw;  <span class="comment">/* 0 pour pas de swapping </span>
00134 <span class="comment">         3412      nouvelle org. des octets</span>
00135 <span class="comment">                   4321      pour les swapping</span>
00136 <span class="comment">                   2143      de long int               */</span>
00137 
<a name="l00138"></a><a class="code" href="acrutil_8c.html#a3">00138</a> <span class="keywordtype">int</span> <a class="code" href="acrread_8c.html#a15">__TrueDicom</a>;  <span class="comment">/* 1 : contient DICM en 128 */</span>
00139 
<a name="l00140"></a><a class="code" href="acrutil_8c.html#a4">00140</a> <span class="keywordtype">int</span> <a class="code" href="acrread_8c.html#a16">__ExplicitVR</a>; <span class="comment">/* 1 si le type est ecrit a l'interieur des 4 octets contenant la longueur  */</span>
00141 
<a name="l00142"></a><a class="code" href="acrutil_8c.html#a5">00142</a> <span class="keywordtype">int</span> <a class="code" href="acrread_8c.html#a12">__ID_offset</a>;
<a name="l00143"></a><a class="code" href="acrutil_8c.html#a6">00143</a> <span class="keywordtype">int</span> <a class="code" href="acrread_8c.html#a14">__NumeroGroupePrecedent</a>;
00144 <span class="keyword">static</span> <span class="keywordtype">char</span> VR[3];
00145 
00146 <span class="keyword">static</span> <span class="keywordtype">int</span> CardioVasc; <span class="comment">/* 0 pour ACR/DICOM 'normal'   </span>
00147 <span class="comment">           1 pour DICOM CardioVasc  */</span>
00148 
<a name="l00149"></a><a class="code" href="acrutil_8c.html#a9">00149</a> <span class="keywordtype">int</span> <a class="code" href="acrread_8c.html#a13">__Papyrus</a>; <span class="comment">/*   0 pour ACR/DICOM-implicit-VR   </span>
00150 <span class="comment">          1 pour PAPYRUS         */</span>
00151 
<a name="l00152"></a><a class="code" href="acrutil_8c.html#a10">00152</a> <span class="keywordtype">int</span> <a class="code" href="acrread_8c.html#a11">__ID_CardioVascCurieux</a>; <span class="comment">/* 0 pour Normal  (commence par (0008, 0000) */</span>
00153               <span class="comment">/* 1 pour Curieux (commence par (0008, 0005) */</span>
00154               <span class="comment">/* 1 pour Curieux (commence par (0008, 0002) */</span>
00155 
00156 <span class="comment">/* =======================================================================</span>
00157 <span class="comment"> * SWAP_SHORT</span>
00158 <span class="comment"> *    remet les octets dans un ordre compatible avec celui du processeur</span>
00159 <span class="comment"> *    (requiert d'avoir lance CheckSwap AVANT - pas ruse ...-)</span>
00160 <span class="comment"> *  ======================================================================= */</span>
00161 
<a name="l00162"></a><a class="code" href="acrread_8c.html#a19">00162</a> <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> a) {
00163    <span class="keywordflow">if</span> ( (sw==4321)  || (sw==2143) )  
00164       a =(((a&lt;&lt;8) &amp; 0x0ff00) | ((a&gt;&gt;8)&amp;0x00ff));
00165    <span class="keywordflow">return</span> (a);
00166 }
00167 
00168 <span class="comment">/* =======================================================================</span>
00169 <span class="comment"> * SWAP_LONG</span>
00170 <span class="comment"> *    remet les octets dans un ordre compatible avec celui du processeur</span>
00171 <span class="comment"> *    (requiert d'avoir lance CheckSwap AVANT - pas ruse ...-)</span>
00172 <span class="comment"> *  ======================================================================= */</span>
00173 
<a name="l00174"></a><a class="code" href="acrutil_8c.html#a18">00174</a> uint32_t <a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(uint32_t a) {
00175 <span class="comment">/*       ATTENTION: il aura surement un pb pour les entiers negatifs ...</span>
00176 <span class="comment"> *                                                       JPR                   </span>
00177 <span class="comment"> */</span>
00178    <span class="keywordflow">switch</span> (sw) {
00179    <span class="keywordflow">case</span> 4321 :
00180       a=(   ((a&lt;&lt;24) &amp; 0xff000000) | ((a&lt;&lt;8)  &amp; 0x00ff0000)    | 
00181          ((a&gt;&gt;8)  &amp; 0x0000ff00) | ((a&gt;&gt;24) &amp; 0x000000ff) );
00182       <span class="keywordflow">break</span>;
00183    <span class="keywordflow">case</span> 3412 :
00184             a=(   ((a&lt;&lt;16) &amp; 0xffff0000) | ((a&gt;&gt;16) &amp; 0x0000ffff) );
00185       <span class="keywordflow">break</span>;
00186    <span class="keywordflow">case</span> 2143 :
00187       a=(    ((a&lt;&lt;8) &amp; 0xff00ff00) | ((a&gt;&gt;8) &amp; 0x00ff00ff)  );
00188       <span class="keywordflow">break</span>;
00189    <span class="keywordflow">default</span> :
00190       <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n\n\n *******\n erreur code swap ?!?\n\n\n"</span>);
00191       a=0;
00192    }
00193   <span class="keywordflow">return</span>(a);
00194 }
00195 
00196 <span class="comment">/* </span>
00197 <span class="comment">*  =======================================================================</span>
00198 <span class="comment">*</span>
00199 <span class="comment">*  _IdAcrTestSwap</span>
00200 <span class="comment">*</span>
00201 <span class="comment">*  ======================================================================= </span>
00202 <span class="comment">*/</span>
00203 
00204 <span class="keywordtype">int</span>
<a name="l00205"></a><a class="code" href="idacr-restricted_8h.html#a7">00205</a> <a class="code" href="idacr-restricted_8h.html#a7">_IdAcrTestSwap</a>(uint32_t s) {
00206 
00207 <span class="comment">/*                     la valeur de sw montre </span>
00208 <span class="comment"> *                     la nouvelle organisation des octets </span>
00209 <span class="comment"> *                     dans  un long int</span>
00210 <span class="comment"> *                     0 = pas de swap                                </span>
00211 <span class="comment">*/</span>
00212     <span class="keywordflow">switch</span> (s) {
00213    <span class="keywordflow">case</span> 0x00040000 :
00214       sw=3412;
00215       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
00216       <span class="keywordflow">break</span>;
00217    <span class="keywordflow">case</span> 0x04000000 :
00218       sw=4321;
00219       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
00220       <span class="keywordflow">break</span>;
00221    <span class="keywordflow">case</span> 0x00000400 :
00222       sw=2143;
00223       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
00224       <span class="keywordflow">break</span>;
00225    <span class="keywordflow">case</span> 0x00000004 :
00226       sw=0;
00227       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"s : %08x sw : %d\n"</span>,s,sw);
00228       <span class="keywordflow">break</span>;
00229    <span class="keywordflow">default</span> :
00230       sw = -1;
00231              <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (  <span class="stringliteral">"_IdAcrTestSwap (1): Pas trouve "</span>
00232                <span class="stringliteral">"l info de Swap : s= %x -&gt; sw=-1 \n"</span>,s);
00233     }
00234    <span class="keywordflow">return</span> (sw);
00235 }
00236 
00237 <span class="comment">/* =======================================================================</span>
00238 <span class="comment"></span>
00239 <span class="comment">   _IdAcrCheckSwap</span>
00240 <span class="comment">      La seule maniere sure que l'on aie pour determiner </span>
00241 <span class="comment">      si on est en   LITTLE_ENDIAN,       BIG-ENDIAN, </span>
00242 <span class="comment">            BAD-LITTLE-ENDIAN, BAD-BIG-ENDIAN</span>
00243 <span class="comment">      est de trouver l'element qui donne la longueur d'un 'GROUP'</span>
00244 <span class="comment">      (on sait que la longueur de cet element vaut 0x00000004)</span>
00245 <span class="comment">      et de regarder comment cette longueur est codee en memoire  </span>
00246 <span class="comment"></span>
00247 <span class="comment">      Le probleme vient de ce que parfois, il n'y en a pas ...</span>
00248 <span class="comment"></span>
00249 <span class="comment">      On fait alors le pari qu'on a a faire a du LITTLE_ENDIAN propre.</span>
00250 <span class="comment">      Si ce n'est pas le cas, om ne peut rien faire.</span>
00251 <span class="comment"></span>
00252 <span class="comment">      (il faudrait avoir des fonctions auxquelles </span>
00253 <span class="comment">       on passe le codeSwap en parametre, pour faire des essais 'manuels')</span>
00254 <span class="comment"></span>
00255 <span class="comment">   ======================================================================= */</span>
<a name="l00256"></a><a class="code" href="idacr-restricted_8h.html#a8">00256</a> <span class="keywordtype">int</span> <a class="code" href="idacr-restricted_8h.html#a8">_IdAcrCheckSwap</a>(FILE * fp) {
00257 uint32_t  bili2,<a class="code" href="jerror_8h.html#a52a35">x</a>=4;
00258 <span class="keywordtype">char</span> DICM[16];
00259 
00260 <a class="code" href="acrread_8c.html#a13">__Papyrus</a>      = 0;
00261 CardioVasc     = 0;
00262 <a class="code" href="acrread_8c.html#a11">__ID_CardioVascCurieux</a>  = 0;
00263 
00264 <span class="comment">/* On commence par verifier si c'est du DICOM 'actuel' */</span>
00265 <span class="comment">/*                                      -------------  */</span>
00266 
00267 fseek(fp,128L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>); 
00268 fread(&amp;DICM,4,1,fp); 
00269 DICM[4] = 0;
00270 
00271 <span class="keywordflow">if</span>(memcmp(DICM, <span class="stringliteral">"DICM"</span>, (size_t)4) == 0)
00272    {
00273    <a class="code" href="acrread_8c.html#a15">__TrueDicom</a>=1;
00274    <a class="code" href="acrread_8c.html#a12">__ID_offset</a>=132L; <span class="comment">/* a voir ... */</span>
00275    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrCheckSwap : C est du DICOM actuel -&gt;%s&lt;-\n"</span>,DICM);
00276    }
00277    <span class="keywordflow">else</span>
00278    {
00279    <a class="code" href="acrread_8c.html#a15">__TrueDicom</a>=0;
00280    <a class="code" href="acrread_8c.html#a12">__ID_offset</a>=0L;  <span class="comment">/* a voir ... */</span>
00281    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrCheckSwap : Ce n'est PAS du DICOM actuel -&gt;%s&lt;-\n"</span>,DICM); 
00282    }
00283 
00284 <span class="keywordflow">if</span>(<a class="code" href="acrread_8c.html#a15">__TrueDicom</a>)
00285 {
00286 
00287  rewind(fp);
00288  fseek(fp,136L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);<span class="comment">/* on saute le File Preamble (souvent a ZERO) : 128 Octets */</span>
00289           <span class="comment">/* le DICM, et le 0002, 0000                 */</span>
00290 
00291    fread(&amp;DICM,4,1,fp); <span class="comment">/* les 2 premiers octets de la lgr peuvent valoir UL </span>
00292 <span class="comment">            (ou OB si le premier est (0008, 0001)     -&gt; Explicit VR */</span>
00293    <span class="keywordflow">if</span>(memcmp(DICM, <span class="stringliteral">"UL"</span>, (size_t)2) == 0) {
00294    <a class="code" href="acrread_8c.html#a16">__ExplicitVR</a> = 1;
00295    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrCheckSwap : Explicit VR\n"</span>);
00296    } <span class="keywordflow">else</span> {
00297    <a class="code" href="acrread_8c.html#a16">__ExplicitVR</a> = 0;
00298    }
00299 
00300    <span class="keywordflow">if</span> (<a class="code" href="jerror_8h.html#a52a35">x</a>!=(<a class="code" href="jerror_8h.html#a52a35">x</a>)) {  <span class="comment">/* si le HostByteOrder est different du NetworkByteOrder  */</span> 
00301       sw = 0;  <span class="comment">/* on est sur PC ou DEC --&gt; LITTLE-ENDIAN -&gt; Rien a faire */</span>
00302       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"HostByteOrder = NetworkByteOrder\n"</span>);
00303    
00304    } <span class="keywordflow">else</span> {    <span class="comment">/* on est sur une Sun ou une SGI */</span>
00305       sw = 4321;
00306       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"HostByteOrder != NetworkByteOrder\n"</span>);
00307    }
00308 
00309    rewind(fp);                      
00310    fseek(fp,132L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);
00311    <span class="keywordflow">return</span> sw;
00312 
00313 } <span class="comment">/* fin TrueDicom */</span>
00314 
00315 
00316 
00317 <span class="comment">/* -----  SINON ----- */</span>
00318 
00319 
00320    
00321 <span class="comment">/* Si c'est de l'ACR 'propre', la lgr du premier element du groupe est FORCEMENT 4 */</span>
00322                      
00323  fseek(fp,4L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);    <span class="comment">/* SEEK_SET = 0                   */</span>      
00324  fread(&amp;bili2,4,1,fp);     <span class="comment">/* lgr groupe : 0000 0004   JPR   */</span> 
00325    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>( <span class="stringliteral">"_IdAcrCheckSwap (2) : bili2 %08x\n"</span>, bili2);   
00326       
00327  sw=<a class="code" href="idacr-restricted_8h.html#a7">_IdAcrTestSwap</a>(bili2);    
00328 
00329  <a class="code" href="acrread_8c.html#a12">__ID_offset</a>=0;
00330 
00331 <span class="comment">/* Si c'est de l'ACR 'pas propre', il manque la lgr du groupe */</span>
00332                            
00333 <span class="keywordflow">if</span>(sw==-1) 
00334 {                       
00335                            
00336 <span class="comment">/* pour tenter de lire DICOM CardioVasc G.E. */</span>
00337                            
00338     rewind(fp);                           
00339     fseek(fp,136L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);  <span class="comment">/* SEEK_SET = 0                     */</span> 
00340     fread(&amp;bili2,4,1,fp);     <span class="comment">/* lgr groupe : 0000 0004   JPR     */</span> 
00341    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>( <span class="stringliteral">"_IdAcrCheckSwap (3)  : bili2 %08x\n"</span>, bili2);  
00342     sw=<a class="code" href="idacr-restricted_8h.html#a7">_IdAcrTestSwap</a>(bili2);
00343 
00344     <span class="keywordflow">if</span> (sw != -1) 
00345    {
00346 
00347    CardioVasc = 1;                     
00348         rewind(fp);                    
00349         fseek(fp,132L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);
00350    <a class="code" href="acrread_8c.html#a12">__ID_offset</a>=132;
00351    <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n\n\n\n NORMALEMENT, ON NE PASSE PLUS ICI (si c'est le cas, prevenez-moi JPRx)\n"</span>);
00352    <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n\nsw = %d\n\n\n"</span>,sw);
00353    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>( <span class="stringliteral">" &lt;&lt;CardioVasc (ou autre 'curiosite' ...)&gt;&gt;\n"</span>);
00354         }
00355    <span class="keywordflow">else</span>
00356    {     
00357       <span class="comment">/* On n'a pas trouve l'info de swap    28/11/2000 JPR                */</span>
00358       <span class="comment">/* Si c'est du VRAI ACR NEMA  si on est sur une DEC ou un PC swap=0, SUN ou SGI SWAP=4321    */</span>
00359       <span class="comment">/* si c'est du RAW, ca degagera + tard                      */</span>
00360      
00361       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"On force la chance \n"</span>);
00362 
00363       <span class="keywordflow">if</span> (<a class="code" href="jerror_8h.html#a52a35">x</a>!=(<a class="code" href="jerror_8h.html#a52a35">x</a>))  <span class="comment">/* si le HostByteOrder est different du NetworkByteOrder  */</span> 
00364          sw = 0;   <span class="comment">/* on est sur PC ou DEC --&gt; LITTLE-ENDIAN -&gt; Rien a faire */</span>
00365       <span class="keywordflow">else</span>
00366          sw = 4321; <span class="comment">/* on est sur Sun ou SGI */</span>
00367    }
00368 }
00369 
00370 rewind(fp);
00371 <span class="keywordflow">return</span> (sw);
00372 }
00373 
00374 
00375 
00376 <span class="comment">/* =======================================================================</span>
00377 <span class="comment">   int _IdStrGetDicomTag(char * label, int *gr, int * num, char *vr)</span>
00378 <span class="comment"></span>
00379 <span class="comment">                     recherche le Dicom tag d'un libelle donne</span>
00380 <span class="comment">         par inspection du Dictionnaire DICOM</span>
00381 <span class="comment">                          (retourne 0 si pas trouve)                        </span>
00382 <span class="comment">   ======================================================================= */</span>
00383 
<a name="l00384"></a><a class="code" href="acrutil_8c.html#a16">00384</a> <span class="keywordtype">int</span> <a class="code" href="acrutil_8c.html#a16">_IdStrGetDicomTag</a> (<span class="keywordtype">char</span>* libelle, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *gr, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *num, <span class="keywordtype">char</span> *vr) 
00385 {
00386 
00387 <a class="code" href="struct____Dicom____el____.html">DICOM_ELEMENTS</a> *t;
00388 <span class="keywordtype">int</span> i;
00389 
00390 t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>;
00391 
00392 <span class="keywordflow">for</span> (i=0; t[i].<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a> != 0xffff; i++) {
00393    <span class="keywordflow">if</span>( strcmp(t[i].dicom_libelle, libelle) ==0 )
00394 
00395     {
00396       *gr= t[i].<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>;
00397       *num=t[i].dicom_elem;
00398        vr =t[i].dicom_type;
00399       <span class="keywordflow">return</span>(1);
00400    }
00401 }
00402 <span class="keywordflow">return</span>(0);
00403 
00404 }
00405 
00406 <span class="comment">// Converts an integer represented with num_byte bytes within the</span>
00407 <span class="comment">// buffer buff to a string.</span>
00408 <span class="comment">// Refer to comp.lang.faq FAQ, question 12.21 : How can I tell how much</span>
00409 <span class="comment">// destination buffer space I'll need for an arbitrary sprintf call? How can</span>
00410 <span class="comment">// I avoid overflowing the destination buffer with sprintf? </span>
00411 
00412 <span class="keyword">static</span> <span class="keywordtype">char</span> * var_itoa(<span class="keywordtype">void</span> * buff, <span class="keywordtype">int</span> num_byte)
00413 {
00414    <span class="keywordtype">char</span> * retbuf;
00415 
00416    <span class="comment">// We double the recommended value since we also have to deal</span>
00417    <span class="comment">// with long integers. Pfff...</span>
00418    retbuf = malloc(2 * ( (<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * CHAR_BIT + 2) / 3 + 1 + 1));
00419    <span class="keywordflow">switch</span> (num_byte) {
00420    <span class="keywordflow">case</span> 2:
00421       sprintf(retbuf, <span class="stringliteral">"%d"</span>,  *((<span class="keywordtype">int</span>*)buff));
00422       <span class="keywordflow">break</span>;
00423    <span class="keywordflow">case</span> 4:
00424       sprintf(retbuf, <span class="stringliteral">"%dl"</span>, *((<span class="keywordtype">int</span>*)buff));
00425       <span class="keywordflow">break</span>;
00426    <span class="keywordflow">default</span>:
00427       sprintf(retbuf, <span class="stringliteral">"var_itoa?????"</span>);
00428    }
00429    <span class="keywordflow">return</span> retbuf;
00430 }
00431 
00448 <span class="keywordtype">void</span> *
<a name="l00449"></a><a class="code" href="idacr-restricted_8h.html#a22">00449</a> <a class="code" href="idacr-restricted_8h.html#a22">_IdAcrReadElementFromLabel</a>(<span class="keywordtype">char</span> *libelle, FILE * fp, <span class="keywordtype">char</span> * vr, <span class="keywordtype">void</span> *buff) 
00450 { 
00451    <span class="keywordtype">int</span> lgrTrouvee;
00452    <span class="keywordtype">int</span> i;
00453    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> gr;
00454    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;
00455    <span class="keywordtype">char</span> * caster;
00456    
00457    i = <a class="code" href="acrutil_8c.html#a16">_IdStrGetDicomTag</a> (libelle, &amp;gr, &amp;num, vr);
00458    
00459    <span class="keywordflow">if</span> (i == 0) {
00460       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"champ [%s] (%08x , %08x) pas trouve\n"</span>);
00461       caster = malloc(4);
00462       sprintf(caster, <span class="stringliteral">"???"</span>);
00463       <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)caster;
00464       <span class="comment">//return (NULL);</span>
00465    }
00466    buff = <a class="code" href="acrutil_8c.html#a15">_IdAcrReadElement_avec_creation</a>(gr, num, fp, buff, &amp;lgrTrouvee);
00467    <span class="keywordflow">if</span> (lgrTrouvee == 0) {
00468       caster = malloc(4);
00469       sprintf(caster, <span class="stringliteral">"???"</span>);
00470       <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)caster;
00471    }
00472    <span class="keywordflow">if</span> ( (strcmp(vr,<span class="stringliteral">"UL"</span>) != 0)
00473      &amp;&amp; (strcmp(vr,<span class="stringliteral">"US"</span>) != 0)
00474      &amp;&amp; (strcmp(vr,<span class="stringliteral">"SL"</span>) != 0)
00475           &amp;&amp; (strcmp(vr,<span class="stringliteral">"SS"</span>) != 0)
00476      &amp;&amp; (gr != 0x0028 || 
00477       ( num != 0x0005 &amp;&amp; num != 0x0200) ) ) { <span class="comment">// les champs de vr RET sont des caract</span>
00478                           <span class="comment">// sauf (28,5) et (28,200) Pixel Location</span>
00479       <span class="comment">// Buff should contain a string. End the string properly</span>
00480       caster = (<span class="keywordtype">char</span>*)buff;
00481       <span class="comment">// FIXME : in fact we should have written</span>
00482       <span class="comment">// caster[lgrTrouvee + 1] = '\0' but better 'eating' one</span>
00483       <span class="comment">// character than depend on alloaction of buff.</span>
00484       caster[lgrTrouvee] = <span class="charliteral">'\0'</span>;
00485       <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *) buff);
00486    }
00487    <span class="keywordflow">if</span> ( (strcmp(vr, <span class="stringliteral">"US"</span>) == 0)
00488      || (strcmp(vr, <span class="stringliteral">"SS"</span>) == 0) ) {
00489       <span class="comment">// Buff should contain an int16</span>
00490       caster = var_itoa(buff, 2);
00491       <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *) caster);
00492    }
00493         <span class="keywordflow">if</span> ( (strcmp(vr,<span class="stringliteral">"UL"</span>) == 0)
00494           || (strcmp(vr,<span class="stringliteral">"SL"</span>) == 0)
00495           || (gr == 0x0028 &amp;&amp; 
00496       (num == 0x0005  || num == 0x0200) ) ) { <span class="comment">// les champs de vr RET sont des caract</span>
00497                               <span class="comment">// sauf (28,5) et (28,200) Pixel Location</span>
00498   
00499       <span class="comment">// Buff should contain a uint32_t</span>
00500       caster = var_itoa(buff, 2);
00501       <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *) caster);
00502    }
00503    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"impossible de passer ici, mais le compilo rale\n"</span>);
00504    <span class="keywordflow">return</span> (NULL);
00505 
00506 }
00507 
00508 
00509 
00510 
00511 <span class="comment">/* =======================================================================</span>
00512 <span class="comment">   _IdAcrReadElement</span>
00513 <span class="comment"></span>
00514 <span class="comment">                     lit un acr_element et le range dans buff</span>
00515 <span class="comment">                     retourne la taille de l'acr_element </span>
00516 <span class="comment">                          (non lu si buff =0) </span>
00517 <span class="comment">(le fichier doit deja avoir ete ouvert, </span>
00518 <span class="comment">et _IdAcrCheckSwap(FILE * fp) avoir ete appelle)</span>
00519 <span class="comment"></span>
00520 <span class="comment">      ATTENTION : C'est a l'utilisateur de savoir si l'element lu </span>
00521 <span class="comment">            est un entier ou une chaine de caract                         </span>
00522 <span class="comment">   ======================================================================= */</span>
00523 
00524 
<a name="l00543"></a><a class="code" href="acrutil_8c.html#a11">00543</a> <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a21">_IdAcrReadElement</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE * fp, <span class="keywordtype">void</span> *buff)
00544 {
00545 <span class="keywordtype">int</span> lgrTrouvee;
00546 
00547     <a class="code" href="acrutil_8c.html#a15">_IdAcrReadElement_avec_creation</a> (gr, num, fp, buff, &amp;lgrTrouvee);
00548 
00549 <span class="keywordflow">return</span>(lgrTrouvee);
00550 }
00551 
00552 
00553 <span class="comment">/* =======================================================================</span>
00554 <span class="comment">   _IdAcrReadElement_avec_creation</span>
00555 <span class="comment"></span>
00556 <span class="comment">         lit un acr_element</span>
00557 <span class="comment">            le range dans buff s'il est alloue, </span>
00558 <span class="comment">            l'alloue sinon</span>
00559 <span class="comment">         retourne buff dans tous les cas</span>
00560 <span class="comment"></span>
00561 <span class="comment">      ATTENTION : C'est a l'utilisateur de savoir si l'element lu </span>
00562 <span class="comment">            est un entier ou une chaine de caract</span>
00563 <span class="comment"></span>
00564 <span class="comment">   Cette fonction est rendue necessaire, car _IdAcrReadElement, </span>
00565 <span class="comment">   utilisee helas partout, n'alloue pas.</span>
00566 <span class="comment"></span>
00567 <span class="comment">(le fichier doit deja avoir ete ouvert, </span>
00568 <span class="comment">et _IdAcrCheckSwap(FILE * fp) avoir ete appelle)</span>
00569 <span class="comment"></span>
00570 <span class="comment">      </span>
00571 <span class="comment">   ======================================================================= */</span>
00572 
00573 
00574 
<a name="l00595"></a><a class="code" href="acrutil_8c.html#a15">00595</a> <span class="keywordtype">void</span> * <a class="code" href="acrutil_8c.html#a15">_IdAcrReadElement_avec_creation</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE * fp, <span class="keywordtype">void</span> *buff, <span class="keywordtype">int</span> *lgrTrouvee) 
00596 {
00597 
00598 <a class="code" href="struct____Dicom____el____.html">DICOM_ELEMENTS</a> *t = NULL;
00599 uint32_t l, l_gr;
00600 <span class="keywordtype">int</span> flag;
00601 <span class="keywordtype">int</span> skL;
00602 <span class="keywordtype">int</span> cherche_vr=0;
00603 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
00604 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
00605 
00606 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t\t\t\t\trecherche (1) gr %x  num %x (swapping %d)\n"</span>,gr,num,sw); 
00607 
00608 __cas_de_fou_Philips=0;
00609 
00610 l=0;
00611 flag=0;
00612 <span class="keywordflow">while</span>(fread(&amp;g,2,1,fp))
00613    {
00614    <span class="keywordflow">if</span>(sw)g=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)g));
00615    fread(&amp;n,2,1,fp);
00616    <span class="keywordflow">if</span>(sw)n=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)n));
00617    <span class="comment">// Lecture de la longueur de l'element</span>
00618    l = <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(fp, &amp;skL);
00619 
00620 
00621    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"  -------------&gt; gr %x  num %x  long %x : %d\n"</span>,g,n,l,l);    
00622 
00623         <span class="keywordflow">if</span>(gr&gt;g)           <span class="comment">/* on est plus haut que l'element cherche     */</span>
00624             flag=1;    <span class="comment">/* si on ne le trouve pas des le premier coup */</span>
00625                            <span class="comment">/* c'est qu'il n'y est pas        */</span> 
00626            <span class="keywordflow">if</span> (0) <span class="comment">// pour voir si pb de lgr groupe</span>
00627     <span class="comment">/*if((gr&gt;g)&amp;&amp;(n==0)) */</span> <span class="comment">/* on est sur un debut de groupe       */</span>
00628       {
00629       fread(&amp;l_gr,4,1,fp);    <span class="comment">//on lit la longueur du groupe</span>
00630       <span class="keywordflow">if</span>(sw) l_gr = <a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((uint32_t)l_gr));
00631 
00632       fseek(fp,l_gr,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);      <span class="comment">/* on saute le groupe      */</span>
00633 
00634       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)
00635          {
00636          <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"                   on saute au gr sv :%d car\n"</span>,l_gr);
00637          }
00638                }
00639 
00640    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g==gr)&amp;&amp;(n==num))    <span class="comment">/* on est sur l'element recherche   */</span>
00641                                       <span class="comment">/* ------------------------------   */</span>
00642       {
00643       <span class="keywordflow">if</span> (buff == NULL)    <span class="comment">// On alloue, en essayant de ne pas se vautrer ...</span>
00644 
00645          {        <span class="comment">// desole pour la cascade de if,</span>
00646                   <span class="comment">// mais il n'y a pas d'operateur AND THEN en C ... </span>
00647 
00648          <span class="keywordflow">if</span> ( (g/2)*2-g==0 )  <span class="comment">// on ne recherche que pour les groupes pairs</span>
00649           {
00650 
00651             <span class="keywordflow">if</span> ((l==2) ) {
00652                cherche_vr=1;  <span class="comment">// on signale qu'on a deja cherche ds dict. Dicom</span>
00653                   <span class="keywordflow">for</span> (t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>; t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>!=0xffff; t++) {
00654                   <span class="keywordflow">if</span>( (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>==g) &amp;&amp; (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a>==n) ) <span class="keywordflow">break</span>;
00655                }
00656 
00657                <span class="keywordflow">if</span> ( (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"UL"</span>) ==0) 
00658                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"US"</span>) ==0) )
00659                   buff = malloc(2);     <span class="comment">/* on alloue un int 16  */</span>
00660             }
00661             <span class="keywordflow">else</span>     
00662             <span class="keywordflow">if</span> ((l==4) ) {
00663                cherche_vr=1;
00664                   <span class="keywordflow">for</span> (t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>; t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>!=0xffff; t++) {
00665                   <span class="keywordflow">if</span>( (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>==g) &amp;&amp; (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a>==n) ) <span class="keywordflow">break</span>;
00666                }
00667 
00668                <span class="keywordflow">if</span> ( (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SL"</span>) ==0) 
00669                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SS"</span>) ==0) )
00670                buff = malloc(4);       <span class="comment">/* on alloue un int 32  */</span>
00671                }
00672             }
00673                <span class="comment">// On peut esperer que les subtilites c-dessus ne servent jamais...</span>
00674 
00675             buff = malloc(l+1); <span class="comment">// c'est une chaine de caracteres </span>
00676          }
00677 
00678       fread(buff,(<span class="keywordtype">int</span>)l,1,fp);
00679 
00680 
00681       <span class="keywordflow">if</span>(sw) {
00682          <span class="keywordflow">if</span> ( (g/2)*2-g==0 ) { <span class="comment">/* on ne teste pas les groupes impairs */</span>
00683 
00684             <span class="keywordflow">if</span> ((l==4)||(l==2)) {  <span class="comment">/*pour eviter de swapper les chaines </span>
00685 <span class="comment">                     de lgr 2 ou 4 */</span>
00686 
00687                <span class="keywordflow">if</span>(cherche_vr ==0) {  <span class="comment">//si on n'a jamais inspecte le dict. Dicom</span>
00688 
00689                   <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"Consultation Dictionaire DICOM"</span>
00690                            <span class="stringliteral">" g %08x n %08x l %d\n"</span>,g,n,l);
00691                      <span class="keywordflow">for</span> (t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>; t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>!=0xffff; t++) {
00692                      <span class="keywordflow">if</span>( (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>==g) &amp;&amp; (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a>==n) ) <span class="keywordflow">break</span>;
00693                   }
00694                }
00695 
00696                <span class="keywordflow">if</span> ( (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"UL"</span>) ==0) 
00697                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"US"</span>) ==0) 
00698                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SL"</span>) ==0)
00699                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SS"</span>) ==0)  
00700                  || (gr == 0x0028 &amp;&amp; 
00701                   ( num == 0x0005 || num == 0x0200) ) )
00702                 {          <span class="comment">// les champs de vr RET sont des caract</span>
00703                            <span class="comment">// sauf (28,5) et (28,200) Pixel Location</span>
00704 
00705                   <span class="keywordflow">if</span>(l==4) {
00706                        *(uint32_t *) buff=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>  ((*(uint32_t *) buff)); 
00707                   }
00708 
00709                   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l==2)  {
00710                        *(<span class="keywordtype">short</span> *)   buff=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a> ((*(<span class="keywordtype">short</span> *)   buff));
00711                   }
00712 
00713                   <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <span class="keywordflow">if</span> ((l==4)||(l==2)) { <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"on swappe\n"</span>);}
00714                }
00715             } <span class="comment">/* fin if l==2 ==4 */</span>
00716          } <span class="comment">/* fin if g pair */</span>
00717       } <span class="comment">/* fin sw */</span>
00718 
00719    <span class="comment">//return l;</span>
00720    *lgrTrouvee=l;
00721    <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *)buff);
00722    }
00723 
00724    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g&gt;gr)||((gr==g)&amp;&amp;(n&gt;num)))     <span class="comment">/* on a depasse l'element */</span>
00725                   <span class="comment">/* ---------------------- */</span>
00726       {
00727       <span class="keywordflow">if</span> ( g &gt; 0xff00 ) { <span class="comment">// on est dans le cas de fou Philips </span>
00728                 <span class="comment">// ou des Tags ne sont pas dans l'ordre</span>
00729             <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t\t\t\t\t\t =============Tags pas dans l'ordre (cas de fou) "</span>
00730                      <span class="stringliteral">" gr %04x %d g %04x %d\n"</span>,gr,gr,g,g);
00731             __cas_de_fou_Philips=1;
00732             fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
00733       } <span class="keywordflow">else</span> {
00734    
00735          <span class="keywordflow">if</span>(flag)            <span class="comment">/*on a deja re-essaye depuis le debut */</span>
00736             {           <span class="comment">/* l'element cherche n'y est pas      */</span>
00737             fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);<span class="comment">/*on se positionne sur l'element sv */</span>
00738             *lgrTrouvee=0;
00739             <span class="keywordflow">return</span>((<span class="keywordtype">void</span> *)NULL);    <span class="comment">/*  On sort                JPR      */</span>
00740             } 
00741                     
00742          rewind(fp);
00743          <span class="keywordflow">if</span> ((CardioVasc == 1) || (<a class="code" href="acrread_8c.html#a15">__TrueDicom</a> == 1))
00744                fseek(fp,132L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>); <span class="comment">/* pour CardioVasc G.E. ??? a revoir */</span>
00745 
00746          flag=1;           <span class="comment">/* On va re-essayer depuis le debut  */</span>
00747          }
00748       }
00749 
00750    <span class="keywordflow">else</span> {                           <span class="comment">/* on saute a l'element suivant      */</span>
00751                      <span class="comment">/* ----------------------------      */</span>
00752       fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
00753              }
00754    }
00755 <span class="comment">//</span>
00756 *lgrTrouvee=0;
00757 <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *)NULL);
00758 }
00759 
00760 
00761 
00762 <span class="comment">/* =======================================================================</span>
00763 <span class="comment">   _IdAcrReadNextElement</span>
00764 <span class="comment"></span>
00765 <span class="comment">                     lit l'acr_element courant </span>
00766 <span class="comment"></span>
00767 <span class="comment">  mode= 1 : on charge EGALEMENT les Elements 'longs' (&gt;5000) ,</span>
00768 <span class="comment">        0 : on NE CHARGE PAS    les Elements 'longs' (&gt;5000) ,  </span>
00769 <span class="comment"></span>
00770 <span class="comment">(le fichier doit deja avoir ete ouvert, </span>
00771 <span class="comment">et _IdAcrCheckSwap(FILE * fp) avoir ete appelle)</span>
00772 <span class="comment"></span>
00773 <span class="comment">                  </span>
00774 <span class="comment">   ======================================================================= */</span>
00775 
00776 
<a name="l00793"></a><a class="code" href="idacr-restricted_8h.html#a14">00793</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> * <a class="code" href="idacr-restricted_8h.html#a14">_IdAcrReadNextElement</a>(FILE *fp, <span class="keywordtype">int</span> mode) 
00794 {
00795 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
00796 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
00797 uint32_t l;
00798 uint32_t type=0;
00799 <span class="keywordtype">int</span> skL;
00800 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
00801 <a class="code" href="struct____Dicom____el____.html">DICOM_ELEMENTS</a> *t;
00802 <span class="keywordtype">char</span> * buff = NULL;
00803 
00804    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" ===&gt; entree ds _IdAcrReadNextElement\n"</span>);
00805    fread(&amp;g,2,1,fp);
00806    <span class="keywordflow">if</span> (feof(fp))   {<span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"_IdAcrReadNextElement : eof trouve\n"</span>);<span class="keywordflow">return</span> (NULL);}
00807    <span class="keywordflow">if</span> (ferror(fp)) {           <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"echec lecture NumGr\n"</span>);               <span class="keywordflow">return</span> (NULL);}
00808 
00809    <span class="keywordflow">if</span> (sw)          g=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)g));
00810 <span class="comment">/*</span>
00811 <span class="comment">   if (g &lt; __NumeroGroupePrecedent) {</span>
00812 <span class="comment">      IdPrintf("Gros malaise : num de groupe pas dans l'ordre : (%04x) apres (%04x)\n",g, __NumeroGroupePrecedent );</span>
00813 <span class="comment">   }</span>
00814 <span class="comment">*/</span>
00815    <a class="code" href="acrread_8c.html#a14">__NumeroGroupePrecedent</a> =g;
00816 
00817    fread(&amp;n,2,1,fp);
00818    <span class="keywordflow">if</span> (ferror(fp)) {<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"echec lecture NumElem\n"</span>);<span class="keywordflow">return</span> (NULL);}
00819    <span class="keywordflow">if</span> (feof(fp))   {<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"echec lecture NumElem\n"</span>);<span class="keywordflow">return</span> (NULL);}
00820 
00821    <span class="keywordflow">if</span>(sw)n=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)n));
00822 
00823    <span class="comment">// Lecture de la longueur de l'element</span>
00824 
00825    l = <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(fp,&amp;skL);
00826 
00827    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <span class="keywordflow">if</span> (n!=0) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"_IdAcrReadNextElement : "</span>
00828                <span class="stringliteral">" gr %x\tnum %x\tlong %x (%d)"</span>,
00829                g,n,l,l); 
00830 
00831    <span class="keywordflow">if</span> (l &lt; 5000 || mode ==1)
00832    {
00833    buff=malloc(l+1);
00834    buff[l]=0;
00835       
00836    <span class="keywordflow">if</span>(buff) fread(buff,(<span class="keywordtype">int</span>)l,1,fp);
00837    <span class="keywordflow">if</span> (ferror(fp)) {<a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"echec lecture Element\n"</span>);<span class="keywordflow">return</span> (NULL);}
00838    <span class="keywordflow">if</span> (feof(fp))   {<a class="code" href="kerprint_8c.html#a5">IdErrPrintf</a>(<span class="stringliteral">"echec lecture Element\n"</span>);<span class="keywordflow">return</span> (NULL);}
00839 
00840    <span class="keywordflow">if</span> ((n==0) &amp;&amp; sw)  *(uint32_t *) buff=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>  ((*(uint32_t *) buff)); <span class="comment">// n=0 : lgr du groupe </span>
00841    <span class="keywordflow">else</span>
00842       <span class="keywordflow">if</span>(sw) {
00843           <span class="keywordflow">if</span> ( (g/2)*2-g==0) { <span class="comment">/* on ne teste pas les groupes impairs */</span>
00844          <span class="comment">// if (1) { // on teste MEME les groupes impairs ...</span>
00845 
00846             <span class="keywordflow">if</span> ((l==4)||(l==2)) {   <span class="comment">//pour eviter d'explorer de Dict. DICOM</span>
00847                               <span class="comment">// dans le cas de  chaines </span>
00848                               <span class="comment">// de lgr 2 ou 4 </span>
00849                <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"Consultation Dictionary DICOM g %04x n %0xx l %d\n"</span>,g,n,l);
00850 
00851                   <span class="keywordflow">for</span> (t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>; t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>!=0xffff; t++) {
00852                   <span class="keywordflow">if</span>( (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>==g) &amp;&amp; (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a>==n) ) <span class="keywordflow">break</span>;
00853                }
00854                <span class="keywordflow">if</span> ( (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"UL"</span>) ==0) 
00855                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"US"</span>) ==0)
00856                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SL"</span>) ==0) 
00857                  || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SS"</span>) ==0) 
00858                        || (g == 0x0028 &amp;&amp; 
00859                   ( n == 0x0005 || n == 0x0200) )  ) { <span class="comment">// seuls (28,5) de vr RET</span>
00860                                   <span class="comment">//  et (28,200) sont des entiers</span>
00861 
00862                   <span class="keywordflow">if</span>(l==4) 
00863                        *(uint32_t *) buff=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>  ((*(uint32_t *) buff)); 
00864                   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(l==2) 
00865                        *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)   buff=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a> ((*(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)   buff));
00866                }
00867             } <span class="comment">/* fin if l==2 ==4 */</span>
00868          } <span class="comment">/* fin if g pair */</span>
00869       } <span class="comment">/* fin sw */</span>
00870 
00871 
00872    <span class="keywordflow">switch</span> (l) {
00873       <span class="keywordflow">case</span> 2:  type = <a class="code" href="idacr_8h.html#a1">BI</a>; <span class="keywordflow">break</span>;
00874       <span class="keywordflow">case</span> 4:  type = <a class="code" href="idacr_8h.html#a2">BD</a>; <span class="keywordflow">break</span>;
00875       <span class="keywordflow">default</span>: <span class="keywordflow">if</span>(l&gt;5000) type=<a class="code" href="idacr_8h.html#a0">NO</a>; <span class="keywordflow">else</span> type = <a class="code" href="idacr_8h.html#a4">AT</a>;
00876    }
00877 
00878    } <span class="comment">/* fin (l &lt; 5000 || mode ==1) */</span>
00879 
00880    <span class="keywordflow">else</span>
00881    {
00882    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" --&gt; Element too long. Skipped\n"</span>);
00883         fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
00884    }
00885 
00886 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) 
00887    {
00888    <span class="keywordflow">if</span> (n==0) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"   gr %x\tnum %x\tlong %d lgr_grp = %d\n"</span>,
00889                g,n,l,*(uint32_t *) buff);
00890 
00891    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l==2) {  ((<span class="keywordtype">char</span> *)buff)[2]=0; 
00892             <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t\t[%s]  \tval = %d \tx(%04x)\n"</span>, 
00893             buff, *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> *) buff, *(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> *) buff); 
00894          }
00895 
00896    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l==4) {  ((<span class="keywordtype">char</span> *)buff)[4]=0; 
00897             <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t\t[%s]  \tval = %d \tx(%08x)\n"</span>, 
00898             buff, *(uint32_t *) buff     , *(uint32_t *) buff); 
00899          }
00900 
00901    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l&lt;5000 ) 
00902          {
00903             ((<span class="keywordtype">char</span> *)buff)[l]=0;
00904             <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t\t[%s]\n"</span>, (<span class="keywordtype">char</span> *)buff);
00905          }
00906    
00907    <span class="keywordflow">else</span> <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" --&gt; Element too long. Not Printed\n"</span>);
00908    }
00909 
00910 <span class="keywordflow">if</span>((p=(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *)calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a>)))!=0) 
00911 
00912    {
00913    p-&gt;<a class="code" href="structacr__element.html#o0">group</a>= (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>)g;
00914    p-&gt;<a class="code" href="structacr__element.html#o1">number</a>=(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span>)n;
00915    p-&gt;<a class="code" href="structacr__element.html#o2">length</a>=(uint32_t)l;
00916    p-&gt;<a class="code" href="structacr__element.html#o3">skippedLength</a>=(uint32_t)skL; <span class="comment">/* pour AffListe2 */</span>
00917    p-&gt;<a class="code" href="structacr__element.html#o6">type</a>=  type;
00918    p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=  0;
00919    p-&gt;<a class="code" href="structacr__element.html#o4">value</a>= (<span class="keywordtype">long</span> <span class="keywordtype">int</span>)(buff);
00920    }
00921      <span class="keywordflow">else</span>
00922    <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"PB allocation memoire ACR_ELEMENT\n"</span>);
00923 
00924 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" ===&gt; sortie de _IdAcrReadNextElement\n"</span>);
00925 
00926 <span class="keywordflow">return</span>(p);
00927 
00928 }
00929 
00930 <span class="comment">/* =======================================================================</span>
00931 <span class="comment">   _IdAcrGetElementLength</span>
00932 <span class="comment"></span>
00933 <span class="comment">                     Recherche un acr_element et renvoie sa longueur</span>
00934 <span class="comment">                          (0 si pas trouve)   </span>
00935 <span class="comment"></span>
00936 <span class="comment">(le fichier doit deja avoir ete ouvert, </span>
00937 <span class="comment">et _IdAcrCheckSwap(FILE * fp) avoir ete appelle)</span>
00938 <span class="comment"></span>
00939 <span class="comment">                     </span>
00940 <span class="comment">   ======================================================================= */</span>
00941 
<a name="l00955"></a><a class="code" href="acrutil_8c.html#a13">00955</a> <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a24">_IdAcrGetElementLength</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE *fp) 
00956 {
00957 uint32_t l, l_gr;
00958 <span class="keywordtype">int</span> flag;
00959 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
00960 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
00961 <span class="keywordtype">int</span> skL;
00962 
00963 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"recherche (2) gr %x  num %x (swapping %d)\n"</span>,gr,num,sw); 
00964 
00965 l=0;
00966 flag=0;
00967 <span class="keywordflow">while</span>(fread(&amp;g,2,1,fp))
00968    {
00969    <span class="keywordflow">if</span>(sw)g=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)g));
00970    fread(&amp;n,2,1,fp);
00971    <span class="keywordflow">if</span>(sw)n=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)n));
00972    l = <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(fp,&amp;skL);
00973 
00974 
00975    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"  -------------&gt; gr %x  num %x  long %x : %d\n"</span>,g,n,l,l);    
00976 
00977         <span class="keywordflow">if</span>(gr&gt;g)           <span class="comment">/* on est plus haut que l'element cherche      */</span>
00978             flag=1;    <span class="comment">/* si on ne le trouve pas des le premier coup  */</span>
00979                            <span class="comment">/* c'est qu'il n'y est pas          JPR        */</span>            
00980    <span class="keywordflow">if</span>((gr&gt;g)&amp;&amp;(n==0))  <span class="comment">/* on est sur un debut de groupe   JPR        */</span>
00981       {
00982 
00983       fread(&amp;l_gr,4,1,fp);    <span class="comment">//on lit la longueur du groupe</span>
00984       <span class="keywordflow">if</span>(sw) l_gr = <a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((uint32_t)l_gr));
00985 
00986       fseek(fp,l_gr,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
00987       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"                   on saute au gr sv :%d car\n"</span>,l_gr);        
00988                 }
00989 
00990    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g==gr)&amp;&amp;(n==num))    <span class="comment">/* on est sur l'element recherche   */</span>
00991                                       <span class="comment">/* ------------------------------   */</span>
00992       {
00993       <span class="keywordflow">return</span> l;      <span class="comment">/* on renvoie sa longueur  */</span>
00994       }
00995 
00996    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g&gt;gr)||((gr==g)&amp;&amp;(n&gt;num)))     <span class="comment">/* on a depasse l'element */</span>
00997       {
00998       <span class="keywordflow">if</span>(flag)            <span class="comment">/*on a deja re-essaye depuis le debut */</span>
00999          {           <span class="comment">/* l'element cherche n'y est pas      */</span>
01000          fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);<span class="comment">/*on se positionne sur l'element sv */</span>
01001          <span class="keywordflow">return</span>(0);    <span class="comment">/*  On sort                JPR      */</span>
01002          }                      
01003       fseek(fp,l,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);
01004       flag=1;       <span class="comment">/* On va re-essayer depuis le debut  */</span>
01005 
01006       <span class="keywordflow">if</span> ((CardioVasc == 1) || (<a class="code" href="acrread_8c.html#a15">__TrueDicom</a> == 1))
01007             fseek(fp,132L,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>); <span class="comment">/* pour CardioVasc G.E. */</span>
01008 
01009       }
01010 
01011    <span class="keywordflow">else</span> {                       <span class="comment">/* on saute a l'element suivant      */</span>
01012       fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01013              }
01014    }
01015 <span class="keywordflow">return</span>(0);
01016 }
01017 
01018 
01019 <span class="comment">/* ======================================================================= </span>
01020 <span class="comment">*  _IdAcrRecupLgr</span>
01021 <span class="comment">*</span>
01022 <span class="comment">*  ACR-NEMA :  On a toujours </span>
01023 <span class="comment">*           GroupNumber   (2 Octets) </span>
01024 <span class="comment">*           ElementNumber (2 Octets) </span>
01025 <span class="comment">*           ElementSize   (4 Octets)</span>
01026 <span class="comment">*</span>
01027 <span class="comment">*</span>
01028 <span class="comment">*  DICOM :     On peut avoir (implicit Value Representation)</span>
01029 <span class="comment">*           GroupNumber   (2 Octets) </span>
01030 <span class="comment">*           ElementNumber (2 Octets) </span>
01031 <span class="comment">*           ElementSize   (4 Octets)</span>
01032 <span class="comment">*</span>
01033 <span class="comment">*        On peut avoir (explicit Value Representation)</span>
01034 <span class="comment">*           GroupNumber         (2 Octets) </span>
01035 <span class="comment">*           ElementNumber       (2 Octets) </span>
01036 <span class="comment">*           ValueRepresentation (2 Octets) </span>
01037 <span class="comment">*           ElementSize         (2 Octets)</span>
01038 <span class="comment">*</span>
01039 <span class="comment">*        ATTENTION : dans le cas ou ValueRepresentation = OB, OW, SQ, UN</span>
01040 <span class="comment">*           GroupNumber         (2 Octets) </span>
01041 <span class="comment">*           ElementNumber       (2 Octets) </span>
01042 <span class="comment">*           ValueRepresentation (2 Octets)</span>
01043 <span class="comment">*           zone reservee       (2 Octets) </span>
01044 <span class="comment">*           ElementSize         (4 Octets)</span>
01045 <span class="comment">*</span>
01046 <span class="comment">*</span>
01047 <span class="comment">*   ======================================================================= */</span>
<a name="l01060"></a><a class="code" href="acrread_8c.html#a17">01060</a> uint32_t <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(FILE *fp, <span class="keywordtype">int</span> *skippedLength)
01061 {
01062 uint32_t l_gr; 
01063 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> l_gr_2;
01064 <span class="keywordtype">int</span> i, trouve;
01065 
01066 <span class="comment">/*</span>
01067 <span class="comment">*</span>
01068 <span class="comment">*   ATTENTION :</span>
01069 <span class="comment">*</span>
01070 <span class="comment">* c'est TRES gorret</span>
01071 <span class="comment">* mais je n'ai pas le temps d'inventer qq chose de propre :-(</span>
01072 <span class="comment">*</span>
01073 <span class="comment">*/</span>
01074 
01075 <span class="keywordtype">int</span> nbCode=26; <span class="comment">// nombre d'elements dans la table de type DICOM_VR definie dans dicom.c</span>
01076 
01077 
01078   <span class="keywordflow">if</span> (<a class="code" href="acrread_8c.html#a16">__ExplicitVR</a> == 1) {
01079 
01080    fread(VR,2,1,fp);
01081    VR[2]=0;
01082 
01083 <span class="comment">// ATTENTION :</span>
01084 <span class="comment">// Ce n'est pas parce qu'on a trouve UL la premiere fois qu'on respecte </span>
01085 <span class="comment">// Explicit VR tout le temps</span>
01086 <span class="comment">// (cf e=film ...)</span>
01087 <span class="comment">// A completer par le test de ttes les valeurs possibles :-(</span>
01088 
01089    <span class="keywordflow">for</span>(i=0,trouve=0;i&lt;nbCode;i++) {
01090       <span class="comment">//printf(" %d , %s\n", i,_ID_dicom_vr[i].dicom_VR);</span>
01091       <span class="keywordflow">if</span>(memcmp(<a class="code" href="dicom_8c.html#a2">_ID_dicom_vr</a>[i].dicom_VR,VR,(size_t)2)==0) {
01092          trouve=1;
01093          <span class="keywordflow">break</span>;
01094       }
01095    }
01096 
01097    <span class="keywordflow">if</span> ( trouve == 0) {
01098 
01099       <span class="comment">// On est mal : implicit VR repere</span>
01100       <span class="comment">// mais ce n'est pas un code connu ...</span>
01101       <span class="comment">// On reconstitue la longueur</span>
01102       
01103       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"Explicit VR, mais pas trouve de code connu\n"</span>);
01104       memcpy(&amp;l_gr, VR,(size_t)2);
01105       fread( ((<span class="keywordtype">char</span>*)&amp;l_gr)+2,2,1,fp);
01106       <span class="keywordflow">if</span>(sw) l_gr = <a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((uint32_t)l_gr));
01107       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"lgr deduite : %08x , %d\n"</span>,l_gr,l_gr);
01108       
01109       <span class="keywordflow">if</span> ( (<span class="keywordtype">int</span>)l_gr == -1) {
01110          l_gr=0;
01111       }
01112       *skippedLength = 4; 
01113       <span class="keywordflow">return</span>(l_gr);
01114    }
01115 
01116    <span class="comment">// On repart dans la sequence 'sensee'</span>
01117 
01118    <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"VR : [%01x , %01x] en position %d du tableau\n"</span>, VR[0],VR[1],i);
01119    <span class="comment">//printf(" %d , %s\n", i,_ID_dicom_vr[i].dicom_VR);</span>
01120    <span class="keywordflow">if</span> (  
01121       (!memcmp( VR,<span class="stringliteral">"OB"</span>,(size_t)2 )) || 
01122       (!memcmp( VR,<span class="stringliteral">"OW"</span>,(size_t)2 )) || 
01123       (!memcmp( VR,<span class="stringliteral">"SQ"</span>,(size_t)2 )) ||
01124       (!memcmp( VR,<span class="stringliteral">"UN"</span>,(size_t)2 )) ) {
01125 
01126    <span class="comment">// les 2 octets suivants sont reserves</span>
01127 
01128       <span class="keywordflow">if</span>(<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"les 2 octets suivants sont reserves\n"</span>);
01129       fread(VR,2,1,fp);    <span class="comment">//on les saute</span>
01130       fread(&amp;l_gr,4,1,fp); <span class="comment">//on lit la lgr sur QUATRE octets</span>
01131       <span class="keywordflow">if</span>(sw) l_gr = <a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((uint32_t)l_gr));
01132       *skippedLength = 8;
01133 
01134    } <span class="keywordflow">else</span> {
01135       fread(&amp;l_gr_2,2,1,fp);  <span class="comment">//on lit la lgr sur DEUX octets</span>
01136       <span class="keywordflow">if</span>(sw) l_gr_2 = <a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)l_gr_2);
01137       
01138       <span class="keywordflow">if</span> ( l_gr_2 == 0xffff) {
01139          l_gr = 0;   
01140       } <span class="keywordflow">else</span> {
01141          l_gr = l_gr_2;
01142       }
01143       *skippedLength = 4;
01144    }  
01145   } <span class="keywordflow">else</span> {  <span class="comment">// Explicit VR = 0   </span>
01146 
01147    fread(&amp;l_gr,4,1,fp); <span class="comment">//on lit la lgr sur QUATRE octets</span>
01148    <span class="keywordflow">if</span>(sw)l_gr=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((<span class="keywordtype">long</span>)l_gr));
01149    *skippedLength = 4;
01150   }
01151    
01152 <span class="keywordflow">if</span> (l_gr == 0xffffffff) 
01153    l_gr = 0;
01154 
01155 <span class="keywordflow">return</span>(l_gr);
01156 }
01157 
01158 
01159 
01160 
01161 <span class="comment">/* ===============================================</span>
01162 <span class="comment">*</span>
01163 <span class="comment">*</span>
01164 <span class="comment">*            ATTENTION :</span>
01165 <span class="comment">*        Les trois fonctions qui suivent NE MARCHENT PAS</span>
01166 <span class="comment">*        pour du DICOM en Explicit Value Representation</span>
01167 <span class="comment">*        La VRAIE solution sera de faire un VRAI DICOM writer (?!)</span>
01168 <span class="comment">*</span>
01169 <span class="comment"> ================================================= */</span>
01170 
01171 
01172 
01173 
01174 
01175 <span class="comment">/* =======================================================================</span>
01176 <span class="comment">   _IdAcrOverWriteElementNumber</span>
01177 <span class="comment"></span>
01178 <span class="comment">   Remplace le numero d'un acr_element existant par une valeur donnee</span>
01179 <span class="comment">   (0 si pas trouve) </span>
01180 <span class="comment">   A MANIER AVEC PRECAUTION</span>
01181 <span class="comment"></span>
01182 <span class="comment">   ATTENTION : le fichier doit avoir ete ouvert en ID_RFILE_P_BIN ...  (rb+)                        </span>
01183 <span class="comment">   ======================================================================= */</span>
01184 
<a name="l01185"></a><a class="code" href="acrutil_8c.html#a19">01185</a> <span class="keywordtype">long</span> <a class="code" href="acrutil_8c.html#a19">_IdAcrOverWriteElementNumber</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE *fp, <span class="keywordtype">int</span> nb) 
01186 {
01187 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
01188 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
01189 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> numero;
01190 
01191 uint32_t l, l_gr;
01192 <span class="keywordtype">int</span> flag;
01193 <span class="keywordtype">int</span> i, skL;
01194 numero=nb; <span class="comment">/* on passe en USHORT */</span>
01195 
01196 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"recherche (3) gr %x  num %x (swapping %d)\n"</span>,gr,num,sw); 
01197 
01198 l=0;
01199 flag=0;
01200 <span class="keywordflow">while</span>(fread(&amp;g,2,1,fp))
01201    {
01202    <span class="keywordflow">if</span>(sw)g=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)g));
01203    fread(&amp;n,2,1,fp);
01204    <span class="keywordflow">if</span>(sw)n=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)n));
01205    l = <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(fp,&amp;skL);
01206 
01207 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"  -------------&gt; gr %x  num %x  long %x : %d\n"</span>,g,n,l,l);    
01208 
01209         <span class="keywordflow">if</span>(gr&gt;g)           <span class="comment">/* on est plus haut que l'element cherche      */</span>
01210             flag=1;    <span class="comment">/* si on ne le trouve pas des le premier coup  */</span>
01211                            <span class="comment">/* c'est qu'il n'y est pas          JPR        */</span>            
01212    <span class="keywordflow">if</span>((gr&gt;g)&amp;&amp;(n==0))  <span class="comment">/* on est sur un debut de groupe   JPR        */</span>
01213       {
01214       fread(&amp;l_gr,4,1,fp);
01215       <span class="keywordflow">if</span>(sw)l_gr=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((<span class="keywordtype">long</span>)l_gr)); <span class="comment">/* on lit sa longueur */</span>
01216       fseek(fp,l_gr,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01217       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"                   on saute au gr sv :%d car\n"</span>,l_gr);
01218       <span class="keywordflow">return</span>(0);        
01219              }
01220 
01221    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g==gr)&amp;&amp;(n==num))    <span class="comment">/* on est sur l'element recherche   */</span>
01222                                       <span class="comment">/* ------------------------------   */</span>
01223       {
01224          <span class="comment">/* on se repositionne sur le numero Element */</span>
01225          <span class="comment">/* ATTENTION : ne marchera pas pour les Explicit VR skL !=4 ... */</span>
01226          <span class="comment">/* a rectifier                      */</span>
01227       fseek(fp, -6, <a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01228 
01229       <span class="keywordflow">if</span>(sw)numero=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)numero)); <span class="comment">/* A VOIR ... du VRAI DICOM est tjs en littleEndian */</span>
01230 
01231       <span class="keywordflow">for</span> (i=0;i&lt;2;i++) {
01232          putc( ((<span class="keywordtype">char</span> *)&amp;numero)[i] , fp);
01233       }
01234       
01235       <span class="keywordflow">return</span> l;
01236       }
01237 
01238    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g&gt;gr)||((gr==g)&amp;&amp;(n&gt;num)))     <span class="comment">/* on a depasse l'element */</span>
01239       {
01240       <span class="keywordflow">if</span>(flag)            <span class="comment">/*on a deja re-essaye depuis le debut */</span>
01241          {           <span class="comment">/* l'element cherche n'y est pas      */</span>
01242          fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);<span class="comment">/*on se positionne sur l'element sv */</span>
01243          <span class="keywordflow">return</span>(0);    <span class="comment">/*  On sort                JPR      */</span>
01244          }                      
01245       fseek(fp,l,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);
01246       flag=1;       <span class="comment">/* On va re-essayer depuis le debut  */</span>
01247       }
01248    <span class="keywordflow">else</span> {                       <span class="comment">/* on saute a l'element suivant      */</span>
01249       fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01250              }
01251    }
01252 <span class="keywordflow">return</span>(0);
01253 }
01254 
01255 <span class="comment">/* =======================================================================</span>
01256 <span class="comment">   _IdAcrOverWriteElement</span>
01257 <span class="comment"></span>
01258 <span class="comment">   Ecrase un acr_element existant par une valeur prise dans dans buff</span>
01259 <span class="comment">   retourne la taille de l'acr_element qui a ete remplace</span>
01260 <span class="comment">   (0 si pas trouve) </span>
01261 <span class="comment"></span>
01262 <span class="comment">   ATTENTION : le fichier doit avoir ete ouvert en ID_RFILE_P_BIN ...  (rb+) </span>
01263 <span class="comment"></span>
01264 <span class="comment">   ATTENTION : Un probleme majeur risque de se poser avec les int32 et les int16</span>
01265 <span class="comment">         (la question du swap en ecriture n'a pas ete traitee)</span>
01266 <span class="comment"></span>
01267 <span class="comment">       DONC : pour le moment, se limiter aux chaines de caracteres </span>
01268 <span class="comment"></span>
01269 <span class="comment">      ATTENTION :    pour des raisons non encore elucidees,</span>
01270 <span class="comment">            Si la lgr est superieure a celle sur disque</span>
01271 <span class="comment">            malgre les precautions prises</span>
01272 <span class="comment">            ca se passe MAL                      </span>
01273 <span class="comment">   ======================================================================= */</span>
01274 
<a name="l01275"></a><a class="code" href="acrutil_8c.html#a12">01275</a> <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a23">_IdAcrOverWriteElement</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE *fp, <span class="keywordtype">void</span> *buff) 
01276 
01277 {
01278 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
01279 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
01280 <span class="keywordtype">long</span> l, l_gr, ptr;
01281 <span class="keywordtype">int</span> flag, skL;
01282 <span class="keywordtype">int</span> i;
01283 <span class="keywordtype">int</span> retCode;
01284 
01285 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"_IdAcrOverWriteElement :recherche (4) gr %x  num %x (swapping %d)\n"</span>,gr,num,sw); 
01286 
01287 l=0;
01288 flag=0;
01289 <span class="keywordflow">while</span>(fread(&amp;g,2,1,fp))
01290    {
01291    <span class="keywordflow">if</span>(sw)g=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)g));
01292    fread(&amp;n,2,1,fp);
01293    <span class="keywordflow">if</span>(sw)n=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)n));
01294    <span class="comment">// Lecture de la longueur de l'element</span>
01295    l = <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(fp, &amp;skL);
01296    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"  _IdAcrOverWriteElement-------------&gt; gr %x  num %x  long %x : %d\n"</span>,g,n,l,l);    
01297 
01298         <span class="keywordflow">if</span>(gr&gt;g)           <span class="comment">/* on est plus haut que l'element cherche      */</span>
01299             flag=1;    <span class="comment">/* si on ne le trouve pas des le premier coup  */</span>
01300                            <span class="comment">/* c'est qu'il n'y est pas          JPR        */</span> 
01301    <span class="keywordflow">if</span> (0)           
01302    <span class="comment">/*if((gr&gt;g)&amp;&amp;(n==0))*/</span>  <span class="comment">/* on est sur un debut de groupe   JPR        */</span>
01303       {
01304       fread(&amp;l_gr,4,1,fp);
01305       <span class="keywordflow">if</span>(sw)l_gr=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((<span class="keywordtype">long</span>)l_gr)); <span class="comment">/* on lit sa longueur */</span>
01306       fseek(fp,l_gr,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01307       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"                   on saute au gr sv :%d car\n"</span>,l_gr);        
01308              }
01309 
01310    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g==gr)&amp;&amp;(n==num))    <span class="comment">/* on est sur l'element recherche   */</span>
01311                                       <span class="comment">/* ------------------------------   */</span>
01312       {
01313       <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"_IdAcrOverWriteElement-------------------------on re-ecrit (%04x,%04x) lgr %d\n"</span>,g,n,l); 
01314 
01315       fgetpos(fp,(fpos_t *)&amp;ptr);
01316       fsetpos(fp,(fpos_t *)&amp;ptr);
01317        
01318       <span class="keywordflow">for</span> (i=0;i&lt;l;i++)
01319          {<span class="comment">// printf("%d %c\n", i,((char *)buff)[i]);</span>
01320          retCode=fputc(((<span class="keywordtype">char</span> *)buff)[i],fp);
01321          <span class="comment">//printf("%d %08x\n",retCode,retCode);</span>
01322          <span class="keywordflow">if</span>(retCode == EOF) {
01323             <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"Erreur re-ecriture\n"</span>);
01324             <span class="keywordflow">switch</span>(errno) {
01325                <span class="keywordflow">case</span> EAGAIN : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"EAGAIN\n"</span>); <span class="keywordflow">break</span>;
01326                <span class="keywordflow">case</span> EBADF : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"EBADF\n"</span>); <span class="keywordflow">break</span>;
01327                <span class="keywordflow">case</span> EFBIG : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"EFBIG\n"</span>); <span class="keywordflow">break</span>;
01328                <span class="keywordflow">case</span> EINTR : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"EINTR\n"</span>); <span class="keywordflow">break</span>;
01329                <span class="keywordflow">case</span> EIO : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"EIO\n"</span>); <span class="keywordflow">break</span>;
01330                <span class="keywordflow">case</span> ENOSPC : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"ENOSPC\n"</span>); <span class="keywordflow">break</span>;
01331                <span class="keywordflow">case</span> EPIPE : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"EPIPE\n"</span>); <span class="keywordflow">break</span>;
01332                <span class="keywordflow">case</span> ENOMEM : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"ENOMEM\n"</span>); <span class="keywordflow">break</span>;
01333                <span class="keywordflow">case</span> ENXIO : <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"ENXIO\n"</span>); <span class="keywordflow">break</span>;
01334                }
01335             }
01336          }
01337 
01338       fgetpos(fp,(fpos_t *)&amp;ptr);
01339       fsetpos(fp,(fpos_t *)&amp;ptr);
01340 
01341       <span class="keywordflow">return</span> l;
01342       }
01343 
01344    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g&gt;gr)||((gr==g)&amp;&amp;(n&gt;num)))     <span class="comment">/* on a depasse l'element */</span>
01345       {
01346       <span class="keywordflow">if</span>(flag)            <span class="comment">/*on a deja re-essaye depuis le debut */</span>
01347          {           <span class="comment">/* l'element cherche n'y est pas      */</span>
01348          fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);<span class="comment">/*on se positionne sur l'element sv */</span>
01349          <span class="keywordflow">return</span>(0);    <span class="comment">/*  On sort                JPR      */</span>
01350          }                      
01351       fseek(fp,l,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);
01352       flag=1;       <span class="comment">/* On va re-essayer depuis le debut  */</span>
01353       }
01354    <span class="keywordflow">else</span> {                       <span class="comment">/* on saute a l'element suivant      */</span>
01355       fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01356              }
01357    }
01358 <span class="keywordflow">return</span>(0);
01359 }
01360 
01361 <span class="comment">/* =======================================================================</span>
01362 <span class="comment">   _IdAcrModifElementLength</span>
01363 <span class="comment"></span>
01364 <span class="comment">                     Recherche un acr_element et MODIFIE sa longueur</span>
01365 <span class="comment"></span>
01366 <span class="comment">   ATTENTION : CASSE TOUT si cet element n'est pas celui des PIXELS...</span>
01367 <span class="comment"></span>
01368 <span class="comment">   ATTENTION : le fichier doit avoir ete ouvert en ID_RFILE_P_BIN ...  (rb+)                          </span>
01369 <span class="comment">   ======================================================================= */</span>
01370 
<a name="l01371"></a><a class="code" href="idacr-restricted_8h.html#a25">01371</a> <span class="keywordtype">long</span> <a class="code" href="idacr-restricted_8h.html#a25">_IdAcrModifElementLength</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> num, FILE *fp, uint32_t newLength) 
01372 {
01373 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> g;
01374 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> n;
01375 uint32_t l, l_gr, lgrEcr;
01376 <span class="keywordtype">int</span> flag,skL;
01377 
01378 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"recherche (5) gr %x  num %x (swapping %d)\n"</span>,gr,num,sw); 
01379 
01380 l=0;
01381 flag=0;
01382 <span class="keywordflow">while</span>(fread(&amp;g,2,1,fp))
01383    {
01384    <span class="keywordflow">if</span>(sw)g=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)g));
01385    fread(&amp;n,2,1,fp);
01386    <span class="keywordflow">if</span>(sw)n=<a class="code" href="acrutil_8c.html#a17">SWAP_SHORT</a>(((<span class="keywordtype">short</span>)n));
01387 
01388    <span class="comment">// Lecture de la longueur de l'element</span>
01389    l = <a class="code" href="acrutil_8c.html#a14">_IdAcrRecupLgr</a>(fp, &amp;skL);
01390 
01391 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"  -------------&gt; gr %x  num %x  long %x : %d\n"</span>,g,n,l,l);    
01392 
01393         <span class="keywordflow">if</span>(gr&gt;g)           <span class="comment">/* on est plus haut que l'element cherche      */</span>
01394             flag=1;    <span class="comment">/* si on ne le trouve pas des le premier coup  */</span>
01395                            <span class="comment">/* c'est qu'il n'y est pas          JPR        */</span>            
01396    <span class="keywordflow">if</span>((gr&gt;g)&amp;&amp;(n==0))  <span class="comment">/* on est sur un debut de groupe   JPR        */</span>
01397       {
01398       fread(&amp;l_gr,4,1,fp);
01399       <span class="keywordflow">if</span>(sw)l_gr=<a class="code" href="acrutil_8c.html#a18">SWAP_LONG</a>(((<span class="keywordtype">long</span>)l_gr)); <span class="comment">/* on lit sa longueur */</span>
01400       fseek(fp,l_gr,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01401 
01402 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>)  <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"                   on saute au gr sv :%d car\n"</span>,l_gr);        
01403              }
01404 
01405    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g==gr)&amp;&amp;(n==num))    <span class="comment">/* on est sur l'element recherche   */</span>
01406                                       <span class="comment">/* ------------------------------   */</span>
01407       {
01408       fseek (fp, -4, <a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01409       lgrEcr = fwrite(&amp;newLength ,4,1,fp);
01410       <span class="keywordflow">return</span>(lgrEcr);
01411       }
01412 
01413    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((g&gt;gr)||((gr==g)&amp;&amp;(n&gt;num)))     <span class="comment">/* on a depasse l'element */</span>
01414       {
01415       <span class="keywordflow">if</span>(flag)            <span class="comment">/*on a deja re-essaye depuis le debut */</span>
01416          {           <span class="comment">/* l'element cherche n'y est pas      */</span>
01417          fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);<span class="comment">/*on se positionne sur l'element sv */</span>
01418          <span class="keywordflow">return</span>(0);    <span class="comment">/*  On sort                JPR      */</span>
01419          }                      
01420       fseek(fp,l,<a class="code" href="volrdf_8c.html#a0">SEEK_SET</a>);
01421       flag=1;       <span class="comment">/* On va re-essayer depuis le debut  */</span>
01422       }
01423 
01424    <span class="keywordflow">else</span> {                       <span class="comment">/* on saute a l'element suivant      */</span>
01425       fseek(fp,l,<a class="code" href="simri3d_8h.html#a15">SEEK_CUR</a>);
01426              }
01427    }
01428 <span class="keywordflow">return</span>(0);
01429 }
01430 
01431 
01432 <span class="comment">/* ===============================================</span>
01433 <span class="comment">*</span>
01434 <span class="comment">*</span>
01435 <span class="comment">*            A partir d ici, plus de probleme</span>
01436 <span class="comment">*</span>
01437 <span class="comment">*</span>
01438 <span class="comment"> ================================================= */</span>
01439 
01440 
01441 
01442 
01443 
01444 <span class="comment">/* =======================================================================</span>
01445 <span class="comment">   _IdAcrMakeElement</span>
01446 <span class="comment"></span>
01447 <span class="comment">      creation d'un acr_element d'entete ACRNEMA </span>
01448 <span class="comment">   ======================================================================= */</span>
01449 
<a name="l01450"></a><a class="code" href="idacr-restricted_8h.html#a9">01450</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="idacr-restricted_8h.html#a9">_IdAcrMakeElement</a>(<span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> nu, <span class="keywordtype">long</span> <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> type, <span class="keywordtype">long</span> <span class="keywordtype">int</span> init)
01451 
01452 <span class="comment">/* ATTENTION : init pointeur sur une chaine de char(types AN,AT)</span>
01453 <span class="comment"> *    ou valeur (types BI,BD) </span>
01454 <span class="comment">*/</span>
01455 {
01456 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
01457 
01458 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"MakeElement gr %x nu %x size %d type %x init %d\n"</span>,gr,nu,size,type,init);
01459 
01460 <span class="keywordflow">if</span>(size &amp; 1)size+=1; <span class="comment">/* size doit etre paire */</span>
01461 
01462 <span class="keywordflow">if</span>((p=(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *)calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a>)))!=0) 
01463 
01464    {
01465    p-&gt;<a class="code" href="structacr__element.html#o0">group</a>= (<span class="keywordtype">short</span> <span class="keywordtype">int</span>)gr;
01466    p-&gt;<a class="code" href="structacr__element.html#o1">number</a>=(<span class="keywordtype">short</span> <span class="keywordtype">int</span>)nu;
01467    p-&gt;<a class="code" href="structacr__element.html#o2">length</a>=(uint32_t)size;
01468    p-&gt;<a class="code" href="structacr__element.html#o6">type</a>=  type;
01469    p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=  0;
01470    p-&gt;<a class="code" href="structacr__element.html#o4">value</a>= init;
01471    }
01472 <span class="keywordflow">else</span>
01473    <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"PB allocation memoire 1\n"</span>);
01474 <span class="keywordflow">return</span>(p);
01475 }
01476 
01477 <span class="comment">/* =======================================================================</span>
01478 <span class="comment"> * _IdAcrAddElement</span>
01479 <span class="comment"> *</span>
01480 <span class="comment"> *    insertion d'un acr_element dans la liste d'entete ACRNEMA </span>
01481 <span class="comment"> *  ======================================================================= */</span>
01482 
<a name="l01483"></a><a class="code" href="idacr-restricted_8h.html#a10">01483</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="idacr-restricted_8h.html#a10">_IdAcrAddElement</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste, <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *elem)
01484 {
01485 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p,*pp;
01486 <span class="keywordtype">int</span> flag;
01487 
01488 <span class="keywordflow">if</span>(!elem)<span class="keywordflow">return</span>(0);
01489 
01490 <span class="comment">/*if (DEBUG) IdPrintf ("AddElement %p %p \n",liste,elem);*/</span>
01491 
01492 flag=0; <span class="comment">/* pas d'insertion effectuee */</span>
01493 
01494 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrAddElement on ajoute : group : %04x elem : %04x lgr : %d "</span>, elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>, elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>, elem-&gt;<a class="code" href="structacr__element.html#o2">length</a>);
01495 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n"</span>);
01496 
01497 <span class="comment">/* liste vide */</span>
01498 <span class="keywordflow">if</span>(liste==0)
01499    <span class="keywordflow">return</span>(elem);
01500 <span class="comment">/* liste non vide */</span>
01501 p=liste;
01502 pp=0;
01503 
01504 
01505 
01506 <span class="keywordflow">while</span>( (p!=0) &amp;&amp; (!flag)) {
01507 
01508    <span class="comment">// laiser les 4 lignes commentees</span>
01509    <span class="comment">//if (DEBUG) {    IdPrintf ("\t\t_IdAcrAddElement on Explore : group : %04x elem : %04x lgr : %d", </span>
01510    <span class="comment">//       p-&gt;group, p-&gt;number, p-&gt;length);</span>
01511    <span class="comment">//    IdPrintf("\n");</span>
01512    <span class="comment">//}</span>
01513 
01514    <span class="keywordflow">if</span>(  (p-&gt;<a class="code" href="structacr__element.html#o0">group</a> &lt; elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) || 
01515         ((p-&gt;<a class="code" href="structacr__element.html#o0">group</a> == elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) &amp;&amp; (p-&gt;<a class="code" href="structacr__element.html#o1">number</a> &lt; elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>))) {
01516       pp=p;p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01517 
01518    } <span class="keywordflow">else</span> {
01519       <span class="keywordflow">if</span>( (p-&gt;<a class="code" href="structacr__element.html#o0">group</a> &gt; elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) ||
01520           ((p-&gt;<a class="code" href="structacr__element.html#o0">group</a> == elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) &amp;&amp; (p-&gt;<a class="code" href="structacr__element.html#o1">number</a> &gt; elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>))) {       
01521          flag=1;
01522          <span class="keywordflow">if</span>(pp) {
01523             pp-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=elem;
01524             elem-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=p;
01525          } <span class="keywordflow">else</span> {
01526             elem-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=p;
01527             liste=elem;
01528          }
01529       } <span class="keywordflow">else</span>  {          <span class="comment">/*  element identique */</span>
01530          <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"ACR_ELEMENT deja present.  : (%x, %x)\n"</span>,p-&gt;<a class="code" href="structacr__element.html#o0">group</a>,p-&gt;<a class="code" href="structacr__element.html#o1">number</a>);
01531          flag=1;
01532       }
01533    }
01534 }
01535 
01536 <span class="keywordflow">if</span>(!flag)
01537    pp-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=elem;
01538 
01539 <span class="keywordflow">return</span>(liste);
01540 }
01541 
01542 
01543 
01544 <span class="comment">/* =======================================================================</span>
01545 <span class="comment"> * _IdAcrAppendElement</span>
01546 <span class="comment"> *</span>
01547 <span class="comment"> *    insertion d'un acr_element EN FIN d'une liste d'entete ACRNEMA </span>
01548 <span class="comment"> *    (sans elimination des doublons, sans test de la sequence croissante)</span>
01549 <span class="comment"> *  ======================================================================= */</span>
01550 
<a name="l01551"></a><a class="code" href="idacr-restricted_8h.html#a11">01551</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="idacr-restricted_8h.html#a11">_IdAcrAppendElement</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste, <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *elem)
01552 {
01553 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p,*pp;
01554 
01555 <span class="keywordflow">if</span>(!elem)<span class="keywordflow">return</span>(0);
01556 
01557 <span class="comment">/*if (DEBUG) IdPrintf ("_IdAcrAppendElement %p %p \n",liste,elem);*/</span>
01558 
01559 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrAppendElement on ajoute : group : %04x elem : %04x lgr : %d "</span>, elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>, elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>, elem-&gt;<a class="code" href="structacr__element.html#o2">length</a>);
01560 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n"</span>);
01561 
01562 <span class="comment">/* liste vide */</span>
01563 <span class="keywordflow">if</span>(liste==0)
01564    <span class="keywordflow">return</span>(elem);
01565 <span class="comment">/* liste non vide */</span>
01566 p=liste;
01567 pp=0;
01568 
01569 <span class="keywordflow">while</span> (p!=0) {
01570    pp=p;p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01571 }
01572 
01573 pp-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=elem;
01574 
01575 <span class="keywordflow">return</span>(liste);
01576 }
01577 
01578 
01579 <span class="comment">/* =======================================================================</span>
01580 <span class="comment"> * _IdAcrModifyElement</span>
01581 <span class="comment"> *</span>
01582 <span class="comment"> *    Remplacement d'un acr_element dans la liste d'entete ACRNEMA (pour Marcela)</span>
01583 <span class="comment"> *  ======================================================================= */</span>
01584 
<a name="l01585"></a><a class="code" href="acrutil_8c.html#a20">01585</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="acrutil_8c.html#a20">_IdAcrModifyElement</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste, <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *elem)
01586 {
01587 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p, *pp, *prec;
01588 <span class="keywordtype">int</span> flag;
01589 
01590 <span class="keywordflow">if</span>(!elem)<span class="keywordflow">return</span>(0);
01591 
01592 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrModifyElement %p %p \n"</span>,liste,elem);
01593 
01594 flag=0; <span class="comment">/* pas d'insertion effectuee */</span>
01595 
01596 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"_IdAcrModifyElement on ajoute : group : %04x elem : %04x lgr : %d "</span>, elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>, elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>, elem-&gt;<a class="code" href="structacr__element.html#o2">length</a>);
01597 <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n"</span>);
01598 
01599 <span class="comment">/* liste vide */</span>
01600 
01601 <span class="keywordflow">if</span>(liste==0) {
01602    <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"Tentative de modif d'un ACR Elem dans une ACR List vide\n"</span>);
01603    <span class="keywordflow">return</span>(NULL);
01604 }
01605 <span class="comment">/* liste non vide */</span>
01606 
01607 p=   liste;
01608 prec=liste;
01609 pp=  0;
01610 
01611 <span class="keywordflow">while</span>( (p!=0) &amp;&amp; (!flag))
01612    {
01613    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a> (<span class="stringliteral">"\t\t_IdAcrModifyElement on Explore : group : %04x elem : %04x lgr : %d"</span>, 
01614             p-&gt;<a class="code" href="structacr__element.html#o0">group</a>, p-&gt;<a class="code" href="structacr__element.html#o1">number</a>, p-&gt;<a class="code" href="structacr__element.html#o2">length</a>);
01615    <span class="keywordflow">if</span> (<a class="code" href="acrwrite_8c.html#a0">DEBUG</a>) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n"</span>);
01616 
01617    <span class="keywordflow">if</span>(     (p-&gt;<a class="code" href="structacr__element.html#o0">group</a> &lt; elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) || 
01618       ((p-&gt;<a class="code" href="structacr__element.html#o0">group</a> == elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) &amp;&amp; (p-&gt;<a class="code" href="structacr__element.html#o1">number</a> &lt; elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>)))
01619       {pp=p; prec=p; p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;}
01620 
01621    <span class="keywordflow">else</span>  {
01622       <span class="keywordflow">if</span>( (p-&gt;<a class="code" href="structacr__element.html#o0">group</a> &gt; elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) ||
01623       ((p-&gt;<a class="code" href="structacr__element.html#o0">group</a> == elem-&gt;<a class="code" href="structacr__element.html#o0">group</a>) &amp;&amp; (p-&gt;<a class="code" href="structacr__element.html#o1">number</a> == elem-&gt;<a class="code" href="structacr__element.html#o1">number</a>)))
01624          {
01625          elem-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01626          prec-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>=elem;
01627          free(p);
01628          }
01629       <span class="keywordflow">else</span>    {
01630          <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"ACR_ELEMENT absent. Modif Impossible : (%x, %x)\n"</span>,p-&gt;<a class="code" href="structacr__element.html#o0">group</a>,p-&gt;<a class="code" href="structacr__element.html#o1">number</a>);
01631          flag=1;
01632          }
01633       }
01634    }
01635 <span class="keywordflow">return</span>(liste);
01636 }
01637 
01638 
01639 <span class="comment">/* =======================================================================</span>
01640 <span class="comment"> * _IdAcrFreeListe</span>
01641 <span class="comment"> *</span>
01642 <span class="comment"> *    liberation de la place utilisee par l'entete ACRNEMA </span>
01643 <span class="comment"> * ======================================================================= */</span>
01644 
01645 
<a name="l01646"></a><a class="code" href="idacr-restricted_8h.html#a12">01646</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="idacr-restricted_8h.html#a12">_IdAcrFreeListe</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste)
01647 {
01648 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p,*pp;
01649 p=liste;
01650 <span class="keywordflow">while</span>(p)
01651    {
01652    pp=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>; 
01653    free(p);
01654    p=pp;
01655    }
01656 <span class="keywordflow">return</span>(0);
01657 }
01658 
01659 <span class="comment">/* =======================================================================</span>
01660 <span class="comment"> * _IdAcrMergeListes</span>
01661 <span class="comment"> *</span>
01662 <span class="comment"> *    Interclassement de 2 listes d'ACR_ELEMENT dans une entete ACRNEMA </span>
01663 <span class="comment"> *   ======================================================================= */</span>
01664 
<a name="l01665"></a><a class="code" href="idacr-restricted_8h.html#a13">01665</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="idacr-restricted_8h.html#a13">_IdAcrMergeListes</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *listeOriginale, <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *listeAajouter)
01666 {
01667 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p,*pp;
01668 p=listeAajouter;
01669 <span class="keywordflow">while</span>(p)
01670    {
01671    pp=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;                                              
01672    listeAajouter=<a class="code" href="idacr-restricted_8h.html#a10">_IdAcrAddElement</a>(listeOriginale,p);
01673    <span class="keywordflow">if</span>(listeAajouter==0) <span class="keywordflow">return</span>(0);
01674    p=pp;                                                    
01675    }
01676 <span class="keywordflow">return</span>(listeOriginale);
01677 }
01678 
01679 <span class="comment">/* =======================================================================</span>
01680 <span class="comment"> * _IdAcrFindElement</span>
01681 <span class="comment"> *</span>
01682 <span class="comment"> *    Recherche EN MEMOIRE d'un Element de la (future) ACRNEMA </span>
01683 <span class="comment"> *  ======================================================================= */</span>
01684 
<a name="l01685"></a><a class="code" href="idacr-restricted_8h.html#a15">01685</a> <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *<a class="code" href="idacr-restricted_8h.html#a15">_IdAcrFindElement</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste, <span class="keywordtype">int</span> gr, <span class="keywordtype">int</span> nu)
01686 {
01687 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
01688 p=liste;
01689 <span class="keywordflow">while</span>(p &amp;&amp; ((gr != p-&gt;<a class="code" href="structacr__element.html#o0">group</a>) || (nu != p-&gt;<a class="code" href="structacr__element.html#o1">number</a>)))
01690    {
01691    p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01692    }
01693 <span class="keywordflow">return</span>(p);
01694 }
01695 
01696 <span class="comment">/* =======================================================================</span>
01697 <span class="comment"> * _IdAcrAdjustLength</span>
01698 <span class="comment"> *</span>
01699 <span class="comment"> *    Aligne la taille de al liste d'ACR_ELEMENT</span>
01700 <span class="comment"> *    sur unr frontiere DICOM compatible</span>
01701 <span class="comment"> *  ======================================================================= */</span>
01702 
<a name="l01703"></a><a class="code" href="idacr-restricted_8h.html#a16">01703</a> <span class="keywordtype">void</span> <a class="code" href="idacr-restricted_8h.html#a16">_IdAcrAdjustLength</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste)
01704 {
01705 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
01706 <span class="keywordtype">long</span> g;
01707 <span class="keywordtype">int</span> s;
01708 <span class="keywordtype">long</span> s_tot;
01709 s=0;
01710 s_tot=0;
01711 g = -1; <span class="comment">/*BB 18-JUN-1992 08:53:54 : g=-1;*/</span>
01712 p=liste;
01713 <span class="keywordflow">while</span>(p)
01714    {
01715    <span class="keywordflow">if</span>(g != p-&gt;<a class="code" href="structacr__element.html#o0">group</a>)
01716       {
01717       <span class="keywordflow">if</span>(g != -1)
01718          {
01719          (<a class="code" href="idacr-restricted_8h.html#a15">_IdAcrFindElement</a>(liste,g,0))-&gt;<a class="code" href="structacr__element.html#o4">value</a>=s;
01720          s_tot+=s+12;
01721          s=0;
01722          }
01723       g=p-&gt;<a class="code" href="structacr__element.html#o0">group</a>;
01724       }
01725    <span class="keywordflow">else</span>
01726       {
01727       <span class="keywordflow">if</span>(p-&gt;<a class="code" href="structacr__element.html#o1">number</a>) s += p-&gt;<a class="code" href="structacr__element.html#o2">length</a> + 8;
01728       }
01729    p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01730    }
01731 
01732 (<a class="code" href="idacr-restricted_8h.html#a15">_IdAcrFindElement</a>(liste,g,0))-&gt;<a class="code" href="structacr__element.html#o4">value</a>=s;
01733 s_tot+=s+12;
01734 (<a class="code" href="idacr-restricted_8h.html#a15">_IdAcrFindElement</a>(liste,8,1))-&gt;value=s_tot-24;
01735 }
01736 
01737 <span class="comment">/* =======================================================================</span>
01738 <span class="comment"> *       _IdAcrAffListe (pour liste creee par LibIDO)</span>
01739 <span class="comment"> *  ======================================================================= */</span>
01740 
<a name="l01741"></a><a class="code" href="idacr-restricted_8h.html#a17">01741</a> <span class="keywordtype">void</span> <a class="code" href="idacr-restricted_8h.html#a17">_IdAcrAffListe</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste)
01742 {
01743 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
01744 p=liste;
01745 <span class="keywordflow">while</span>(p)
01746         {
01747    <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" %04x\t%04x long.=%d \tvaleur "</span>,
01748                  p-&gt;<a class="code" href="structacr__element.html#o0">group</a>,p-&gt;<a class="code" href="structacr__element.html#o1">number</a>,p-&gt;<a class="code" href="structacr__element.html#o2">length</a>); 
01749         <span class="keywordflow">switch</span>(p-&gt;<a class="code" href="structacr__element.html#o6">type</a>)
01750                 {
01751                 <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a1">BI</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"%d\n"</span>,  p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);            <span class="keywordflow">break</span>;
01752                 <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a2">BD</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"%d\n"</span>,  p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);            <span class="keywordflow">break</span>;
01753                 <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a3">AN</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"[%s]\n"</span>,(<span class="keywordtype">char</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);    <span class="keywordflow">break</span>;
01754                 <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a4">AT</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"[%s]\n"</span>,(<span class="keywordtype">char</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);    <span class="keywordflow">break</span>;
01755                 <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a0">NO</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"%x\n"</span>,  p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);            <span class="keywordflow">break</span>;
01756                 }
01757         p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01758         }
01759 }
01760 
01761 <span class="comment">/* =======================================================================</span>
01762 <span class="comment"> * _IdAcrAffListeBref (pour Liste cree par _IdAcrInquireHeader)</span>
01763 <span class="comment"> *  ======================================================================= */</span>
01764 
<a name="l01765"></a><a class="code" href="idacr-restricted_8h.html#a19">01765</a> <span class="keywordtype">void</span> <a class="code" href="idacr-restricted_8h.html#a19">_IdAcrAffListeBref</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> *liste)
01766 {
01767 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
01768 p=liste;
01769 <span class="keywordflow">while</span>(p)
01770    {
01771     <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" %04x\t%04x long.=%d \tvaleur "</span>,
01772        p-&gt;<a class="code" href="structacr__element.html#o0">group</a>,p-&gt;<a class="code" href="structacr__element.html#o1">number</a>,p-&gt;<a class="code" href="structacr__element.html#o2">length</a>); 
01773    <span class="keywordflow">switch</span>(p-&gt;<a class="code" href="structacr__element.html#o6">type</a>)
01774       {
01775       <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a1">BI</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"%d [%8x]\n"</span>, *(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)(p-&gt;<a class="code" href="structacr__element.html#o4">value</a>),  *(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)(p-&gt;<a class="code" href="structacr__element.html#o4">value</a>));   <span class="keywordflow">break</span>;
01776       <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a2">BD</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"%d [%8x]\n"</span>, *(uint32_t *)(p-&gt;<a class="code" href="structacr__element.html#o4">value</a>), *(uint32_t *)(p-&gt;<a class="code" href="structacr__element.html#o4">value</a>));   <span class="keywordflow">break</span>;
01777       <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a3">AN</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"[%s]\n"</span>,(<span class="keywordtype">char</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>); <span class="keywordflow">break</span>;
01778       <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a4">AT</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"[%s]\n"</span>,(<span class="keywordtype">char</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>); <span class="keywordflow">break</span>;
01779       <span class="keywordflow">case</span> <a class="code" href="idacr_8h.html#a0">NO</a>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"%8x\n"</span>,  p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);     <span class="keywordflow">break</span>;
01780       <span class="keywordflow">default</span>:<a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" ?? %d [%8x]\n"</span>,  p-&gt;<a class="code" href="structacr__element.html#o4">value</a>, p-&gt;<a class="code" href="structacr__element.html#o4">value</a>); <span class="keywordflow">break</span>;
01781       }
01782    p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01783    }
01784 }
01785 
01786 <span class="comment">/* =======================================================================</span>
01787 <span class="comment"> * _IdAcrAffListe2 (Reserve a l'affichage du resultat de IdAcrInquireHeader)</span>
01788 <span class="comment"> *  ======================================================================= */</span>
01789 
<a name="l01790"></a><a class="code" href="idacr-restricted_8h.html#a18">01790</a> <span class="keywordtype">void</span> <a class="code" href="idacr-restricted_8h.html#a18">_IdAcrAffListe2</a>(<a class="code" href="structacr__element.html">ACR_ELEMENT</a> * liste, <span class="keywordtype">int</span> npriv, <span class="keywordtype">int</span> noffset)
01791 {
01792 <a class="code" href="structacr__element.html">ACR_ELEMENT</a> *p;
01793 <a class="code" href="struct____Dicom____el____.html">DICOM_ELEMENTS</a> *t = NULL;
01794 <span class="keywordtype">long</span>  _offset =0;
01795 
01796 
01797 _offset = <a class="code" href="acrread_8c.html#a12">__ID_offset</a> + 2 + 2 + 4;
01798 
01799 
01800 p=liste;
01801 
01802 <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n\n\t\tATTENTION : Les chaines de caracteres de longueur 2 ou 4 \n"</span>
01803    <span class="stringliteral">"\t(des groupes de num IMPAIR) peuvent avoir ete 'swappees'\n\n"</span>);
01804 
01805 <span class="keywordflow">while</span>(p) {
01806     <span class="comment">// if (DEBUG)IdPrintf(" ?? gr %04x num %04x long %d\n", p-&gt;group, p-&gt;number, p-&gt;length);</span>
01807 
01808       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structacr__element.html#o1">number</a>==0) { 
01809          <span class="keywordflow">if</span>(!npriv) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\n"</span>); 
01810        } <span class="keywordflow">else</span> { 
01811          <span class="keywordflow">for</span> (t=<a class="code" href="dicom_8c.html#a3">_ID_dicom_elements</a>; t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>!=0xffff; t++) {
01812             <span class="keywordflow">if</span>( (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a>==p-&gt;<a class="code" href="structacr__element.html#o0">group</a>) &amp;&amp; (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a>==p-&gt;<a class="code" href="structacr__element.html#o1">number</a>) ) <span class="keywordflow">break</span>;
01813          }
01814                }
01815 
01816       <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) {
01817 
01818          <span class="keywordflow">if</span> (noffset) 
01819             <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" gr %04x  num %04x  long %d"</span>,
01820                 p-&gt;<a class="code" href="structacr__element.html#o0">group</a>, p-&gt;<a class="code" href="structacr__element.html#o1">number</a>, p-&gt;<a class="code" href="structacr__element.html#o2">length</a>);
01821          <span class="keywordflow">else</span>
01822 
01823          <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" gr %04x  num %04x  long %d  _offset %d"</span>,
01824             p-&gt;<a class="code" href="structacr__element.html#o0">group</a>, p-&gt;<a class="code" href="structacr__element.html#o1">number</a>, p-&gt;<a class="code" href="structacr__element.html#o2">length</a>, _offset);
01825       }
01826 
01827       _offset += 2 +2 + p-&gt;<a class="code" href="structacr__element.html#o3">skippedLength</a> + p-&gt;<a class="code" href="structacr__element.html#o2">length</a>;
01828 
01829       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structacr__element.html#o1">number</a>!=0) { 
01830          <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t%s\t%s\t\t"</span>,  
01831                   t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>, t-&gt;<a class="code" href="struct____Dicom____el____.html#o4">dicom_libelle</a>); 
01832       } 
01833 
01834       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structacr__element.html#o1">number</a>==0) { 
01835          <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"   lgr du grp = %d\n   -------\n"</span>,
01836                *(<span class="keywordtype">long</span> *)(p-&gt;<a class="code" href="structacr__element.html#o4">value</a>)); 
01837       }
01838  
01839 
01840 <span class="comment">/* MANQUE le retrait, avant impression en %s, des caract non ASCII */</span>
01841 
01842       <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structacr__element.html#o2">length</a>==2)  {
01843             <span class="keywordflow">if</span> ( (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>, <span class="stringliteral">"US"</span>) == 0)
01844               || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>, <span class="stringliteral">"SS"</span>) == 0) 
01845                     || (t-&gt;<a class="code" href="struct____Dicom____el____.html#o0">dicom_group</a> == 0x0028 &amp;&amp; 
01846                  (t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a> == 0x0005  || t-&gt;<a class="code" href="struct____Dicom____el____.html#o1">dicom_elem</a> == 0x0200) ) )  {
01847  
01848                <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) { 
01849                   <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t  \t \t %d \tx(%04x)\n"</span>, 
01850                   *(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)(p-&gt;<a class="code" href="structacr__element.html#o4">value</a>) , *(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>); 
01851                }
01852             }
01853          <span class="keywordflow">else</span>
01854 
01855             <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv){ <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t[%s]  \t %d \tx(%04x)\n"</span>, 
01856                (<span class="keywordtype">char</span>*)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>,*(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>, *(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);}
01857          
01858       }
01859 
01860       <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structacr__element.html#o2">length</a>==4)  {
01861                <span class="keywordflow">if</span> ( (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"UL"</span>) == 0)
01862                     || (strcmp(t-&gt;<a class="code" href="struct____Dicom____el____.html#o2">dicom_type</a>,<span class="stringliteral">"SL"</span>) == 0) ) {
01863                <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) { 
01864                   <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t  \t \t %d \tx(%08x)\n"</span>, 
01865                      (<span class="keywordtype">int</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>, *(<span class="keywordtype">short</span> <span class="keywordtype">int</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>); 
01866                }
01867             } <span class="keywordflow">else</span> {
01868                <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) { 
01869                   <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">"\t[%s]  \t %d \tx(%08x)\n"</span>, 
01870                   (<span class="keywordtype">char</span>*)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>,*(<span class="keywordtype">long</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>, *(<span class="keywordtype">long</span> *)p-&gt;<a class="code" href="structacr__element.html#o4">value</a>); 
01871                }
01872             }
01873          
01874          }
01875 
01876       <span class="keywordflow">else</span> { 
01877          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structacr__element.html#o2">length</a> &gt; 5000) { 
01878             <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) 
01879                <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" --&gt; Too Long. Not Printed...\n"</span>);
01880          } <span class="keywordflow">else</span> {
01881             <span class="keywordflow">if</span>(!(p-&gt;<a class="code" href="structacr__element.html#o0">group</a>%2) || !npriv) <a class="code" href="kerprint_8c.html#a4">IdPrintf</a>(<span class="stringliteral">" \t[%s]\n"</span>,p-&gt;<a class="code" href="structacr__element.html#o4">value</a>);
01882          }
01883         }
01884    p=p-&gt;<a class="code" href="structacr__element.html#o5">suiv</a>;
01885    }
01886 }
01887 
01888 
01889 
01890 <span class="comment">/* =======================================================================</span>
01891 <span class="comment">   _IdAcrAddHisto</span>
01892 <span class="comment">   ======================================================================= */</span>
01893 
01894 <span class="keywordtype">int</span>
<a name="l01895"></a><a class="code" href="idacr-restricted_8h.html#a20">01895</a> <a class="code" href="idacr-restricted_8h.html#a20">_IdAcrAddHisto</a>(<span class="keywordtype">char</span> *l)
01896 {
01897 FILE *fphisto;
01898 
01899 <span class="keywordflow">if</span>((fphisto=fopen(<span class="stringliteral">"_t_histo.tmp"</span>,<span class="stringliteral">"a"</span>))!=0)
01900    {
01901    fseek(fphisto,0L,SEEK_END);
01902    fwrite(l,strlen(l),1,fphisto);
01903    fclose(fphisto);
01904    }
01905   <span class="keywordflow">return</span> 0;
01906 }
01907 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:13 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
