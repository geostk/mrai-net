<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: seq-ge.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>seq-ge.c</h1><a href="seq-ge_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: seq-ge.c,v 1.8 2006/12/18 15:10:38 yougz Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment">Fonctions that implement grient echo sequence</span>
00005 <span class="comment">This sequence runs the following events</span>
00006 <span class="comment">- Pulse with teta angle. Teta optimal if cos(teta)=exp(-Tr/T1)</span>
00007 <span class="comment">- Waiting</span>
00008 <span class="comment">- Phase gradient</span>
00009 <span class="comment">- Waiting</span>
00010 <span class="comment">- Bipolar gradient: half negative lobe before acquisition</span>
00011 <span class="comment">- Acquisition with a positive gradient to get an echo in the center of the acquisition window</span>
00012 <span class="comment">- Waiting until TR</span>
00013 <span class="comment">To avoid a call to the magnetisation kernel, and earn time</span>
00014 <span class="comment">We apply simultaneously the phase gradients and the negative gradient before acquisition</span>
00015 <span class="comment">**************************************************************************</span>
00016 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00017 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00018 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00019 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00020 <span class="comment">  "http://www.cecill.info". </span>
00021 <span class="comment">  </span>
00022 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00023 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00024 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00025 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00026 <span class="comment">  liability. </span>
00027 <span class="comment">  </span>
00028 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00029 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00030 <span class="comment">  software by the user in light of its specific status of free software,</span>
00031 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00032 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00033 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00034 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00035 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00036 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00037 <span class="comment">  same conditions as regards security. </span>
00038 <span class="comment">  </span>
00039 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00040 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00041 <span class="comment">  </span>
00042 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00043 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00044 <span class="comment">  </span>
00045 <span class="comment">  Version 2.0  20/12/2006</span>
00046 <span class="comment">*************************************************************************/</span>
00047 
00048 <span class="preprocessor">#include "<a class="code" href="seq-ge_8h.html">seq-ge.h</a>"</span>
00049 
00050 <span class="preprocessor">#include "<a class="code" href="event-rfpulse_8h.html">event-rfpulse.h</a>"</span>
00051 <span class="preprocessor">#include "<a class="code" href="event-precession_8h.html">event-precession.h</a>"</span>
00052 <span class="preprocessor">#include "<a class="code" href="event-acquisition_8h.html">event-acquisition.h</a>"</span>
00053 <span class="preprocessor">#include "<a class="code" href="experience_8h.html">experience.h</a>"</span>
00054 <span class="preprocessor">#include "<a class="code" href="seq-mpi_8h.html">seq-mpi.h</a>"</span>
00055 
00056 <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga6">SeqGradientEcho1D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr);
00057 <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga7">SeqGradientEcho2D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr);
00058 <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga8">SeqGradientEcho3D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr);
00059 
<a name="l00069"></a><a class="code" href="group__Sequence.html#ga2">00069</a> <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> <a class="code" href="group__Sequence.html#ga2">SeqGradientEcho1D</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00070 {
00071    <a class="code" href="seq-mpi_8h.html#a1">mpi_job</a>(seqparam, expr, <a class="code" href="group__Sequence.html#ga6">SeqGradientEcho1D_0</a>);
00072    <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(expr);
00073    <span class="keywordflow">return</span>(<a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(expr));
00074 }
00075 
<a name="l00085"></a><a class="code" href="group__Sequence.html#ga3">00085</a> <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> <a class="code" href="group__Sequence.html#ga3">SeqGradientEcho2D</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00086 {
00087    <a class="code" href="seq-mpi_8h.html#a1">mpi_job</a>(seqparam, expr, <a class="code" href="group__Sequence.html#ga7">SeqGradientEcho2D_0</a>);
00088    <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(expr);
00089    <span class="keywordflow">return</span>(<a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(expr));
00090 }
00091 
<a name="l00101"></a><a class="code" href="group__Sequence.html#ga4">00101</a> <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a> <a class="code" href="group__Sequence.html#ga4">SeqGradientEcho3D</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00102 {
00103    <a class="code" href="seq-mpi_8h.html#a1">mpi_job</a>(seqparam, expr, <a class="code" href="group__Sequence.html#ga8">SeqGradientEcho3D_0</a>);
00104    <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(expr);
00105    <span class="keywordflow">return</span>(<a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(expr));
00106 }
00107 
<a name="l00116"></a><a class="code" href="group__Sequence.html#ga0">00116</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga0">CheckTimesGE</a>(<span class="keywordtype">double</span> tacq,<span class="keywordtype">double</span> te,<span class="keywordtype">double</span> tr)
00117 {
00118    <span class="keywordtype">int</span> f=0;
00119    <span class="keywordflow">if</span>((tacq&lt;te)&amp;&amp;(tr&gt;te+tacq/2.0))f=1;
00120    <span class="keywordflow">if</span>(f==0){
00121       <a class="code" href="simri3d_8h.html#a18">FPRINTF</a>(stderr,<span class="stringliteral">"Bad values for your sequence GE: Tacq=%g, Te=%g, Tr=%g\n"</span>,tacq, te, tr);
00122       exit(0);
00123    }
00124 }
<a name="l00133"></a><a class="code" href="group__Sequence.html#ga6">00133</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga6">SeqGradientEcho1D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00134 {
00135   <span class="keywordtype">int</span>      ntx;
00136   <span class="keywordtype">int</span>      npy,npz;
00137   <span class="keywordtype">double</span>   fovx;
00138   <span class="keywordtype">double</span>   te,tr,tacq,timp,acq_delay,tg; <span class="comment">/* ms */</span>
00139   <span class="keywordtype">double</span>   gx;
00140   <span class="keywordtype">double</span>   teta;     <span class="comment">/* degree */</span>
00141   <span class="keywordtype">int</span> i;
00142   <a class="code" href="struct__Event.html">EVENT</a>* entre, entre_r;
00143   entre = &amp;entre_r;
00144 
00145   printf(<span class="stringliteral">"Starting SeqGradientEcho2D \n"</span>);  
00146   ntx = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00147   tacq = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a>*1.e+3;
00148   fovx = expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>;
00149   te = seqparam-&gt;te;
00150   tr = seqparam-&gt;tr;
00151   teta = seqparam-&gt;teta;
00152    
00153   <a class="code" href="group__Sequence.html#ga0">CheckTimesGE</a>(tacq,te,tr);
00154   timp=0.3;<span class="comment">/*RF pulse duration in ms */</span>   
00155   acq_delay = 0;
00156   tg=tacq/2.0;
00157   gx=(ntx-1.)/tacq/<a class="code" href="simri3d_8h.html#a3">G_kHz_G</a>/fovx;
00158   npy=0;
00159   npz=0;
00160 
00161   <a class="code" href="group__Event.html#ga5">SetSpoilingFlag</a>(entre,<a class="code" href="event_8h.html#a0">ACTIVE</a>); <span class="comment">/* XY Spoiling after acquisition */</span>
00162   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,<a class="code" href="experience_8h.html#a0">ATT_INIT</a>); <span class="comment">/* To get an initial magnetisation M0 */</span>
00163 
00164   <span class="keywordflow">for</span>(i=0;i&lt;10;i++) <span class="comment">/* Repetition to get a TR effect */</span>
00165    {
00166     <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta,timp);
00167    <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,tr);
00168    }
00169   <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(expr);
00170   <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta,timp);
00171   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,te-tacq);
00172   <span class="comment">// Application of the negative gradient before reading (-gx)</span>
00173   <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tg,-gx,0,0.0);
00174   <span class="comment">// Readout with application of a positive gradient (gx)</span>
00175   <a class="code" href="group__Event.html#ga0">DoAcqFrequenceX</a>(expr,entre, gx, npy, npz,acq_delay,<a class="code" href="simri3d_8h.html#a10">MINUS</a>);
00176  
00177   printf(<span class="stringliteral">"Ending SeqGradientEcho1D \n"</span>);  
00178 }
00179 
00180 
<a name="l00189"></a><a class="code" href="group__Sequence.html#ga7">00189</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga7">SeqGradientEcho2D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00190 {
00191   <span class="keywordtype">int</span>      ntx,nty;
00192   <span class="keywordtype">double</span>   fovx,fovy;
00193   <span class="keywordtype">double</span>   te,tr,tacq,timp,acq_delay,tg; <span class="comment">/* ms */</span>
00194   <span class="keywordtype">double</span>   gx,gy,gz,gp;
00195   <span class="keywordtype">double</span>   teta;     <span class="comment">/* degree */</span>
00196   <span class="keywordtype">int</span>    npy, npz;
00197   <a class="code" href="struct__Event.html">EVENT</a>* entre, entre_r;
00198   entre = &amp;entre_r;
00199 
00200   printf(<span class="stringliteral">"Starting SeqGradientEcho2D \n"</span>);  
00201   ntx = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00202   nty = expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
00203   tacq = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a>*1.e+3;
00204   fovx = expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>;
00205   fovy = expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a>;
00206 
00207   te = seqparam-&gt;te;
00208   tr = seqparam-&gt;tr;
00209   teta = seqparam-&gt;teta;
00210    
00211   <a class="code" href="group__Sequence.html#ga0">CheckTimesGE</a>(tacq,te,tr);
00212   timp=0.3;<span class="comment">/*RF pulse duration in ms */</span>   
00213   acq_delay = 0;
00214   tg=tacq/2.0;
00215   gx=(ntx-1.)/tacq/<a class="code" href="simri3d_8h.html#a3">G_kHz_G</a>/fovx;
00216   gy=2*M_PI*(nty-1)/<a class="code" href="simri3d_8h.html#a4">G_rad_G</a>/fovy/(tg/1000);
00217   gz=0.0;
00218   npz=0;
00219 
00220   <a class="code" href="group__Event.html#ga5">SetSpoilingFlag</a>(entre,<a class="code" href="event_8h.html#a0">ACTIVE</a>); <span class="comment">/* XY Spoiling after acquisition */</span>
00221   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,<a class="code" href="experience_8h.html#a0">ATT_INIT</a>); <span class="comment">/* To get an initial magnetisation M0 */</span>
00222 
00223   <span class="keywordflow">for</span> (npy = 0; npy &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; npy++)
00224     {
00225        <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(expr);
00226       <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta,timp);
00227       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,te-tacq);
00228        gp = (gy) * (npy - nty / 2.) / nty;  
00229       <span class="comment">// Simultaneous application of the negative gradient before reading (-gx) and the phase gradient gp</span>
00230       <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tg,-gx,-gp,0.0);
00231       <span class="comment">// Readout with application of a positive gradient (gx)</span>
00232        <a class="code" href="group__Event.html#ga0">DoAcqFrequenceX</a>(expr,entre, gx, npy, npz,acq_delay,<a class="code" href="simri3d_8h.html#a10">MINUS</a>);
00233       <span class="comment">// Waiting before next line</span>
00234       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,tr-te-tacq/2.0);
00235     }
00236  
00237   printf(<span class="stringliteral">"Ending SeqGradientEcho2D \n"</span>);  
00238 }
00239 
<a name="l00248"></a><a class="code" href="group__Sequence.html#ga8">00248</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga8">SeqGradientEcho3D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00249 {
00250   <span class="keywordtype">int</span>      ntx,nty,ntz;
00251   <span class="keywordtype">double</span>   fovx,fovy,fovz;
00252   <span class="keywordtype">double</span>   te,tr,tacq,timp,acq_delay,tg; <span class="comment">/* ms */</span>
00253   <span class="keywordtype">double</span>   gx,gy,gz,gpy,gpz;
00254   <span class="keywordtype">double</span>   teta;     <span class="comment">/* degree */</span>
00255   <span class="keywordtype">int</span>    npy,npz;
00256   <a class="code" href="struct__Event.html">EVENT</a>* entre, entre_r;
00257   entre = &amp;entre_r;
00258 
00259   printf(<span class="stringliteral">"Starting SeqGradientEcho3D \n"</span>);  
00260   ntx = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00261   nty = expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
00262   ntz = expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00263   tacq = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a>*1.e+3;
00264   fovx = expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>;
00265   fovy = expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a>;
00266   fovz = expr-&gt;<a class="code" href="struct__Experience3D.html#o13">fovz</a>;
00267   te = seqparam-&gt;te;
00268   tr = seqparam-&gt;tr;
00269   teta = seqparam-&gt;teta;
00270    
00271   <a class="code" href="group__Sequence.html#ga0">CheckTimesGE</a>(tacq,te,tr);
00272   timp=0.3;<span class="comment">/*RF pulse duration in ms */</span>   
00273   acq_delay = 0;
00274   tg=tacq/2.0;
00275   gx=(ntx-1.)/tacq/<a class="code" href="simri3d_8h.html#a3">G_kHz_G</a>/fovx;
00276   gy=2*M_PI*(nty-1)/<a class="code" href="simri3d_8h.html#a4">G_rad_G</a>/fovy/(tg/1000);
00277   gz=2*M_PI*(ntz-1)/<a class="code" href="simri3d_8h.html#a4">G_rad_G</a>/fovz/(tg/1000);
00278 
00279   <a class="code" href="group__Event.html#ga5">SetSpoilingFlag</a>(entre,<a class="code" href="event_8h.html#a0">ACTIVE</a>); <span class="comment">/* XY Spoiling after acquisition */</span>
00280   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,<a class="code" href="experience_8h.html#a0">ATT_INIT</a>); <span class="comment">/* To get an initial magnetisation M0 */</span>
00281 
00282   <span class="keywordflow">for</span> (npy = 0; npy &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; npy++)    {
00283   <span class="keywordflow">for</span> (npz = 0; npz &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>; npz++)    {
00284        <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(expr);
00285       <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta,timp);
00286       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,te-tacq);
00287        gpy = (gy) * (npy - nty / 2.) / nty;
00288       gpz = (gz) * (npz - ntz / 2.) / ntz;
00289       <span class="comment">// Simultaneous application of the negative gradient before reading (-gx) and the phase gradients gpy,gpz</span>
00290       <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tg,-gx,-gpy,-gpz);
00291       <span class="comment">// Readout with application of a positive gradient (gx)</span>
00292        <a class="code" href="group__Event.html#ga0">DoAcqFrequenceX</a>(expr,entre, gx,npy,npz,acq_delay,<a class="code" href="simri3d_8h.html#a10">MINUS</a>);
00293       <span class="comment">// Waiting before next line</span>
00294       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,tr-te-tacq/2.0);
00295     }}
00296  
00297   printf(<span class="stringliteral">"Ending SeqGradientEcho3D \n"</span>);  
00298 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:14 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
