<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SIMRI3D: seq-tf.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>seq-tf.c</h1><a href="seq-tf_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*************************************************************************</span>
00002 <span class="comment">* $Id: seq-tf.c,v 1.8 2006/12/18 15:10:38 yougz Exp $</span>
00003 <span class="comment">**************************************************************************</span>
00004 <span class="comment">Functions that implement a TrueFisp Sequence</span>
00005 <span class="comment">This sequence chains the following events</span>
00006 <span class="comment">- RF pulse </span>
00007 <span class="comment">- Waiting</span>
00008 <span class="comment">- Phase Gradient</span>
00009 <span class="comment">- Waiting</span>
00010 <span class="comment">- Bipolar Gradient : Half negative lobe before acquisition</span>
00011 <span class="comment">- Acquisition with a positive gradient</span>
00012 <span class="comment">- Rewind of all the gradients (phase and readout)</span>
00013 <span class="comment">******************************************************************************</span>
00014 <span class="comment"> This software is governed by the CeCILL  license under French law and</span>
00015 <span class="comment">  abiding by the rules of distribution of free software.  You can  use, </span>
00016 <span class="comment">  modify and/ or redistribute the software under the terms of the CeCILL</span>
00017 <span class="comment">  license as circulated by CEA, CNRS and INRIA at the following URL</span>
00018 <span class="comment">  "http://www.cecill.info". </span>
00019 <span class="comment">  </span>
00020 <span class="comment">  As a counterpart to the access to the source code and  rights to copy,</span>
00021 <span class="comment">  modify and redistribute granted by the license, users are provided only</span>
00022 <span class="comment">  with a limited warranty  and the software's author,  the holder of the</span>
00023 <span class="comment">  economic rights,  and the successive licensors  have only  limited</span>
00024 <span class="comment">  liability. </span>
00025 <span class="comment">  </span>
00026 <span class="comment">  In this respect, the user's attention is drawn to the risks associated</span>
00027 <span class="comment">  with loading,  using,  modifying and/or developing or reproducing the</span>
00028 <span class="comment">  software by the user in light of its specific status of free software,</span>
00029 <span class="comment">  that may mean  that it is complicated to manipulate,  and  that  also</span>
00030 <span class="comment">  therefore means  that it is reserved for developers  and  experienced</span>
00031 <span class="comment">  professionals having in-depth computer knowledge. Users are therefore</span>
00032 <span class="comment">  encouraged to load and test the software's suitability as regards their</span>
00033 <span class="comment">  requirements in conditions enabling the security of their systems and/or </span>
00034 <span class="comment">  data to be ensured and,  more generally, to use and operate it in the </span>
00035 <span class="comment">  same conditions as regards security. </span>
00036 <span class="comment">  </span>
00037 <span class="comment">  The fact that you are presently reading this means that you have had</span>
00038 <span class="comment">  knowledge of the CeCILL license and that you accept its terms.</span>
00039 <span class="comment">  </span>
00040 <span class="comment">  Copyright (c) CREATIS (Centre de Recherche et d'Applications en Traitement de</span>
00041 <span class="comment">  l'Image). All rights reserved. See License.txt for details.</span>
00042 <span class="comment">  </span>
00043 <span class="comment">  Version 2.0  20/12/2006</span>
00044 <span class="comment">*************************************************************************/</span>
00045 
00046 <span class="preprocessor">#include "<a class="code" href="seq-tf_8h.html">seq-tf.h</a>"</span>
00047 <span class="preprocessor">#include "<a class="code" href="event-rfpulse_8h.html">event-rfpulse.h</a>"</span>
00048 <span class="preprocessor">#include "<a class="code" href="event-precession_8h.html">event-precession.h</a>"</span>
00049 <span class="preprocessor">#include "<a class="code" href="event-acquisition_8h.html">event-acquisition.h</a>"</span>
00050 <span class="preprocessor">#include "<a class="code" href="experience_8h.html">experience.h</a>"</span>
00051 <span class="preprocessor">#include "<a class="code" href="seq-mpi_8h.html">seq-mpi.h</a>"</span>
00052 
00053 <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga27">SeqTrueFisp1D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr);
00054 <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga28">SeqTrueFisp2D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr);
00055 <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga29">SeqTrueFisp3D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr);
00056 
00066 <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a>
<a name="l00067"></a><a class="code" href="group__Sequence.html#ga23">00067</a> <a class="code" href="group__Sequence.html#ga23">SeqTrueFisp1D</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00068 {
00069    <a class="code" href="seq-mpi_8h.html#a1">mpi_job</a>(seqparam, expr, <a class="code" href="group__Sequence.html#ga27">SeqTrueFisp1D_0</a>);
00070    <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(expr);
00071    <span class="keywordflow">return</span>(<a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(expr));
00072 }
00073 
00083 <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a>
<a name="l00084"></a><a class="code" href="group__Sequence.html#ga24">00084</a> <a class="code" href="group__Sequence.html#ga24">SeqTrueFisp2D</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00085 {
00086    <a class="code" href="seq-mpi_8h.html#a1">mpi_job</a>(seqparam, expr, <a class="code" href="group__Sequence.html#ga28">SeqTrueFisp2D_0</a>);
00087    <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(expr);
00088    <span class="keywordflow">return</span>(<a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(expr));
00089 }
00090 
00100 <a class="code" href="structCOMPLEX__DOUBLE.html">PPPVOLUME_COMPLEX_DOUBLE</a>
<a name="l00101"></a><a class="code" href="group__Sequence.html#ga25">00101</a> <a class="code" href="group__Sequence.html#ga25">SeqTrueFisp3D</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00102 {
00103    <a class="code" href="seq-mpi_8h.html#a1">mpi_job</a>(seqparam, expr, <a class="code" href="group__Sequence.html#ga29">SeqTrueFisp3D_0</a>);
00104    <a class="code" href="group__Experience.html#ga25">NormalizeRFSignal</a>(expr);
00105    <span class="keywordflow">return</span>(<a class="code" href="group__Experience.html#ga28">GetSignalRFComplexFromExperience</a>(expr));
00106 }
00107 
<a name="l00116"></a><a class="code" href="group__Sequence.html#ga0">00116</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga0">CheckTimesTF</a>(<span class="keywordtype">double</span> tacq,<span class="keywordtype">double</span> tr,<span class="keywordtype">double</span> twait)
00117 {
00118    <span class="keywordtype">int</span> f=0;
00119    <span class="keywordflow">if</span>((tr&gt;=2*tacq)&amp;&amp;(twait&gt;=0.))f=1;
00120    <span class="keywordflow">if</span>(f==0){
00121       <a class="code" href="simri3d_8h.html#a18">FPRINTF</a>(stderr,<span class="stringliteral">"Bad values for your sequence TF: Tacq=%g, Tr=%g, Twait=%g, \n"</span>,tacq, tr, twait);
00122       exit(0);
00123    }
00124 }
00125 
<a name="l00134"></a><a class="code" href="group__Sequence.html#ga27">00134</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga27">SeqTrueFisp1D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00135 {
00136   <span class="keywordtype">int</span>      i,ntx,phase,altphase;
00137   <span class="keywordtype">double</span>   fovx;
00138   <span class="keywordtype">double</span>   tr,tacq,timp,acq_delay,tgrad,twait; <span class="comment">/* ms */</span>
00139   <span class="keywordtype">double</span>   gx;
00140   <span class="keywordtype">double</span>   teta;     <span class="comment">/* degree */</span>
00141   <span class="keywordtype">int</span>    npy, npz;
00142   <a class="code" href="struct__Event.html">EVENT</a>* entre, entre_r;
00143   entre = &amp;entre_r;
00144 
00145    printf(<span class="stringliteral">"Starting SeqTrueFisp1D \n"</span>);  
00146 
00147    ntx = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00148    tacq = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a>*1.e+3;
00149    fovx = expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>;
00150 
00151    tr = seqparam-&gt;tr;
00152    teta = seqparam-&gt;teta;
00153    
00154    <a class="code" href="group__Sequence.html#ga0">CheckTimesTF</a>(tacq,tr/2.,tr);
00155    timp=0.3; <span class="comment">/*RF pulse duration in ms */</span>   
00156    acq_delay = 0;
00157    tgrad=(tacq)/2.;
00158    twait=(tr-2*tgrad-tacq)/2;
00159 
00160    gx=(ntx-1)/tacq/<a class="code" href="simri3d_8h.html#a3">G_kHz_G</a>/fovx;     
00161    npy=0;npz=0;
00162 
00163    <a class="code" href="group__Event.html#ga5">SetSpoilingFlag</a>(entre,<a class="code" href="event_8h.html#a1">INACTIVE</a>); <span class="comment">/* No XY Spoiling after acquisition for true fisp*/</span>
00164    <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,<a class="code" href="experience_8h.html#a0">ATT_INIT</a>); <span class="comment">/* To get an initial magnetisation M0 */</span>
00165 
00166    altphase=-1;<span class="comment">/* Phase alternance at each acquisition */</span>
00167    phase = 1;
00168   <span class="comment">/* Iterated excitations to get an equilibrium state */</span>
00169   <span class="keywordflow">for</span> (i = 0; i&lt;10*ntx; i++)
00170     {
00171      <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta * phase,timp);
00172      <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,tr);
00173      phase= phase * altphase;
00174     }
00175   <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(expr);
00176   <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta * phase,timp);
00177   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,twait); 
00178   <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tgrad,-gx,0.0,0.0);
00179   <a class="code" href="group__Event.html#ga0">DoAcqFrequenceX</a>(expr,entre, +gx, npy, npz,acq_delay, phase);
00180   
00181   printf(<span class="stringliteral">"Ending SeqTrueFisp1D \n"</span>);  
00182 }
00183 
<a name="l00192"></a><a class="code" href="group__Sequence.html#ga28">00192</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga28">SeqTrueFisp2D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00193 {
00194   <span class="keywordtype">int</span>      ntx,nty, phase, altphase;
00195   <span class="keywordtype">double</span>   fovx,fovy;
00196   <span class="keywordtype">double</span>   tr,tacq,timp,acq_delay,tgrad,twait; <span class="comment">/* ms */</span>
00197   <span class="keywordtype">double</span>   gx,gy,gz,gpy;
00198   <span class="keywordtype">double</span>   teta;     <span class="comment">/* degree */</span>
00199   <span class="keywordtype">int</span>    npy, npz;
00200   <a class="code" href="struct__Event.html">EVENT</a>* entre, entre_r;
00201   entre = &amp;entre_r;
00202 
00203   printf(<span class="stringliteral">"Starting SeqTrueFisp2D \n"</span>);  
00204   ntx = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00205   nty = expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
00206   tacq = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a>*1.e+3;
00207   fovx = expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>;
00208   fovy = expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a>;
00209 
00210   tr = seqparam-&gt;tr;
00211   teta = seqparam-&gt;teta;
00212   
00213   timp=0.3; <span class="comment">/*RF pulse duration in ms */</span>   
00214   acq_delay = 0;
00215   tgrad=(tacq)/2.;
00216   twait=(tr-2*tgrad-tacq)/2;
00217    
00218   <a class="code" href="group__Sequence.html#ga0">CheckTimesTF</a>(tacq,tr,twait);
00219    
00220   gx=(ntx-1.)/tacq/<a class="code" href="simri3d_8h.html#a3">G_kHz_G</a>/fovx;     
00221   gy=2*M_PI*(nty-1)/<a class="code" href="simri3d_8h.html#a4">G_rad_G</a>/fovy/(tgrad/1000);
00222   gz=0.0;
00223   npz=0;
00224 
00225   <a class="code" href="group__Event.html#ga5">SetSpoilingFlag</a>(entre,<a class="code" href="event_8h.html#a1">INACTIVE</a>); <span class="comment">/* No XY Spoiling after acquisition for true fisp*/</span>
00226   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,<a class="code" href="experience_8h.html#a0">ATT_INIT</a>); <span class="comment">/* To get an initial magnetisation M0 */</span>
00227 
00228   altphase=-1; <span class="comment">/* Phase alternance at each acquisition */</span>
00229   phase = 1;
00230   
00231   <span class="comment">/* Iterated excitations to get an equilibrium state */</span>
00232   <span class="keywordflow">for</span> (npy = 0; npy &lt; 10 * expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; npy++)
00233     {
00234      <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta * phase,timp);
00235      <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,tr);
00236      phase= phase * altphase;
00237     }
00238    
00239   <span class="keywordflow">for</span> (npy = 0; npy &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; npy++)
00240     {
00241       <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(expr);
00242       <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta * phase,timp);
00243       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,twait); 
00244        gpy = (gy) * (npy - nty / 2.) / nty;  
00245       <span class="comment">// Simultaneous application of the negative gradient before reading (-gx) and the phase gradients gpy</span>
00246        <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tgrad,-gx,-gpy,0.0);
00247        <a class="code" href="group__Event.html#ga0">DoAcqFrequenceX</a>(expr,entre, +gx, npy, npz,acq_delay, phase);
00248        <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tgrad,-gx,+gpy,0.0);
00249       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,twait); 
00250       phase= phase * altphase;
00251     }
00252   printf(<span class="stringliteral">"Ending SeqTrueFisp2D\n"</span>);  
00253 }
00254 
<a name="l00263"></a><a class="code" href="group__Sequence.html#ga29">00263</a> <span class="keywordtype">void</span> <a class="code" href="group__Sequence.html#ga29">SeqTrueFisp3D_0</a>(SEQPARAM *seqparam,<a class="code" href="struct__Experience3D.html">EXPERIENCE3D</a>* expr)
00264 {
00265   <span class="keywordtype">int</span>      ntx,nty,ntz, phase, altphase;
00266   <span class="keywordtype">double</span>   fovx,fovy,fovz;
00267   <span class="keywordtype">double</span>   tr,tacq,timp,acq_delay,tgrad,twait; <span class="comment">/* ms */</span>
00268   <span class="keywordtype">double</span>   gx,gy,gz,gpy,gpz;
00269   <span class="keywordtype">double</span>   teta;     <span class="comment">/* degree */</span>
00270   <span class="keywordtype">int</span>    npy,npz;
00271   <a class="code" href="struct__Event.html">EVENT</a>* entre, entre_r;
00272   entre = &amp;entre_r;
00273 
00274   printf(<span class="stringliteral">"Starting SeqTrueFisp3D \n"</span>);  
00275   ntx = expr-&gt;<a class="code" href="struct__Experience3D.html#o1">ntx</a>;
00276   nty = expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>;
00277   ntz = expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>;
00278   tacq = expr-&gt;<a class="code" href="struct__Experience3D.html#o4">readout_time</a>*1.e+3;
00279   fovx = expr-&gt;<a class="code" href="struct__Experience3D.html#o11">fovx</a>;
00280   fovy = expr-&gt;<a class="code" href="struct__Experience3D.html#o12">fovy</a>;
00281   fovz = expr-&gt;<a class="code" href="struct__Experience3D.html#o13">fovz</a>;
00282 
00283   tr = seqparam-&gt;tr;
00284   teta = seqparam-&gt;teta;
00285   
00286   timp=0.3;<span class="comment">/*RF pulse duration in ms */</span>   
00287   acq_delay = 0;
00288   tgrad=(tacq)/2.;
00289   twait=(tr-2*tgrad-tacq)/2;
00290    
00291   <a class="code" href="group__Sequence.html#ga0">CheckTimesTF</a>(tacq,tr,twait);
00292    
00293   gx=(ntx-1.)/tacq/<a class="code" href="simri3d_8h.html#a3">G_kHz_G</a>/fovx;     
00294   gy=2*M_PI*(nty-1)/<a class="code" href="simri3d_8h.html#a4">G_rad_G</a>/fovy/(tgrad/1000);
00295   gz=2*M_PI*(ntz-1)/<a class="code" href="simri3d_8h.html#a4">G_rad_G</a>/fovz/(tgrad/1000);
00296 
00297   <a class="code" href="group__Event.html#ga5">SetSpoilingFlag</a>(entre,<a class="code" href="event_8h.html#a1">INACTIVE</a>); <span class="comment">/* No XY Spoiling after acquisition for true fisp*/</span>
00298   <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,<a class="code" href="experience_8h.html#a0">ATT_INIT</a>); <span class="comment">/* To get an initial magnetisation M0 */</span>
00299 
00300   altphase=-1; <span class="comment">/* Phase alternance at each acquisition */</span>
00301   phase = 1;
00302   
00303   <span class="comment">/* Iterated excitations to get an equilibrium state */</span>
00304   <span class="keywordflow">for</span> (npy = 0; npy &lt; 10 * expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; npy++)
00305     {
00306      <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta * phase,timp);
00307      <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,tr);
00308      phase= phase * altphase;
00309     }
00310    
00311   <span class="keywordflow">for</span> (npy = 0; npy &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o2">nty</a>; npy++) {
00312   <span class="keywordflow">for</span> (npz = 0; npz &lt; expr-&gt;<a class="code" href="struct__Experience3D.html#o3">ntz</a>; npz++)
00313     {
00314       <a class="code" href="group__Experience.html#ga9">ResetToExperience</a>(expr);
00315       <a class="code" href="group__Event.html#ga0">DoPulseRect</a>(expr,entre,teta * phase,timp);
00316       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,twait); 
00317        gpy = (gy) * (npy - nty / 2.) / nty;  
00318       gpz = (gz) * (npz - ntz / 2.) / ntz;  
00319       <span class="comment">// Simultaneous application of the negative gradient before reading (-gx) and the phase gradients gpy,gpz</span>
00320        <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tgrad,-gx,-gpy,-gpz);
00321        <a class="code" href="group__Event.html#ga0">DoAcqFrequenceX</a>(expr,entre, +gx, npy, npz,acq_delay, phase);
00322        <a class="code" href="group__Event.html#ga0">DoGradient</a>( expr,entre,tgrad,-gx,+gpy,+gpz);
00323       <a class="code" href="group__Event.html#ga1">DoWaiting</a>(expr,entre,twait); 
00324       phase= phase * altphase;
00325     }}
00326   printf(<span class="stringliteral">"Ending SeqTrueFisp3D\n"</span>);  
00327 }
00328 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 20 14:28:15 2006 for SIMRI3D by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
